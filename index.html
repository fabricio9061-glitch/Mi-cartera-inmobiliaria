<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Cartera Inmobiliaria</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root {
      --primary: #1a1a2e;
      --primary-light: #16213e;
      --secondary: #0f3460;
      --accent: #e94560;
      --accent-hover: #d63d56;
      --gold: #c9a227;
      --white: #ffffff;
      --off-white: #f8f9fa;
      --gray-100: #f1f3f5;
      --gray-200: #e9ecef;
      --gray-300: #dee2e6;
      --gray-400: #ced4da;
      --gray-500: #adb5bd;
      --gray-600: #868e96;
      --gray-700: #495057;
      --success: #2ecc71;
      --danger: #e74c3c;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.16);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 50px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'DM Sans', sans-serif; background: var(--off-white); color: var(--gray-700); line-height: 1.6; }
    h1, h2, h3 { font-family: 'Playfair Display', serif; color: var(--primary); }
    a { text-decoration: none; color: inherit; }
    button { cursor: pointer; font-family: inherit; border: none; }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    .hidden { display: none !important; }

    .header { background: var(--white); box-shadow: var(--shadow-sm); position: sticky; top: 0; z-index: 100; }
    .header-content { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; }
    .logo { display: flex; align-items: center; gap: 12px; font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 700; color: var(--primary); cursor: pointer; }
    .logo i { color: var(--accent); font-size: 28px; }
    .nav { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .nav a, .nav button { padding: 10px 20px; border-radius: var(--radius-md); font-weight: 500; transition: all 0.3s; background: none; font-size: 14px; }
    .nav a:hover { background: var(--gray-100); }
    .btn-primary { background: var(--accent) !important; color: var(--white) !important; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); background: var(--accent-hover) !important; }
    .btn-secondary { background: transparent !important; color: var(--accent) !important; border: 2px solid var(--accent) !important; }
    .btn-secondary:hover { background: var(--accent) !important; color: var(--white) !important; }
    .user-info { display: flex; align-items: center; gap: 12px; padding: 8px 16px; background: var(--gray-100); border-radius: var(--radius-full); cursor: pointer; transition: all 0.3s; }
    .user-info:hover { background: var(--gray-200); }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--gold)); display: flex; align-items: center; justify-content: center; overflow: hidden; color: var(--white); font-weight: 600; }
    .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .admin-badge { background: var(--gold); color: var(--white); padding: 4px 10px; border-radius: var(--radius-full); font-size: 11px; font-weight: 600; }
    .logout-btn { background: var(--gray-200) !important; color: var(--gray-700) !important; }
    .logout-btn:hover { background: var(--gray-300) !important; }

    /* Notification Bell */
    .notification-bell { position: relative; width: 44px; height: 44px; border-radius: 50%; background: var(--gray-100); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; }
    .notification-bell:hover { background: var(--gray-200); transform: scale(1.05); }
    .notification-bell i { font-size: 20px; color: var(--gray-600); }
    .notification-badge { position: absolute; top: -2px; right: -2px; min-width: 20px; height: 20px; background: var(--accent); color: var(--white); font-size: 11px; font-weight: 700; border-radius: 50%; display: flex; align-items: center; justify-content: center; padding: 0 5px; border: 2px solid var(--white); }
    .notification-dropdown { position: absolute; top: 100%; right: 0; width: 360px; max-height: 450px; background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); margin-top: 8px; overflow: hidden; display: none; z-index: 1000; }
    .notification-dropdown.active { display: block; }
    .notification-header { display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid var(--gray-100); }
    .notification-header h3 { font-size: 16px; font-family: 'DM Sans', sans-serif; }
    .notification-header button { background: none; color: var(--accent); font-size: 13px; font-weight: 500; }
    .notification-list { max-height: 350px; overflow-y: auto; }
    .notification-item { display: flex; gap: 12px; padding: 14px 16px; border-bottom: 1px solid var(--gray-50); transition: background 0.2s; cursor: pointer; }
    .notification-item:hover { background: var(--gray-50); }
    .notification-item.unread { background: rgba(233, 69, 96, 0.05); }
    .notification-item.unread::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 4px; height: 60%; background: var(--accent); border-radius: 0 4px 4px 0; }
    .notification-avatar { width: 44px; height: 44px; border-radius: 50%; background: var(--gray-200); display: flex; align-items: center; justify-content: center; flex-shrink: 0; overflow: hidden; }
    .notification-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .notification-content { flex: 1; min-width: 0; }
    .notification-content p { font-size: 14px; color: var(--gray-700); margin-bottom: 4px; }
    .notification-content p strong { color: var(--primary); }
    .notification-content small { color: var(--gray-500); font-size: 12px; }
    .notification-contact { display: flex; align-items: center; gap: 6px; margin-top: 6px; padding: 6px 10px; background: var(--gray-100); border-radius: var(--radius-sm); font-size: 12px; color: var(--gray-600); }
    .notification-contact i { color: #25D366; }
    .notification-contact a { color: #25D366; font-weight: 600; }
    .notification-empty { text-align: center; padding: 40px 20px; color: var(--gray-400); }
    .notification-empty i { font-size: 40px; margin-bottom: 12px; }

    .btn-new-property {
      display: inline-flex; align-items: center; gap: 12px; padding: 14px 28px;
      background: linear-gradient(135deg, var(--accent) 0%, #ff6b8a 50%, var(--gold) 100%);
      background-size: 200% 200%; color: var(--white); font-size: 15px; font-weight: 600;
      border-radius: var(--radius-full); box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden;
    }
    .btn-new-property::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); transition: left 0.5s; }
    .btn-new-property:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 8px 25px rgba(233, 69, 96, 0.5); background-position: 100% 0; }
    .btn-new-property:hover::before { left: 100%; }
    .btn-new-property i { font-size: 18px; transition: transform 0.3s; }
    .btn-new-property:hover i { transform: rotate(90deg); }

    .hero { background: linear-gradient(135deg, var(--primary), var(--secondary)); padding: 80px 0; text-align: center; color: var(--white); }
    .hero h1 { font-size: 48px; margin-bottom: 16px; color: var(--white); }
    .hero h1 span { color: var(--gold); }
    .hero p { font-size: 18px; opacity: 0.9; max-width: 600px; margin: 0 auto 32px; }
    .hero-stats { display: flex; justify-content: center; gap: 48px; margin-top: 40px; }
    .hero-stat { text-align: center; }
    .hero-stat-number { font-size: 36px; font-weight: 700; font-family: 'Playfair Display', serif; }
    .hero-stat-label { font-size: 14px; opacity: 0.8; }
    .hero-buttons { display: flex; gap: 16px; justify-content: center; margin-bottom: 40px; flex-wrap: wrap; }
    .hero-btn { padding: 16px 32px; border-radius: var(--radius-lg); font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 10px; transition: all 0.3s; }
    .hero-btn-primary { background: var(--gold); color: var(--primary); }
    .hero-btn-primary:hover { background: #d4ad2b; transform: translateY(-3px); }
    .hero-btn-secondary { background: rgba(255,255,255,0.15); color: var(--white); border: 2px solid var(--white); }
    .hero-btn-secondary:hover { background: var(--white); color: var(--primary); }

    .filters { background: var(--white); padding: 24px; border-radius: var(--radius-xl); box-shadow: var(--shadow-md); margin: -40px auto 40px; max-width: 1000px; position: relative; z-index: 10; }
    .filters-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 16px; align-items: end; }
    .filter-group label { display: block; font-size: 12px; font-weight: 600; color: var(--gray-600); margin-bottom: 6px; text-transform: uppercase; }
    .filter-group input, .filter-group select { width: 100%; padding: 12px 16px; border: 2px solid var(--gray-200); border-radius: var(--radius-md); font-size: 14px; transition: all 0.3s; }
    .filter-group input:focus, .filter-group select:focus { border-color: var(--accent); outline: none; }
    .filter-btn { padding: 12px 28px; background: var(--accent); color: var(--white); border-radius: var(--radius-md); font-weight: 600; transition: all 0.3s; }
    .filter-btn:hover { background: var(--accent-hover); }

    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; flex-wrap: wrap; gap: 16px; }
    .section-title { font-size: 32px; margin-bottom: 0; }
    .section-subtitle { color: var(--gray-500); margin-top: 4px; }

    .properties-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 28px; margin-bottom: 60px; }

    .property-card { background: var(--white); border-radius: var(--radius-xl); overflow: hidden; box-shadow: var(--shadow-sm); transition: all 0.3s; cursor: pointer; position: relative; }
    .property-card:hover { transform: translateY(-8px); box-shadow: var(--shadow-lg); }
    .card-image { position: relative; height: 220px; overflow: hidden; }
    .card-image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
    .property-card:hover .card-image img { transform: scale(1.05); }
    .card-badges { position: absolute; top: 16px; left: 16px; display: flex; gap: 8px; flex-wrap: wrap; }
    .badge { padding: 6px 14px; border-radius: var(--radius-full); font-size: 11px; font-weight: 700; text-transform: uppercase; }
    .badge-sale { background: linear-gradient(135deg, var(--accent), #ff6b6b); color: var(--white); }
    .badge-rent { background: linear-gradient(135deg, #3498db, #2ecc71); color: var(--white); }
    .badge-ph { background: var(--gold); color: var(--white); }
    .badge-currency { background: var(--primary); color: var(--white); }
    .badge-garage { background: #6c5ce7; color: var(--white); }
    .card-actions { position: absolute; top: 16px; right: 16px; display: flex; gap: 8px; opacity: 0; transition: opacity 0.3s; }
    .property-card:hover .card-actions { opacity: 1; }
    .card-action-btn { width: 36px; height: 36px; border-radius: 50%; background: var(--white); color: var(--gray-700); display: flex; align-items: center; justify-content: center; font-size: 14px; transition: all 0.3s; box-shadow: var(--shadow-sm); }
    .card-action-btn:hover { transform: scale(1.1); }
    .card-action-btn.edit:hover { background: #3498db; color: white; }
    .card-action-btn.delete:hover { background: var(--danger); color: white; }
    .card-owner { position: absolute; bottom: 12px; left: 12px; display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); border-radius: var(--radius-full); color: var(--white); font-size: 12px; cursor: pointer; transition: all 0.3s; }
    .card-owner:hover { background: rgba(0,0,0,0.8); }
    .card-owner img { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; }
    .card-owner-initial { width: 24px; height: 24px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--gold)); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 11px; }
    .card-content { padding: 20px; }
    .card-price { font-family: 'Playfair Display', serif; font-size: 26px; font-weight: 700; color: var(--accent); margin-bottom: 8px; }
    .card-price span { font-size: 14px; color: var(--gray-500); font-weight: 400; }
    .card-title { font-size: 18px; font-weight: 600; color: var(--primary); margin-bottom: 8px; }
    .card-location { display: flex; align-items: center; gap: 6px; color: var(--gray-500); font-size: 14px; margin-bottom: 16px; }
    .card-location i { color: var(--accent); }
    .card-features { display: flex; gap: 16px; padding-top: 16px; border-top: 1px solid var(--gray-100); flex-wrap: wrap; }
    .card-feature { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--gray-600); }
    .card-feature i { color: var(--gray-400); }
    .card-footer { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; background: var(--gray-50); border-top: 1px solid var(--gray-100); }
    .card-views { font-size: 13px; color: var(--gray-500); }
    .btn-whatsapp { display: flex; align-items: center; gap: 8px; padding: 10px 18px; background: #25D366; color: var(--white); border-radius: var(--radius-md); font-size: 13px; font-weight: 600; transition: all 0.3s; }
    .btn-whatsapp:hover { background: #128C7E; transform: scale(1.05); }

    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
    .modal.active { display: flex; }
    .modal-content { background: var(--white); border-radius: var(--radius-xl); max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; animation: slideIn 0.3s ease; margin: auto; }
    @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 24px; border-bottom: 1px solid var(--gray-100); }
    .modal-header h2 { font-size: 24px; }
    .modal-close { width: 40px; height: 40px; border-radius: 50%; background: var(--gray-100); display: flex; align-items: center; justify-content: center; font-size: 18px; color: var(--gray-600); transition: all 0.3s; }
    .modal-close:hover { background: var(--gray-200); }
    .modal-body { padding: 24px; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--gray-700); }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 14px 16px; border: 2px solid var(--gray-200); border-radius: var(--radius-md); font-size: 15px; transition: all 0.3s; font-family: inherit; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--accent); outline: none; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-row-3 { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }
    .form-error { background: rgba(231,76,60,0.1); color: var(--danger); padding: 12px 16px; border-radius: var(--radius-md); margin-bottom: 20px; font-size: 14px; }
    .form-success { background: rgba(46,204,113,0.1); color: var(--success); padding: 12px 16px; border-radius: var(--radius-md); margin-bottom: 20px; font-size: 14px; }
    .btn-submit { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--accent), var(--gold)); color: var(--white); border-radius: var(--radius-md); font-size: 16px; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-submit:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .btn-submit:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--gray-100); text-align: center; color: var(--gray-500); font-size: 14px; }
    .modal-footer a { color: var(--accent); font-weight: 600; cursor: pointer; }

    .checkbox-group { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
    .checkbox-group input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--accent); cursor: pointer; }
    .checkbox-group label { font-weight: 500; color: var(--gray-600); cursor: pointer; margin-bottom: 0; }

    .image-upload-area { border: 2px dashed var(--gray-300); border-radius: var(--radius-lg); padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s; background: var(--gray-50); }
    .image-upload-area:hover { border-color: var(--accent); background: rgba(233, 69, 96, 0.05); }
    .image-upload-area.dragover { border-color: var(--accent); background: rgba(233, 69, 96, 0.1); }
    .image-upload-area i { font-size: 48px; color: var(--gray-400); margin-bottom: 16px; }
    .image-upload-area p { color: var(--gray-600); margin-bottom: 8px; }
    .image-upload-area small { color: var(--gray-400); }
    .image-preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 12px; margin-top: 16px; }
    .image-preview-item { position: relative; aspect-ratio: 1; border-radius: var(--radius-md); overflow: hidden; box-shadow: var(--shadow-sm); cursor: grab; transition: all 0.2s; border: 2px solid transparent; }
    .image-preview-item:hover { border-color: var(--accent); }
    .image-preview-item.dragging { opacity: 0.5; }
    .image-preview-item.drag-over { border-color: var(--gold); }
    .image-preview-item img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
    .image-preview-item .remove-image { position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; background: var(--danger); color: var(--white); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; opacity: 0; transition: all 0.3s; }
    .image-preview-item:hover .remove-image { opacity: 1; }
    .image-preview-item.main::after { content: 'Principal'; position: absolute; bottom: 0; left: 0; right: 0; background: var(--gold); color: var(--white); font-size: 9px; padding: 3px; text-align: center; font-weight: 600; }
    .image-preview-item .drag-handle { position: absolute; top: 4px; left: 4px; width: 24px; height: 24px; background: rgba(0,0,0,0.5); color: var(--white); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; opacity: 0; transition: all 0.3s; }
    .image-preview-item:hover .drag-handle { opacity: 1; }

    .profile-header { background: linear-gradient(135deg, var(--primary), var(--secondary)); padding: 60px 0; color: var(--white); margin-bottom: 40px; }
    .profile-header-content { display: flex; align-items: center; gap: 32px; }
    .profile-avatar-container { position: relative; }
    .profile-avatar { width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--gold)); display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: 700; color: var(--white); border: 4px solid rgba(255,255,255,0.3); overflow: hidden; flex-shrink: 0; }
    .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .profile-avatar-edit { position: absolute; bottom: 0; right: 0; width: 40px; height: 40px; border-radius: 50%; background: var(--accent); color: var(--white); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; border: 3px solid var(--white); }
    .profile-avatar-edit:hover { transform: scale(1.1); background: var(--accent-hover); }
    .profile-info h1 { color: var(--white); margin-bottom: 8px; }
    .profile-info p { opacity: 0.8; margin-bottom: 16px; }
    .profile-stats { display: flex; gap: 32px; }
    .profile-stat { text-align: center; }
    .profile-stat-number { font-size: 28px; font-weight: 700; font-family: 'Playfair Display', serif; }
    .profile-stat-label { font-size: 13px; opacity: 0.7; }
    .profile-share { display: flex; gap: 12px; margin-top: 16px; flex-wrap: wrap; }
    .btn-share { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: rgba(255,255,255,0.2); color: var(--white); border-radius: var(--radius-full); font-size: 14px; font-weight: 500; transition: all 0.3s; }
    .btn-share:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }
    .btn-share-whatsapp { background: #25D366; }
    .btn-share-whatsapp:hover { background: #128C7E; }
    .btn-share-facebook { background: #1877F2; }
    .btn-share-facebook:hover { background: #166FE5; }
    .btn-share-twitter { background: #1DA1F2; }
    .btn-share-twitter:hover { background: #1A91DA; }

    .detail-modal .modal-content { max-width: 800px; }
    .detail-gallery { position: relative; height: 400px; background: var(--gray-100); }
    .detail-gallery img { width: 100%; height: 100%; object-fit: cover; }
    .detail-nav { position: absolute; top: 50%; transform: translateY(-50%); width: 50px; height: 50px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; color: var(--primary); transition: all 0.3s; }
    .detail-nav:hover { background: var(--white); transform: translateY(-50%) scale(1.1); }
    .detail-nav.prev { left: 16px; }
    .detail-nav.next { right: 16px; }
    .detail-thumbnails { display: flex; gap: 8px; padding: 12px; overflow-x: auto; background: var(--gray-100); }
    .detail-thumb { width: 60px; height: 60px; border-radius: var(--radius-sm); overflow: hidden; cursor: pointer; opacity: 0.6; transition: all 0.3s; flex-shrink: 0; border: 2px solid transparent; }
    .detail-thumb.active, .detail-thumb:hover { opacity: 1; border-color: var(--accent); }
    .detail-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .detail-content { padding: 32px; }
    .detail-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
    .detail-price { font-family: 'Playfair Display', serif; font-size: 36px; font-weight: 700; color: var(--accent); }
    .detail-owner { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--gray-50); border-radius: var(--radius-lg); cursor: pointer; transition: all 0.3s; margin-bottom: 24px; }
    .detail-owner:hover { background: var(--gray-100); }
    .detail-owner-avatar { width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--gold)); display: flex; align-items: center; justify-content: center; color: var(--white); font-weight: 600; overflow: hidden; }
    .detail-owner-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .detail-owner-info small { color: var(--gray-500); }
    .detail-features { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
    .detail-feature { padding: 16px; background: var(--gray-50); border-radius: var(--radius-md); text-align: center; }
    .detail-feature i { font-size: 24px; color: var(--accent); margin-bottom: 8px; display: block; }
    .detail-feature strong { display: block; font-size: 18px; color: var(--primary); }
    .detail-feature span { font-size: 12px; color: var(--gray-500); }
    .detail-description { margin-bottom: 24px; color: var(--gray-600); line-height: 1.8; }
    .detail-actions { display: flex; gap: 12px; margin-bottom: 24px; }
    .detail-whatsapp { flex: 1; padding: 16px; background: #25D366; color: var(--white); border-radius: var(--radius-md); font-size: 16px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.3s; }
    .detail-whatsapp:hover { background: #128C7E; }
    .detail-edit-btn { padding: 16px 24px; background: #3498db; color: var(--white); border-radius: var(--radius-md); font-size: 16px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.3s; }
    .detail-edit-btn:hover { background: #2980b9; }

    .comments-section { border-top: 1px solid var(--gray-200); padding-top: 24px; margin-top: 24px; }
    .comments-section h3 { margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
    .comment-form { display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px; }
    .comment-form-row { display: flex; gap: 12px; }
    .comment-form input { flex: 1; padding: 12px 16px; border: 2px solid var(--gray-200); border-radius: var(--radius-full); font-size: 14px; }
    .comment-form input:focus { border-color: var(--accent); outline: none; }
    .comment-form button { padding: 12px 24px; background: var(--accent); color: var(--white); border-radius: var(--radius-full); font-weight: 600; transition: all 0.3s; white-space: nowrap; }
    .comment-form button:hover { background: var(--accent-hover); }
    .comment-form small { color: var(--gray-500); font-size: 12px; display: flex; align-items: center; gap: 6px; }
    .comment-form small i { color: var(--gold); }
    .comment-item { display: flex; gap: 12px; padding: 16px 0; border-bottom: 1px solid var(--gray-100); position: relative; }
    .comment-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--gray-200); display: flex; align-items: center; justify-content: center; color: var(--gray-500); font-weight: 600; overflow: hidden; flex-shrink: 0; }
    .comment-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .comment-content { flex: 1; }
    .comment-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; flex-wrap: wrap; }
    .comment-author { font-weight: 600; color: var(--primary); }
    .comment-guest-badge { font-size: 10px; padding: 2px 8px; background: var(--gray-200); border-radius: var(--radius-full); color: var(--gray-600); }
    .comment-time { font-size: 12px; color: var(--gray-400); }
    .comment-text { color: var(--gray-600); }
    .comment-contact { display: flex; align-items: center; gap: 6px; margin-top: 8px; padding: 8px 12px; background: rgba(37, 211, 102, 0.1); border-radius: var(--radius-md); font-size: 13px; }
    .comment-contact i { color: #25D366; }
    .comment-contact a { color: #25D366; font-weight: 600; }
    .no-comments { text-align: center; padding: 30px; color: var(--gray-400); }

    .admin-panel { padding: 40px 0; }
    .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; flex-wrap: wrap; gap: 16px; }
    .admin-tabs { display: flex; gap: 8px; margin-bottom: 24px; background: var(--white); padding: 8px; border-radius: var(--radius-lg); flex-wrap: wrap; }
    .admin-tab { padding: 12px 24px; border-radius: var(--radius-md); font-weight: 500; background: none; color: var(--gray-600); transition: all 0.3s; }
    .admin-tab.active { background: var(--primary); color: var(--white); }
    .admin-tab:hover:not(.active) { background: var(--gray-100); }
    .admin-content { background: var(--white); border-radius: var(--radius-xl); padding: 24px; box-shadow: var(--shadow-md); }
    .user-card { display: flex; align-items: center; gap: 20px; padding: 20px; background: var(--gray-50); border-radius: var(--radius-lg); margin-bottom: 16px; flex-wrap: wrap; }
    .user-card-avatar { width: 60px; height: 60px; border-radius: 50%; background: var(--gray-200); display: flex; align-items: center; justify-content: center; overflow: hidden; font-size: 24px; color: var(--gray-400); flex-shrink: 0; }
    .user-card-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .user-card-info { flex: 1; min-width: 200px; }
    .user-card-info h4 { margin-bottom: 4px; }
    .user-card-info p { color: var(--gray-600); font-size: 14px; }
    .user-card-info small { color: var(--gray-400); font-size: 12px; }
    .user-card-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn-approve { padding: 10px 18px; background: rgba(46,204,113,0.1); color: var(--success); border-radius: var(--radius-md); font-weight: 500; transition: all 0.3s; }
    .btn-approve:hover { background: var(--success); color: var(--white); }
    .btn-reject { padding: 10px 18px; background: rgba(231,76,60,0.1); color: var(--danger); border-radius: var(--radius-md); font-weight: 500; transition: all 0.3s; }
    .btn-reject:hover { background: var(--danger); color: var(--white); }
    .btn-edit { padding: 10px 18px; background: rgba(52,152,219,0.1); color: #3498db; border-radius: var(--radius-md); font-weight: 500; transition: all 0.3s; }
    .btn-edit:hover { background: #3498db; color: var(--white); }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--gray-400); }
    .empty-state i { font-size: 48px; margin-bottom: 16px; }
    .empty-state h3 { color: var(--gray-600); margin-bottom: 8px; }

    .footer { background: var(--primary); color: var(--white); padding: 40px 0 20px; margin-top: 60px; }
    .footer-content { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .footer-logo { font-family: 'Playfair Display', serif; font-size: 20px; }
    .footer-links { display: flex; gap: 24px; }
    .footer-links a { color: rgba(255,255,255,0.7); transition: color 0.3s; }
    .footer-links a:hover { color: var(--gold); }
    .footer-bottom { text-align: center; padding-top: 20px; color: rgba(255,255,255,0.5); font-size: 14px; }

    .loading { display: flex; justify-content: center; padding: 60px; }
    .spinner { width: 40px; height: 40px; border: 3px solid var(--gray-200); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 968px) {
      .detail-features { grid-template-columns: repeat(2, 1fr); }
      .profile-header-content { flex-direction: column; text-align: center; }
      .profile-stats { justify-content: center; }
      .profile-share { justify-content: center; }
      .notification-dropdown { width: 320px; right: -100px; }
    }
    @media (max-width: 768px) {
      .header-content { flex-wrap: wrap; gap: 16px; }
      .nav { width: 100%; justify-content: center; flex-wrap: wrap; }
      .nav a, .nav button { padding: 8px 12px; font-size: 13px; }
      .hero h1 { font-size: 28px; }
      .hero p { font-size: 16px; padding: 0 10px; }
      .hero-buttons { padding: 0 20px; }
      .hero-btn { padding: 14px 24px; font-size: 16px; width: 100%; justify-content: center; }
      .hero-stats { flex-wrap: wrap; gap: 24px; }
      .filters-row { grid-template-columns: 1fr; }
      .properties-grid { grid-template-columns: 1fr; }
      .form-row, .form-row-3 { grid-template-columns: 1fr; }
      .section-header { flex-direction: column; align-items: stretch; }
      .btn-new-property { width: 100%; justify-content: center; }
      .footer-content { flex-direction: column; gap: 20px; text-align: center; }
      .user-info span:not(.admin-badge) { display: none; }
      .detail-gallery { height: 280px; }
      .detail-header { flex-direction: column; }
      .detail-actions { flex-direction: column; }
      .profile-avatar { width: 100px; height: 100px; font-size: 36px; }
      .comment-form-row { flex-direction: column; }
      .notification-dropdown { width: 100vw; right: -60px; border-radius: 0 0 var(--radius-lg) var(--radius-lg); }
    }
  </style>
</head>
<body>

  <header class="header">
    <div class="container">
      <div class="header-content">
        <div class="logo" onclick="showHome()"><i class="fas fa-building"></i>Mi Cartera Inmobiliaria</div>
        <nav class="nav" id="nav-guest">
          <a href="#" onclick="showHome()">Inicio</a>
          <a href="#propiedades">Propiedades</a>
          <button class="btn-secondary" onclick="openModal('registerModal')">Registrarse</button>
          <button class="btn-primary" onclick="openModal('loginModal')">Iniciar Sesión</button>
        </nav>
        <nav class="nav hidden" id="nav-user">
          <a href="#" onclick="showHome()">Inicio</a>
          <a href="#propiedades">Propiedades</a>
          <div class="notification-bell" onclick="toggleNotifications(event)">
            <i class="fas fa-bell"></i>
            <span class="notification-badge hidden" id="notificationBadge">0</span>
            <div class="notification-dropdown" id="notificationDropdown">
              <div class="notification-header">
                <h3>Consultas</h3>
                <button onclick="markAllAsRead(event)">Marcar como leídas</button>
              </div>
              <div class="notification-list" id="notificationList">
                <div class="notification-empty">
                  <i class="fas fa-bell-slash"></i>
                  <p>No tienes consultas</p>
                </div>
              </div>
            </div>
          </div>
          <div class="user-info" onclick="showMyProfile()">
            <div class="user-avatar" id="userAvatar"><i class="fas fa-user"></i></div>
            <span id="userName">Usuario</span>
            <span class="admin-badge hidden" id="adminBadge">Admin</span>
          </div>
          <button class="btn-primary hidden" id="adminBtn" onclick="showAdmin()">Panel Admin</button>
          <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Salir</button>
        </nav>
      </div>
    </div>
  </header>

  <main id="mainContent">
    <section class="hero">
      <div class="container">
        <h1>Encuentra la propiedad<br><span>de tus sueños</span></h1>
        <p>Explora nuestra amplia selección de propiedades en venta y alquiler en Uruguay.</p>
        <div class="hero-buttons" id="heroButtons">
          <button class="hero-btn hero-btn-primary" onclick="openModal('registerModal')"><i class="fas fa-user-plus"></i> Crear Cuenta</button>
          <button class="hero-btn hero-btn-secondary" onclick="openModal('loginModal')"><i class="fas fa-sign-in-alt"></i> Iniciar Sesión</button>
        </div>
        <div class="hero-stats">
          <div class="hero-stat"><div class="hero-stat-number" id="statTotal">0</div><div class="hero-stat-label">Propiedades</div></div>
          <div class="hero-stat"><div class="hero-stat-number" id="statSale">0</div><div class="hero-stat-label">En Venta</div></div>
          <div class="hero-stat"><div class="hero-stat-number" id="statRent">0</div><div class="hero-stat-label">En Alquiler</div></div>
        </div>
      </div>
    </section>

    <section class="container">
      <div class="filters">
        <div class="filters-row">
          <div class="filter-group"><label>Buscar</label><input type="text" id="filterSearch" placeholder="Ubicación, nombre..."></div>
          <div class="filter-group"><label>Tipo</label><select id="filterType"><option value="">Todos</option><option value="sale">Venta</option><option value="rent">Alquiler</option></select></div>
          <div class="filter-group"><label>Habitaciones</label><select id="filterBedrooms"><option value="">Todas</option><option value="1">1+</option><option value="2">2+</option><option value="3">3+</option><option value="4">4+</option></select></div>
          <div class="filter-group"><label>Precio máx.</label><input type="number" id="filterPrice" placeholder="Precio"></div>
          <button class="filter-btn" onclick="filterProperties()"><i class="fas fa-search"></i> Buscar</button>
        </div>
      </div>
    </section>

    <section class="container" id="propiedades">
      <div class="section-header">
        <div><h2 class="section-title">Propiedades Disponibles</h2><p class="section-subtitle" id="propertiesCount">Cargando...</p></div>
        <button class="btn-new-property hidden" id="btnNewProperty" onclick="openPropertyModal()"><i class="fas fa-plus"></i><span>Nueva Propiedad</span></button>
      </div>
      <div id="propertiesLoading" class="loading"><div class="spinner"></div></div>
      <div class="properties-grid" id="propertiesGrid"></div>
    </section>
  </main>

  <main id="profilePage" class="hidden">
    <div class="profile-header">
      <div class="container">
        <div class="profile-header-content">
          <div class="profile-avatar-container">
            <div class="profile-avatar" id="profileAvatar">U</div>
            <div class="profile-avatar-edit hidden" id="profileAvatarEdit" onclick="document.getElementById('profilePhotoInput').click()">
              <i class="fas fa-camera"></i>
            </div>
            <input type="file" id="profilePhotoInput" accept="image/*" style="display: none;" onchange="handleProfilePhotoChange(event)">
          </div>
          <div class="profile-info">
            <h1 id="profileName">Usuario</h1>
            <p id="profileEmail">email@ejemplo.com</p>
            <div class="profile-stats">
              <div class="profile-stat"><div class="profile-stat-number" id="profilePropertiesCount">0</div><div class="profile-stat-label">Propiedades</div></div>
              <div class="profile-stat"><div class="profile-stat-number" id="profileViewsCount">0</div><div class="profile-stat-label">Vistas totales</div></div>
            </div>
            <div class="profile-share">
              <button class="btn-share" onclick="copyProfileLink()"><i class="fas fa-link"></i> Copiar enlace</button>
              <button class="btn-share btn-share-whatsapp" onclick="shareProfileWhatsapp()"><i class="fab fa-whatsapp"></i> WhatsApp</button>
              <button class="btn-share btn-share-facebook" onclick="shareProfileFacebook()"><i class="fab fa-facebook-f"></i> Facebook</button>
              <button class="btn-share btn-share-twitter" onclick="shareProfileTwitter()"><i class="fab fa-twitter"></i> Twitter</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="section-header">
        <div><h2 class="section-title">Propiedades de <span id="profileNameTitle">Usuario</span></h2><p class="section-subtitle" id="profilePropertiesSubtitle">0 propiedades</p></div>
        <button class="btn-new-property hidden" id="btnNewPropertyProfile" onclick="openPropertyModal()"><i class="fas fa-plus"></i><span>Nueva Propiedad</span></button>
      </div>
      <div class="properties-grid" id="profilePropertiesGrid"></div>
      <div style="text-align: center; margin-top: 20px;"><button class="btn-secondary" onclick="showHome()" style="padding: 12px 24px;"><i class="fas fa-arrow-left"></i> Volver al inicio</button></div>
    </div>
  </main>

  <main id="adminPanel" class="hidden">
    <section class="admin-panel container">
      <div class="admin-header">
        <div><h1>Panel de Administración</h1><p style="color: var(--gray-500);">Gestiona usuarios y propiedades</p></div>
        <button class="btn-new-property" onclick="openPropertyModal()"><i class="fas fa-plus"></i><span>Nueva Propiedad</span></button>
      </div>
      <div class="admin-tabs">
        <button class="admin-tab active" onclick="showAdminTab('pending')" id="tabPending"><i class="fas fa-clock"></i> Pendientes <span id="pendingCount"></span></button>
        <button class="admin-tab" onclick="showAdminTab('users')" id="tabUsers"><i class="fas fa-users"></i> Usuarios</button>
        <button class="admin-tab" onclick="showAdminTab('properties')" id="tabProperties"><i class="fas fa-building"></i> Propiedades</button>
      </div>
      <div class="admin-content" id="adminContent"></div>
      <button style="margin-top: 24px;" class="btn-secondary" onclick="showHome()"><i class="fas fa-arrow-left"></i> Volver</button>
    </section>
  </main>

  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-logo"><i class="fas fa-building"></i> Mi Cartera Inmobiliaria</div>
        <div class="footer-links"><a href="#"><i class="fab fa-facebook"></i></a><a href="#"><i class="fab fa-instagram"></i></a><a href="#"><i class="fab fa-whatsapp"></i></a></div>
      </div>
      <div class="footer-bottom">Página creada por Anibal Malave © 2026</div>
    </div>
  </footer>

  <!-- Login Modal -->
  <div class="modal" id="loginModal">
    <div class="modal-content">
      <div class="modal-header"><h2>Iniciar Sesión</h2><button class="modal-close" onclick="closeModal('loginModal')"><i class="fas fa-times"></i></button></div>
      <div class="modal-body">
        <div id="loginError" class="form-error hidden"></div>
        <form onsubmit="handleLogin(event)">
          <div class="form-group"><label>Correo Electrónico</label><input type="email" id="loginEmail" required placeholder="tu@email.com"></div>
          <div class="form-group"><label>Contraseña</label><input type="password" id="loginPassword" required placeholder="••••••••"></div>
          <div class="checkbox-group"><input type="checkbox" id="rememberMe"><label for="rememberMe">Recordar mi usuario</label></div>
          <button type="submit" class="btn-submit" id="loginBtn">Iniciar Sesión</button>
        </form>
      </div>
      <div class="modal-footer">¿No tienes cuenta? <a onclick="switchModal('loginModal', 'registerModal')">Regístrate aquí</a></div>
    </div>
  </div>

  <!-- Register Modal -->
  <div class="modal" id="registerModal">
    <div class="modal-content">
      <div class="modal-header"><h2>Crear Cuenta</h2><button class="modal-close" onclick="closeModal('registerModal')"><i class="fas fa-times"></i></button></div>
      <div class="modal-body">
        <div id="registerError" class="form-error hidden"></div>
        <div id="registerSuccess" class="form-success hidden"></div>
        <form onsubmit="handleRegister(event)" id="registerForm">
          <div class="form-group"><label>Nombre Completo *</label><input type="text" id="registerName" required placeholder="Tu nombre"></div>
          <div class="form-group"><label>Correo Electrónico *</label><input type="email" id="registerEmail" required placeholder="tu@email.com"></div>
          <div class="form-group"><label>WhatsApp *</label><input type="tel" id="registerWhatsapp" required placeholder="+598 99 123 456"></div>
          <div class="form-row">
            <div class="form-group"><label>Contraseña *</label><input type="password" id="registerPassword" required minlength="6" placeholder="Mínimo 6 caracteres"></div>
            <div class="form-group"><label>Confirmar *</label><input type="password" id="registerConfirm" required placeholder="Repetir"></div>
          </div>
          <p style="font-size: 13px; color: var(--gray-500); margin-bottom: 20px; padding: 12px; background: rgba(201,162,39,0.1); border-radius: 8px;"><i class="fas fa-info-circle" style="color: var(--gold);"></i> Tu cuenta quedará <strong>pendiente</strong> hasta que el administrador la apruebe.</p>
          <button type="submit" class="btn-submit" id="registerBtn">Crear Cuenta</button>
        </form>
      </div>
      <div class="modal-footer">¿Ya tienes cuenta? <a onclick="switchModal('registerModal', 'loginModal')">Inicia sesión</a></div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="modal detail-modal" id="detailModal">
    <div class="modal-content">
      <div class="detail-gallery">
        <img id="detailImage" src="" alt="">
        <button class="detail-nav prev" onclick="prevDetailImage()"><i class="fas fa-chevron-left"></i></button>
        <button class="detail-nav next" onclick="nextDetailImage()"><i class="fas fa-chevron-right"></i></button>
        <div class="card-badges" id="detailBadges"></div>
      </div>
      <div class="detail-thumbnails" id="detailThumbnails"></div>
      <div class="detail-content">
        <div class="detail-header">
          <div><h2 id="detailTitle"></h2><p style="color: var(--gray-500);"><i class="fas fa-map-marker-alt" style="color: var(--accent);"></i> <span id="detailLocation"></span></p></div>
          <div class="detail-price" id="detailPrice"></div>
        </div>
        <div class="detail-owner" onclick="viewOwnerProfile()">
          <div class="detail-owner-avatar" id="detailOwnerAvatar">U</div>
          <div class="detail-owner-info"><strong id="detailOwnerName">Usuario</strong><small>Ver perfil</small></div>
        </div>
        <div class="detail-features" id="detailFeatures"></div>
        <p class="detail-description" id="detailDescription"></p>
        <div class="detail-actions">
          <button class="detail-whatsapp" id="detailWhatsapp"><i class="fab fa-whatsapp"></i> Contactar por WhatsApp</button>
          <button class="detail-edit-btn hidden" id="detailEditBtn" onclick="editCurrentProperty()"><i class="fas fa-edit"></i> Editar</button>
        </div>
        <div class="comments-section">
          <h3><i class="fas fa-comments"></i> Consultas</h3>
          <div class="comment-form" id="commentFormGuest">
            <div class="comment-form-row">
              <input type="text" id="guestName" placeholder="Tu nombre *">
              <input type="tel" id="guestPhone" placeholder="Tu WhatsApp *">
            </div>
            <small><i class="fas fa-lock"></i> Tu número solo será visible para el dueño de la propiedad</small>
            <div class="comment-form-row">
              <input type="text" id="commentInput" placeholder="Escribe tu consulta...">
              <button onclick="addComment()">Enviar</button>
            </div>
          </div>
          <div class="comment-form hidden" id="commentFormUser">
            <div class="comment-form-row">
              <input type="text" id="commentInputUser" placeholder="Escribe tu consulta...">
              <button onclick="addComment()">Enviar</button>
            </div>
          </div>
          <div id="commentsList"></div>
        </div>
      </div>
      <button class="modal-close" style="position: absolute; top: 16px; right: 16px; background: rgba(0,0,0,0.5); color: white;" onclick="closeModal('detailModal')"><i class="fas fa-times"></i></button>
    </div>
  </div>

  <!-- Property Modal -->
  <div class="modal" id="propertyModal">
    <div class="modal-content" style="max-width: 650px;">
      <div class="modal-header"><h2 id="propertyModalTitle">Nueva Propiedad</h2><button class="modal-close" onclick="closeModal('propertyModal')"><i class="fas fa-times"></i></button></div>
      <div class="modal-body">
        <div id="propertyError" class="form-error hidden"></div>
        <form onsubmit="handleSaveProperty(event)" id="propertyForm">
          <input type="hidden" id="editingPropertyId" value="">
          <div class="form-group"><label>Título *</label><input type="text" id="propTitle" required placeholder="Ej: Apartamento moderno"></div>
          <div class="form-row">
            <div class="form-group"><label>Departamento *</label><select id="propDepartamento" required onchange="updateCiudades()"><option value="">Seleccionar...</option></select></div>
            <div class="form-group"><label>Ciudad/Barrio *</label><select id="propCiudad" required><option value="">Primero selecciona departamento</option></select></div>
          </div>
          <div class="form-group"><label>Dirección (opcional)</label><input type="text" id="propDireccion" placeholder="Ej: Av. 18 de Julio 1234"></div>
          <div class="form-row-3">
            <div class="form-group"><label>Precio *</label><input type="number" id="propPrice" required placeholder="150000"></div>
            <div class="form-group"><label>Moneda</label><select id="propCurrency"><option value="USD">USD</option><option value="UYU">UYU</option></select></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Tipo de Operación</label><select id="propType" onchange="togglePropertyType()"><option value="sale">Venta</option><option value="rent">Alquiler</option></select></div>
            <div class="form-group" id="propertyTypeGroup"><label>Tipo de Propiedad</label><select id="propPropertyType"><option value="common">Padrón Común</option><option value="ph">PH</option></select></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Habitaciones</label><input type="number" id="propBedrooms" placeholder="3" min="0"></div>
            <div class="form-group"><label>Baños</label><input type="number" id="propBathrooms" placeholder="2" min="0"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Área Total m²</label><input type="number" id="propTotalArea" placeholder="100"></div>
            <div class="form-group"><label>Gastos Comunes</label><input type="number" id="propExpenses" placeholder="150"></div>
          </div>
          <div class="form-group"><label>¿Tiene Garaje?</label><select id="propGarage"><option value="no">No</option><option value="yes">Sí</option></select></div>
          <div class="form-group">
            <label>Fotos * <small style="color: var(--gray-500); font-weight: normal;">(arrastra para reordenar)</small></label>
            <div class="image-upload-area" id="imageUploadArea" onclick="document.getElementById('imageInput').click()">
              <i class="fas fa-cloud-upload-alt"></i><p>Haz clic o arrastra imágenes</p><small>JPG, PNG, WebP</small>
            </div>
            <input type="file" id="imageInput" multiple accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
            <div class="image-preview-grid" id="imagePreviewGrid"></div>
          </div>
          <div class="form-group"><label>Descripción</label><textarea id="propDescription" rows="3" placeholder="Describe la propiedad..."></textarea></div>
          <div class="form-group"><label>WhatsApp de Contacto</label><input type="tel" id="propWhatsapp" placeholder="+598 99 123 456"></div>
          <button type="submit" class="btn-submit" id="propertyBtn"><i class="fas fa-check"></i> Publicar Propiedad</button>
        </form>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDnCQLlJuBtZqXNwYILio9a8ltb972bXzQ",
      authDomain: "mi-cartera-inmobiliaria.firebaseapp.com",
      projectId: "mi-cartera-inmobiliaria",
      storageBucket: "mi-cartera-inmobiliaria.firebasestorage.app",
      messagingSenderId: "923595024127",
      appId: "1:923595024127:web:b7104adcba6387a5a84eca"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const ADMIN_EMAIL = "fabricio9061@gmail.com";

    const uruguayData = {
      "Montevideo": ["Ciudad Vieja", "Centro", "Cordón", "Tres Cruces", "La Unión", "La Figurita", "Villa Muñoz", "Goes", "Pocitos", "Punta Carretas", "Malvín", "Buceo", "Parque Batlle", "Carrasco", "Prado", "Cerro", "La Teja", "Paso de la Arena", "Colón", "Sayago", "Peñarol", "Manga", "Piedras Blancas", "Maroñas", "La Blanqueada", "Parque Rodó", "Aguada", "Reducto", "Bella Vista", "Atahualpa", "Jacinto Vera", "La Comercial", "Brazo Oriental", "Capurro", "Belvedere", "Nuevo París", "Casavalle", "Borro", "Flor de Maroñas", "Jardines del Hipódromo", "Las Canteras", "Malvín Norte", "Unión", "Villa Española", "Aires Puros"],
      "Canelones": ["Ciudad de la Costa", "Las Piedras", "Pando", "Canelones", "Santa Lucía", "Progreso", "Sauce", "Tala", "Atlántida", "Salinas", "Parque del Plata", "La Paz", "San Ramón", "Barros Blancos", "Toledo", "Joaquín Suárez", "Solymar", "Shangrilá", "El Pinar", "Neptunia", "Pinamar", "Lagomar"],
      "Maldonado": ["Maldonado", "Punta del Este", "San Carlos", "Piriápolis", "Pan de Azúcar", "Aiguá", "La Barra", "José Ignacio", "Manantiales", "Punta Ballena", "Solanas", "Balneario Buenos Aires"],
      "Colonia": ["Colonia del Sacramento", "Carmelo", "Juan Lacaze", "Nueva Helvecia", "Rosario", "Tarariras", "Nueva Palmira", "Ombúes de Lavalle", "Conchillas", "Florencio Sánchez"],
      "Salto": ["Salto", "Daymán", "Belén", "Constitución", "San Antonio", "Termas del Daymán", "Termas del Arapey"],
      "Paysandú": ["Paysandú", "Guichón", "Quebracho", "Piedras Coloradas", "Termas de Guaviyú", "Termas de Almirón", "Chapicuy"],
      "Río Negro": ["Fray Bentos", "Young", "San Javier", "Nuevo Berlín", "Las Cañas"],
      "Soriano": ["Mercedes", "Dolores", "Cardona", "Palmitas", "José Enrique Rodó", "Santa Catalina"],
      "San José": ["San José de Mayo", "Ciudad del Plata", "Libertad", "Ecilda Paullier", "Rodríguez", "Rafael Perazza", "Delta del Tigre", "Kiyú"],
      "Florida": ["Florida", "Sarandí Grande", "Casupá", "25 de Mayo", "Fray Marcos", "Nico Pérez"],
      "Flores": ["Trinidad", "Ismael Cortinas", "Andresito"],
      "Durazno": ["Durazno", "Sarandí del Yí", "Carlos Reyles", "Blanquillo", "La Paloma"],
      "Tacuarembó": ["Tacuarembó", "Paso de los Toros", "San Gregorio de Polanco", "Curtina", "Achar"],
      "Rivera": ["Rivera", "Tranqueras", "Vichadero", "Minas de Corrales"],
      "Artigas": ["Artigas", "Bella Unión", "Baltasar Brum", "Tomás Gomensoro"],
      "Cerro Largo": ["Melo", "Río Branco", "Fraile Muerto", "Aceguá", "Tupambaé", "Isidoro Noblía"],
      "Lavalleja": ["Minas", "José Pedro Varela", "Solís de Mataojo", "Mariscala", "José Batlle y Ordóñez"],
      "Rocha": ["Rocha", "Chuy", "Castillos", "Lascano", "La Paloma", "La Pedrera", "Cabo Polonio", "Punta del Diablo", "Aguas Dulces", "Barra de Valizas"],
      "Treinta y Tres": ["Treinta y Tres", "Vergara", "Santa Clara de Olimar", "General Enrique Martínez", "Cerro Chato"]
    };

    let currentUser = null;
    let userProfile = null;
    let properties = [];
    let allUsers = {};
    let currentDetailProperty = null;
    let currentDetailImageIndex = 0;
    let currentProfileUserId = null;
    let selectedImages = [];
    let draggedImageIndex = null;
    let notifications = [];
    let unsubscribeNotifications = null;

    function initDepartamentos() {
      const select = document.getElementById('propDepartamento');
      select.innerHTML = '<option value="">Seleccionar...</option>';
      Object.keys(uruguayData).sort().forEach(dep => { select.innerHTML += `<option value="${dep}">${dep}</option>`; });
    }

    function updateCiudades() {
      const dep = document.getElementById('propDepartamento').value;
      const ciudadSelect = document.getElementById('propCiudad');
      ciudadSelect.innerHTML = '<option value="">Seleccionar...</option>';
      if (dep && uruguayData[dep]) { uruguayData[dep].forEach(ciudad => { ciudadSelect.innerHTML += `<option value="${ciudad}">${ciudad}</option>`; }); }
    }

    function loadRememberedUser() {
      const remembered = localStorage.getItem('rememberedEmail');
      if (remembered) { document.getElementById('loginEmail').value = remembered; document.getElementById('rememberMe').checked = true; }
    }

    async function loadUsers() {
      const snapshot = await db.collection('users').get();
      snapshot.docs.forEach(doc => { allUsers[doc.id] = doc.data(); });
    }
    loadUsers();

    // Request notification permission
    async function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission === 'default') {
        await Notification.requestPermission();
      }
    }

    // Send browser notification
    function sendBrowserNotification(title, body, icon) {
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, { body, icon: icon || '/favicon.ico', badge: '/favicon.ico' });
      }
    }

    // Listen to notifications
    function listenToNotifications() {
      if (!currentUser) return;
      if (unsubscribeNotifications) unsubscribeNotifications();
      
      unsubscribeNotifications = db.collection('notifications')
        .where('ownerId', '==', currentUser.uid)
        .orderBy('createdAt', 'desc')
        .limit(50)
        .onSnapshot((snapshot) => {
          const newNotifications = [];
          snapshot.docChanges().forEach(change => {
            if (change.type === 'added' && notifications.length > 0) {
              const data = change.doc.data();
              sendBrowserNotification(
                'Nueva consulta',
                `${data.userName} consultó sobre "${data.propertyTitle}"`,
                data.userPhoto
              );
            }
          });
          notifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          updateNotificationUI();
        });
    }

    function updateNotificationUI() {
      const badge = document.getElementById('notificationBadge');
      const list = document.getElementById('notificationList');
      const unreadCount = notifications.filter(n => !n.read).length;
      
      if (unreadCount > 0) {
        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }

      if (notifications.length === 0) {
        list.innerHTML = '<div class="notification-empty"><i class="fas fa-bell-slash"></i><p>No tienes consultas</p></div>';
        return;
      }

      list.innerHTML = notifications.map(n => {
        const initial = (n.userName || 'A').charAt(0).toUpperCase();
        const time = n.createdAt ? timeAgo(new Date(n.createdAt)) : '';
        const prop = properties.find(p => p.id === n.propertyId);
        return `
          <div class="notification-item ${n.read ? '' : 'unread'}" onclick="openNotificationProperty('${n.propertyId}', '${n.id}')">
            <div class="notification-avatar">${n.userPhoto ? `<img src="${n.userPhoto}" alt="">` : initial}</div>
            <div class="notification-content">
              <p><strong>${n.userName}</strong> consultó sobre <strong>${n.propertyTitle}</strong></p>
              <p style="font-size: 13px; color: var(--gray-600);">"${n.text.substring(0, 60)}${n.text.length > 60 ? '...' : ''}"</p>
              ${n.userPhone ? `<div class="notification-contact"><i class="fab fa-whatsapp"></i> <a href="https://wa.me/${n.userPhone.replace(/\D/g, '')}" target="_blank" onclick="event.stopPropagation()">${n.userPhone}</a></div>` : ''}
              <small>${time}</small>
            </div>
          </div>`;
      }).join('');
    }

    function timeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return 'Ahora';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `Hace ${minutes}m`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `Hace ${hours}h`;
      const days = Math.floor(hours / 24);
      if (days < 7) return `Hace ${days}d`;
      return date.toLocaleDateString('es');
    }

    function toggleNotifications(e) {
      e.stopPropagation();
      const dropdown = document.getElementById('notificationDropdown');
      dropdown.classList.toggle('active');
    }

    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('notificationDropdown');
      const bell = document.querySelector('.notification-bell');
      if (dropdown && !dropdown.contains(e.target) && !bell.contains(e.target)) {
        dropdown.classList.remove('active');
      }
    });

    async function markAllAsRead(e) {
      e.stopPropagation();
      const batch = db.batch();
      notifications.filter(n => !n.read).forEach(n => {
        batch.update(db.collection('notifications').doc(n.id), { read: true });
      });
      await batch.commit();
    }

    async function openNotificationProperty(propertyId, notificationId) {
      document.getElementById('notificationDropdown').classList.remove('active');
      if (notificationId) {
        await db.collection('notifications').doc(notificationId).update({ read: true });
      }
      openDetail(propertyId);
    }

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        const doc = await db.collection('users').doc(user.uid).get();
        if (doc.exists) {
          userProfile = doc.data();
          if (userProfile.status === 'approved' || userProfile.email.toLowerCase() === ADMIN_EMAIL) {
            currentUser = user;
            allUsers[user.uid] = userProfile;
            updateUI();
            requestNotificationPermission();
            listenToNotifications();
          } else { auth.signOut(); alert('Tu cuenta está pendiente de aprobación'); }
        }
      } else { 
        currentUser = null; 
        userProfile = null; 
        if (unsubscribeNotifications) unsubscribeNotifications();
        updateUI(); 
      }
    });

    function updateUI() {
      const navGuest = document.getElementById('nav-guest');
      const navUser = document.getElementById('nav-user');
      const userName = document.getElementById('userName');
      const adminBadge = document.getElementById('adminBadge');
      const adminBtn = document.getElementById('adminBtn');
      const userAvatar = document.getElementById('userAvatar');
      const heroButtons = document.getElementById('heroButtons');
      const btnNewProperty = document.getElementById('btnNewProperty');
      const commentFormGuest = document.getElementById('commentFormGuest');
      const commentFormUser = document.getElementById('commentFormUser');

      if (currentUser && userProfile) {
        navGuest.classList.add('hidden');
        navUser.classList.remove('hidden');
        heroButtons.classList.add('hidden');
        btnNewProperty.classList.remove('hidden');
        if (commentFormGuest) commentFormGuest.classList.add('hidden');
        if (commentFormUser) commentFormUser.classList.remove('hidden');
        userName.textContent = userProfile.name || 'Usuario';
        const initial = (userProfile.name || 'U').charAt(0).toUpperCase();
        userAvatar.innerHTML = userProfile.profilePhoto ? `<img src="${userProfile.profilePhoto}" alt="">` : initial;
        if (userProfile.email.toLowerCase() === ADMIN_EMAIL) { adminBadge.classList.remove('hidden'); adminBtn.classList.remove('hidden'); }
        else { adminBadge.classList.add('hidden'); adminBtn.classList.add('hidden'); }
      } else {
        navGuest.classList.remove('hidden');
        navUser.classList.add('hidden');
        heroButtons.classList.remove('hidden');
        btnNewProperty.classList.add('hidden');
        if (commentFormGuest) commentFormGuest.classList.remove('hidden');
        if (commentFormUser) commentFormUser.classList.add('hidden');
      }
    }

    function openModal(id) { document.getElementById(id).classList.add('active'); if (id === 'loginModal') loadRememberedUser(); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function switchModal(from, to) { closeModal(from); setTimeout(() => openModal(to), 200); }

    function openPropertyModal(propertyId = null) {
      resetPropertyForm();
      if (propertyId) {
        const p = properties.find(prop => prop.id === propertyId);
        if (p) loadPropertyForEdit(p);
      } else {
        if (userProfile && userProfile.whatsapp) document.getElementById('propWhatsapp').value = userProfile.whatsapp;
      }
      openModal('propertyModal');
    }

    function loadPropertyForEdit(p) {
      document.getElementById('propertyModalTitle').textContent = 'Editar Propiedad';
      document.getElementById('propertyBtn').innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
      document.getElementById('editingPropertyId').value = p.id;
      document.getElementById('propTitle').value = p.title || '';
      document.getElementById('propDepartamento').value = p.departamento || '';
      updateCiudades();
      setTimeout(() => { document.getElementById('propCiudad').value = p.ciudad || ''; }, 100);
      document.getElementById('propDireccion').value = p.direccion || '';
      document.getElementById('propPrice').value = p.price || '';
      document.getElementById('propCurrency').value = p.currency || 'USD';
      document.getElementById('propType').value = p.type || 'sale';
      togglePropertyType();
      document.getElementById('propPropertyType').value = p.propertyType || 'common';
      document.getElementById('propBedrooms').value = p.bedrooms || '';
      document.getElementById('propBathrooms').value = p.bathrooms || '';
      document.getElementById('propTotalArea').value = p.totalArea || '';
      document.getElementById('propExpenses').value = p.commonExpenses || '';
      document.getElementById('propGarage').value = p.garage || 'no';
      document.getElementById('propDescription').value = p.description || '';
      document.getElementById('propWhatsapp').value = p.ownerWhatsapp || '';
      if (p.images && p.images.length > 0) {
        selectedImages = p.images.map(img => ({ preview: img, existing: true }));
        renderImagePreviews();
      }
    }

    function editCurrentProperty() {
      if (currentDetailProperty) { closeModal('detailModal'); openPropertyModal(currentDetailProperty.id); }
    }

    function togglePropertyType() {
      document.getElementById('propertyTypeGroup').style.display = document.getElementById('propType').value === 'rent' ? 'none' : 'block';
    }

    async function handleLogin(e) {
      e.preventDefault();
      const btn = document.getElementById('loginBtn');
      const error = document.getElementById('loginError');
      const email = document.getElementById('loginEmail').value;
      const remember = document.getElementById('rememberMe').checked;
      btn.disabled = true; btn.textContent = 'Iniciando...'; error.classList.add('hidden');
      try {
        await auth.signInWithEmailAndPassword(email, document.getElementById('loginPassword').value);
        if (remember) localStorage.setItem('rememberedEmail', email); else localStorage.removeItem('rememberedEmail');
        closeModal('loginModal');
        document.getElementById('loginEmail').value = ''; document.getElementById('loginPassword').value = '';
      } catch (err) { error.textContent = 'Correo o contraseña incorrectos'; error.classList.remove('hidden'); }
      finally { btn.disabled = false; btn.textContent = 'Iniciar Sesión'; }
    }

    async function handleRegister(e) {
      e.preventDefault();
      const btn = document.getElementById('registerBtn');
      const error = document.getElementById('registerError');
      const success = document.getElementById('registerSuccess');
      const name = document.getElementById('registerName').value;
      const email = document.getElementById('registerEmail').value;
      const whatsapp = document.getElementById('registerWhatsapp').value;
      const password = document.getElementById('registerPassword').value;
      const confirm = document.getElementById('registerConfirm').value;
      if (password !== confirm) { error.textContent = 'Las contraseñas no coinciden'; error.classList.remove('hidden'); return; }
      btn.disabled = true; btn.textContent = 'Creando...'; error.classList.add('hidden'); success.classList.add('hidden');
      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const isAdmin = email.toLowerCase() === ADMIN_EMAIL;
        await db.collection('users').doc(userCredential.user.uid).set({ uid: userCredential.user.uid, email, name, whatsapp, status: isAdmin ? 'approved' : 'pending', createdAt: new Date().toISOString() });
        await auth.signOut();
        document.getElementById('registerForm').reset();
        success.textContent = isAdmin ? '¡Cuenta admin creada!' : '¡Cuenta creada! Espera aprobación.';
        success.classList.remove('hidden');
      } catch (err) { error.textContent = err.code === 'auth/email-already-in-use' ? 'Este correo ya está registrado' : err.message; error.classList.remove('hidden'); }
      finally { btn.disabled = false; btn.textContent = 'Crear Cuenta'; }
    }

    function logout() { auth.signOut(); showHome(); }

    async function handleProfilePhotoChange(e) {
      const file = e.target.files[0];
      if (!file || !currentUser) return;
      try {
        const compressed = await compressImage(file, 300, 0.8);
        await db.collection('users').doc(currentUser.uid).update({ profilePhoto: compressed });
        userProfile.profilePhoto = compressed;
        allUsers[currentUser.uid].profilePhoto = compressed;
        updateUI();
        document.getElementById('profileAvatar').innerHTML = `<img src="${compressed}" alt="">`;
        alert('¡Foto de perfil actualizada!');
      } catch (err) { alert('Error al actualizar foto'); }
    }

    function loadProperties() {
      db.collection('properties').orderBy('createdAt', 'desc').onSnapshot((snapshot) => {
        properties = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderProperties(properties);
        updateStats();
      });
    }

    function getUserInfo(userId) { return allUsers[userId] || { name: 'Usuario', profilePhoto: null }; }
    function formatPrice(price, currency) { return `${currency === 'UYU' ? '$U' : 'US$'} ${(price || 0).toLocaleString()}`; }
    function getLocationString(p) { return p.ciudad && p.departamento ? `${p.ciudad}, ${p.departamento}` : p.location || 'Uruguay'; }
    function canEditProperty(p) { return currentUser && (currentUser.uid === p.ownerId || userProfile?.email?.toLowerCase() === ADMIN_EMAIL); }

    function renderProperties(props, targetGrid = 'propertiesGrid') {
      const grid = document.getElementById(targetGrid);
      const loading = document.getElementById('propertiesLoading');
      const count = document.getElementById('propertiesCount');
      if (loading) loading.classList.add('hidden');
      if (count) count.textContent = `${props.length} propiedades encontradas`;
      if (props.length === 0) { grid.innerHTML = '<p style="text-align: center; color: var(--gray-500); grid-column: 1/-1; padding: 60px;">No hay propiedades disponibles</p>'; return; }
      grid.innerHTML = props.map(p => {
        const owner = getUserInfo(p.ownerId);
        const ownerInitial = (owner.name || 'U').charAt(0).toUpperCase();
        const currency = p.currency || 'USD';
        const location = getLocationString(p);
        const canEdit = canEditProperty(p);
        return `
          <div class="property-card" onclick="openDetail('${p.id}')">
            <div class="card-image">
              <img src="${p.images?.[0] || 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800'}" alt="${p.title}">
              <div class="card-badges">
                <span class="badge ${p.type === 'sale' ? 'badge-sale' : 'badge-rent'}">${p.type === 'sale' ? 'VENTA' : 'ALQUILER'}</span>
                ${p.type === 'sale' && p.propertyType === 'ph' ? '<span class="badge badge-ph">PH</span>' : ''}
                ${currency === 'UYU' ? '<span class="badge badge-currency">UYU</span>' : ''}
                ${p.garage === 'yes' ? '<span class="badge badge-garage"><i class="fas fa-car"></i></span>' : ''}
              </div>
              ${canEdit ? `<div class="card-actions">
                <button class="card-action-btn edit" onclick="event.stopPropagation(); openPropertyModal('${p.id}')" title="Editar"><i class="fas fa-edit"></i></button>
                <button class="card-action-btn delete" onclick="event.stopPropagation(); deleteProperty('${p.id}')" title="Eliminar"><i class="fas fa-trash"></i></button>
              </div>` : ''}
              <div class="card-owner" onclick="event.stopPropagation(); showProfile('${p.ownerId}')">
                ${owner.profilePhoto ? `<img src="${owner.profilePhoto}" alt="">` : `<div class="card-owner-initial">${ownerInitial}</div>`}
                <span>${owner.name || 'Usuario'}</span>
              </div>
            </div>
            <div class="card-content">
              <div class="card-price">${formatPrice(p.price, currency)}${p.type === 'rent' ? '<span>/mes</span>' : ''}</div>
              <h3 class="card-title">${p.title}</h3>
              <div class="card-location"><i class="fas fa-map-marker-alt"></i>${location}</div>
              <div class="card-features">
                ${p.bedrooms ? `<div class="card-feature"><i class="fas fa-bed"></i>${p.bedrooms}</div>` : ''}
                ${p.bathrooms ? `<div class="card-feature"><i class="fas fa-bath"></i>${p.bathrooms}</div>` : ''}
                ${p.totalArea ? `<div class="card-feature"><i class="fas fa-expand"></i>${p.totalArea}m²</div>` : ''}
                ${p.garage === 'yes' ? `<div class="card-feature"><i class="fas fa-car"></i>Garaje</div>` : ''}
              </div>
            </div>
            <div class="card-footer">
              <span class="card-views"><i class="fas fa-eye"></i> ${p.views || 0}</span>
              <button class="btn-whatsapp" onclick="event.stopPropagation(); contactWhatsapp('${p.id}')"><i class="fab fa-whatsapp"></i> Contactar</button>
            </div>
          </div>`;
      }).join('');
    }

    function updateStats() {
      document.getElementById('statTotal').textContent = properties.length;
      document.getElementById('statSale').textContent = properties.filter(p => p.type === 'sale').length;
      document.getElementById('statRent').textContent = properties.filter(p => p.type === 'rent').length;
    }

    function filterProperties() {
      const search = document.getElementById('filterSearch').value.toLowerCase();
      const type = document.getElementById('filterType').value;
      const bedrooms = parseInt(document.getElementById('filterBedrooms').value) || 0;
      const maxPrice = parseInt(document.getElementById('filterPrice').value) || Infinity;
      const filtered = properties.filter(p => {
        const location = getLocationString(p).toLowerCase();
        if (search && !p.title.toLowerCase().includes(search) && !location.includes(search)) return false;
        if (type && p.type !== type) return false;
        if (bedrooms && (p.bedrooms || 0) < bedrooms) return false;
        if (p.price > maxPrice) return false;
        return true;
      });
      renderProperties(filtered);
    }

    async function openDetail(id) {
      const p = properties.find(prop => prop.id === id);
      if (!p) return;
      currentDetailProperty = p;
      currentDetailImageIndex = 0;
      db.collection('properties').doc(id).update({ views: firebase.firestore.FieldValue.increment(1) });
      const images = p.images?.length ? p.images : ['https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800'];
      document.getElementById('detailImage').src = images[0];
      document.getElementById('detailTitle').textContent = p.title;
      document.getElementById('detailLocation').textContent = getLocationString(p) + (p.direccion ? ` - ${p.direccion}` : '');
      const currency = p.currency || 'USD';
      document.getElementById('detailPrice').textContent = `${formatPrice(p.price, currency)}${p.type === 'rent' ? '/mes' : ''}`;
      document.getElementById('detailDescription').textContent = p.description || 'Sin descripción.';
      const thumbsContainer = document.getElementById('detailThumbnails');
      if (images.length > 1) {
        thumbsContainer.innerHTML = images.map((img, i) => `<div class="detail-thumb ${i === 0 ? 'active' : ''}" onclick="setDetailImage(${i})"><img src="${img}" alt=""></div>`).join('');
        thumbsContainer.style.display = 'flex';
      } else thumbsContainer.style.display = 'none';
      const owner = getUserInfo(p.ownerId);
      const ownerInitial = (owner.name || 'U').charAt(0).toUpperCase();
      document.getElementById('detailOwnerName').textContent = owner.name || 'Usuario';
      document.getElementById('detailOwnerAvatar').innerHTML = owner.profilePhoto ? `<img src="${owner.profilePhoto}" alt="">` : ownerInitial;
      document.getElementById('detailBadges').innerHTML = `
        <span class="badge ${p.type === 'sale' ? 'badge-sale' : 'badge-rent'}">${p.type === 'sale' ? 'VENTA' : 'ALQUILER'}</span>
        ${p.type === 'sale' && p.propertyType === 'ph' ? '<span class="badge badge-ph">PH</span>' : ''}
        ${currency === 'UYU' ? '<span class="badge badge-currency">UYU</span>' : ''}
        ${p.garage === 'yes' ? '<span class="badge badge-garage"><i class="fas fa-car"></i></span>' : ''}`;
      document.getElementById('detailFeatures').innerHTML = `
        ${p.bedrooms ? `<div class="detail-feature"><i class="fas fa-bed"></i><strong>${p.bedrooms}</strong><span>Dormitorios</span></div>` : ''}
        ${p.bathrooms ? `<div class="detail-feature"><i class="fas fa-bath"></i><strong>${p.bathrooms}</strong><span>Baños</span></div>` : ''}
        ${p.totalArea ? `<div class="detail-feature"><i class="fas fa-expand"></i><strong>${p.totalArea}</strong><span>m²</span></div>` : ''}
        ${p.garage === 'yes' ? `<div class="detail-feature"><i class="fas fa-car"></i><strong>Sí</strong><span>Garaje</span></div>` : ''}
        ${p.commonExpenses ? `<div class="detail-feature"><i class="fas fa-dollar-sign"></i><strong>${p.commonExpenses}</strong><span>Gastos</span></div>` : ''}`;
      document.getElementById('detailWhatsapp').onclick = () => contactWhatsapp(id);
      document.getElementById('detailEditBtn').classList.toggle('hidden', !canEditProperty(p));
      
      // Show correct comment form
      const isOwner = currentUser && currentUser.uid === p.ownerId;
      document.getElementById('commentFormGuest').classList.toggle('hidden', !!currentUser);
      document.getElementById('commentFormUser').classList.toggle('hidden', !currentUser);
      
      loadComments(id);
      openModal('detailModal');
    }

    function setDetailImage(index) {
      if (!currentDetailProperty?.images?.length) return;
      currentDetailImageIndex = index;
      document.getElementById('detailImage').src = currentDetailProperty.images[index];
      document.querySelectorAll('.detail-thumb').forEach((t, i) => { t.classList.toggle('active', i === index); });
    }
    function prevDetailImage() { if (!currentDetailProperty?.images?.length) return; currentDetailImageIndex = (currentDetailImageIndex - 1 + currentDetailProperty.images.length) % currentDetailProperty.images.length; setDetailImage(currentDetailImageIndex); }
    function nextDetailImage() { if (!currentDetailProperty?.images?.length) return; currentDetailImageIndex = (currentDetailImageIndex + 1) % currentDetailProperty.images.length; setDetailImage(currentDetailImageIndex); }
    function viewOwnerProfile() { if (currentDetailProperty) { closeModal('detailModal'); showProfile(currentDetailProperty.ownerId); } }

    async function loadComments(propertyId) {
      const container = document.getElementById('commentsList');
      container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      const isOwner = currentUser && currentDetailProperty && currentUser.uid === currentDetailProperty.ownerId;
      try {
        const snapshot = await db.collection('properties').doc(propertyId).collection('comments').orderBy('createdAt', 'desc').get();
        const comments = snapshot.docs.map(doc => doc.data());
        if (comments.length === 0) { container.innerHTML = '<div class="no-comments"><i class="fas fa-comment-slash"></i><p>Sé el primero en consultar</p></div>'; return; }
        container.innerHTML = comments.map(c => {
          const initial = (c.userName || 'A').charAt(0).toUpperCase();
          const time = c.createdAt ? new Date(c.createdAt).toLocaleDateString('es') : '';
          const showPhone = isOwner && c.userPhone;
          return `
            <div class="comment-item">
              <div class="comment-avatar">${c.userPhoto ? `<img src="${c.userPhoto}" alt="">` : initial}</div>
              <div class="comment-content">
                <div class="comment-header">
                  <span class="comment-author">${c.userName || 'Anónimo'}</span>
                  ${c.isGuest ? '<span class="comment-guest-badge">Invitado</span>' : ''}
                  <span class="comment-time">${time}</span>
                </div>
                <p class="comment-text">${c.text}</p>
                ${showPhone ? `<div class="comment-contact"><i class="fab fa-whatsapp"></i> Contacto: <a href="https://wa.me/${c.userPhone.replace(/\D/g, '')}" target="_blank">${c.userPhone}</a></div>` : ''}
              </div>
            </div>`;
        }).join('');
      } catch (err) { container.innerHTML = '<p style="color: var(--danger);">Error</p>'; }
    }

    async function addComment() {
      let text, userName, userPhone, userPhoto, isGuest;
      
      if (currentUser && userProfile) {
        text = document.getElementById('commentInputUser').value.trim();
        userName = userProfile.name;
        userPhone = userProfile.whatsapp || '';
        userPhoto = userProfile.profilePhoto || null;
        isGuest = false;
      } else {
        text = document.getElementById('commentInput').value.trim();
        userName = document.getElementById('guestName').value.trim();
        userPhone = document.getElementById('guestPhone').value.trim();
        userPhoto = null;
        isGuest = true;
        
        if (!userName) { alert('Por favor ingresa tu nombre'); return; }
        if (!userPhone) { alert('Por favor ingresa tu WhatsApp'); return; }
      }
      
      if (!text || !currentDetailProperty) { alert('Por favor escribe tu consulta'); return; }
      
      try {
        // Add comment to property
        await db.collection('properties').doc(currentDetailProperty.id).collection('comments').add({
          userId: currentUser?.uid || null,
          userName,
          userPhone,
          userPhoto,
          text,
          isGuest,
          createdAt: new Date().toISOString()
        });
        
        // Create notification for property owner
        if (currentDetailProperty.ownerId !== currentUser?.uid) {
          await db.collection('notifications').add({
            ownerId: currentDetailProperty.ownerId,
            propertyId: currentDetailProperty.id,
            propertyTitle: currentDetailProperty.title,
            userName,
            userPhone,
            userPhoto,
            text,
            read: false,
            createdAt: new Date().toISOString()
          });
        }
        
        // Clear inputs
        if (currentUser) {
          document.getElementById('commentInputUser').value = '';
        } else {
          document.getElementById('commentInput').value = '';
        }
        
        loadComments(currentDetailProperty.id);
        alert('¡Consulta enviada!');
      } catch (err) { 
        console.error(err);
        alert('Error al enviar consulta'); 
      }
    }

    function contactWhatsapp(id) {
      const p = properties.find(prop => prop.id === id);
      if (!p) return;
      const owner = getUserInfo(p.ownerId);
      const phone = (p.ownerWhatsapp || owner.whatsapp || '59899000000').replace(/\D/g, '');
      const message = `Hola, me interesa: ${p.title} - ${formatPrice(p.price, p.currency || 'USD')} en ${getLocationString(p)}`;
      window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
    }

    function showHome() {
      document.getElementById('mainContent').classList.remove('hidden');
      document.getElementById('adminPanel').classList.add('hidden');
      document.getElementById('profilePage').classList.add('hidden');
      currentProfileUserId = null; window.location.hash = '';
    }

    async function showProfile(userId) {
      currentProfileUserId = userId;
      window.location.hash = `perfil/${userId}`;
      const userDoc = await db.collection('users').doc(userId).get();
      const userData = userDoc.exists ? userDoc.data() : { name: 'Usuario', email: '' };
      document.getElementById('profileName').textContent = userData.name || 'Usuario';
      document.getElementById('profileNameTitle').textContent = userData.name || 'Usuario';
      document.getElementById('profileEmail').textContent = userData.email || '';
      const initial = (userData.name || 'U').charAt(0).toUpperCase();
      document.getElementById('profileAvatar').innerHTML = userData.profilePhoto ? `<img src="${userData.profilePhoto}" alt="">` : initial;
      const isOwnProfile = currentUser && currentUser.uid === userId;
      document.getElementById('profileAvatarEdit').classList.toggle('hidden', !isOwnProfile);
      const userProperties = properties.filter(p => p.ownerId === userId);
      const totalViews = userProperties.reduce((sum, p) => sum + (p.views || 0), 0);
      document.getElementById('profilePropertiesCount').textContent = userProperties.length;
      document.getElementById('profileViewsCount').textContent = totalViews;
      document.getElementById('profilePropertiesSubtitle').textContent = `${userProperties.length} propiedades`;
      document.getElementById('btnNewPropertyProfile').classList.toggle('hidden', !isOwnProfile);
      renderProperties(userProperties, 'profilePropertiesGrid');
      document.getElementById('mainContent').classList.add('hidden');
      document.getElementById('adminPanel').classList.add('hidden');
      document.getElementById('profilePage').classList.remove('hidden');
    }

    function showMyProfile() { if (currentUser) showProfile(currentUser.uid); }
    function getProfileLink() { return `${window.location.origin}${window.location.pathname}#perfil/${currentProfileUserId}`; }
    function copyProfileLink() { navigator.clipboard.writeText(getProfileLink()).then(() => { alert('¡Enlace copiado!'); }); }
    function shareProfileWhatsapp() { const user = allUsers[currentProfileUserId] || { name: 'este usuario' }; window.open(`https://wa.me/?text=${encodeURIComponent(`Mira las propiedades de ${user.name}: ${getProfileLink()}`)}`, '_blank'); }
    function shareProfileFacebook() { window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(getProfileLink())}`, '_blank'); }
    function shareProfileTwitter() { const user = allUsers[currentProfileUserId] || { name: 'este usuario' }; window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(`Mira las propiedades de ${user.name}`)}&url=${encodeURIComponent(getProfileLink())}`, '_blank'); }

    function handleHash() { const hash = window.location.hash; if (hash.startsWith('#perfil/')) showProfile(hash.replace('#perfil/', '')); }
    window.addEventListener('hashchange', handleHash);

    function showAdmin() {
      if (!currentUser || userProfile?.email?.toLowerCase() !== ADMIN_EMAIL) return;
      document.getElementById('mainContent').classList.add('hidden');
      document.getElementById('profilePage').classList.add('hidden');
      document.getElementById('adminPanel').classList.remove('hidden');
      showAdminTab('pending');
    }

    async function showAdminTab(tab) {
      document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
      document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
      const content = document.getElementById('adminContent');
      content.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      if (tab === 'pending') {
        const snapshot = await db.collection('users').where('status', '==', 'pending').get();
        const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        document.getElementById('pendingCount').textContent = users.length > 0 ? `(${users.length})` : '';
        content.innerHTML = users.length === 0 ? `<div class="empty-state"><i class="fas fa-check-circle" style="color: var(--success);"></i><h3>Sin pendientes</h3></div>`
          : users.map(u => `<div class="user-card"><div class="user-card-avatar"><i class="fas fa-user"></i></div><div class="user-card-info"><h4>${u.name}</h4><p>${u.email}</p><small>WhatsApp: ${u.whatsapp || '-'}</small></div><div class="user-card-actions"><button class="btn-approve" onclick="approveUser('${u.id}')"><i class="fas fa-check"></i></button><button class="btn-reject" onclick="rejectUser('${u.id}')"><i class="fas fa-times"></i></button></div></div>`).join('');
      } else if (tab === 'users') {
        const snapshot = await db.collection('users').get();
        const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        content.innerHTML = users.map(u => `<div class="user-card"><div class="user-card-avatar">${u.profilePhoto ? `<img src="${u.profilePhoto}" alt="">` : '<i class="fas fa-user"></i>'}</div><div class="user-card-info"><h4>${u.name} ${u.email.toLowerCase() === ADMIN_EMAIL ? '<span class="admin-badge">Admin</span>' : ''}</h4><p>${u.email}</p><small style="color: ${u.status === 'approved' ? 'var(--success)' : 'var(--gold)'}">${u.status}</small></div><div class="user-card-actions"><button class="btn-edit" onclick="showProfile('${u.id}')"><i class="fas fa-eye"></i></button>${u.email.toLowerCase() !== ADMIN_EMAIL ? `<button class="btn-reject" onclick="deleteUser('${u.id}')"><i class="fas fa-trash"></i></button>` : ''}</div></div>`).join('');
      } else if (tab === 'properties') {
        content.innerHTML = properties.length === 0 ? '<div class="empty-state"><i class="fas fa-building"></i><h3>Sin propiedades</h3></div>'
          : properties.map(p => {
            const owner = getUserInfo(p.ownerId);
            return `<div class="user-card"><div class="user-card-avatar" style="border-radius: 8px;"><img src="${p.images?.[0] || 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=100'}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;"></div><div class="user-card-info"><h4>${p.title}</h4><p>${formatPrice(p.price, p.currency || 'USD')} - ${getLocationString(p)}</p><small>${owner.name}</small></div><div class="user-card-actions"><button class="btn-edit" onclick="openPropertyModal('${p.id}')"><i class="fas fa-edit"></i></button><button class="btn-reject" onclick="deleteProperty('${p.id}')"><i class="fas fa-trash"></i></button></div></div>`;
          }).join('');
      }
    }

    async function approveUser(id) { await db.collection('users').doc(id).update({ status: 'approved' }); allUsers[id] = { ...allUsers[id], status: 'approved' }; showAdminTab('pending'); }
    async function rejectUser(id) { await db.collection('users').doc(id).update({ status: 'rejected' }); showAdminTab('pending'); }
    async function deleteUser(id) { if (!confirm('¿Eliminar?')) return; await db.collection('users').doc(id).delete(); delete allUsers[id]; showAdminTab('users'); }
    async function deleteProperty(id) { if (!confirm('¿Eliminar esta propiedad?')) return; await db.collection('properties').doc(id).delete(); }

    const uploadArea = document.getElementById('imageUploadArea');
    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
    uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); addImagesToPreview(Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'))); });

    function handleImageSelect(e) { addImagesToPreview(Array.from(e.target.files)); e.target.value = ''; }

    function compressImage(file, maxWidth = 800, quality = 0.7) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width, height = img.height;
            if (width > maxWidth) { height = (height * maxWidth) / width; width = maxWidth; }
            canvas.width = width; canvas.height = height;
            canvas.getContext('2d').drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL('image/jpeg', quality));
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    async function addImagesToPreview(files) {
      for (const file of files) { const compressed = await compressImage(file); selectedImages.push({ preview: compressed }); renderImagePreviews(); }
    }

    function renderImagePreviews() {
      document.getElementById('imagePreviewGrid').innerHTML = selectedImages.map((img, i) => `
        <div class="image-preview-item ${i === 0 ? 'main' : ''}" draggable="true" ondragstart="handleDragStart(event, ${i})" ondragover="handleDragOver(event)" ondragenter="handleDragEnter(event)" ondragleave="handleDragLeave(event)" ondrop="handleDropImage(event, ${i})" ondragend="handleDragEnd(event)">
          <img src="${img.preview}" alt=""><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><div class="remove-image" onclick="event.stopPropagation(); removeImage(${i})"><i class="fas fa-times"></i></div>
        </div>`).join('');
    }

    function handleDragStart(e, index) { draggedImageIndex = index; e.target.classList.add('dragging'); }
    function handleDragOver(e) { e.preventDefault(); }
    function handleDragEnter(e) { e.preventDefault(); if (e.target.closest('.image-preview-item')) e.target.closest('.image-preview-item').classList.add('drag-over'); }
    function handleDragLeave(e) { if (e.target.closest('.image-preview-item')) e.target.closest('.image-preview-item').classList.remove('drag-over'); }
    function handleDropImage(e, targetIndex) {
      e.preventDefault();
      const item = e.target.closest('.image-preview-item');
      if (item) item.classList.remove('drag-over');
      if (draggedImageIndex !== null && draggedImageIndex !== targetIndex) {
        const draggedItem = selectedImages[draggedImageIndex];
        selectedImages.splice(draggedImageIndex, 1);
        selectedImages.splice(targetIndex, 0, draggedItem);
        renderImagePreviews();
      }
    }
    function handleDragEnd(e) { e.target.classList.remove('dragging'); draggedImageIndex = null; document.querySelectorAll('.image-preview-item').forEach(item => item.classList.remove('drag-over')); }
    function removeImage(index) { selectedImages.splice(index, 1); renderImagePreviews(); }

    function resetPropertyForm() {
      document.getElementById('propertyForm').reset();
      document.getElementById('editingPropertyId').value = '';
      document.getElementById('propertyModalTitle').textContent = 'Nueva Propiedad';
      document.getElementById('propertyBtn').innerHTML = '<i class="fas fa-check"></i> Publicar Propiedad';
      selectedImages = [];
      renderImagePreviews();
      togglePropertyType();
      document.getElementById('propCiudad').innerHTML = '<option value="">Primero selecciona departamento</option>';
    }

    async function handleSaveProperty(e) {
      e.preventDefault();
      if (!currentUser) { alert('Debes iniciar sesión'); return; }
      if (selectedImages.length === 0) { alert('Sube al menos una imagen'); return; }

      const btn = document.getElementById('propertyBtn');
      const error = document.getElementById('propertyError');
      const editingId = document.getElementById('editingPropertyId').value;
      
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
      error.classList.add('hidden');

      try {
        const imageUrls = selectedImages.map(img => img.preview);
        const type = document.getElementById('propType').value;
        const departamento = document.getElementById('propDepartamento').value;
        const ciudad = document.getElementById('propCiudad').value;

        const propertyData = {
          title: document.getElementById('propTitle').value,
          departamento, ciudad,
          direccion: document.getElementById('propDireccion').value,
          location: `${ciudad}, ${departamento}`,
          price: parseInt(document.getElementById('propPrice').value),
          currency: document.getElementById('propCurrency').value,
          type,
          propertyType: type === 'sale' ? document.getElementById('propPropertyType').value : 'common',
          bedrooms: parseInt(document.getElementById('propBedrooms').value) || 0,
          bathrooms: parseInt(document.getElementById('propBathrooms').value) || 0,
          totalArea: parseInt(document.getElementById('propTotalArea').value) || 0,
          commonExpenses: parseInt(document.getElementById('propExpenses').value) || 0,
          garage: document.getElementById('propGarage').value,
          images: imageUrls,
          description: document.getElementById('propDescription').value,
          ownerWhatsapp: document.getElementById('propWhatsapp').value || userProfile.whatsapp,
          updatedAt: new Date().toISOString()
        };

        if (editingId) {
          await db.collection('properties').doc(editingId).update(propertyData);
          alert('¡Propiedad actualizada!');
        } else {
          propertyData.ownerId = currentUser.uid;
          propertyData.ownerName = userProfile.name;
          propertyData.views = 0;
          propertyData.createdAt = new Date().toISOString();
          await db.collection('properties').add(propertyData);
          alert('¡Propiedad publicada!');
        }

        closeModal('propertyModal');
        resetPropertyForm();
      } catch (err) {
        error.textContent = 'Error: ' + err.message;
        error.classList.remove('hidden');
      } finally {
        btn.disabled = false;
        btn.innerHTML = editingId ? '<i class="fas fa-save"></i> Guardar Cambios' : '<i class="fas fa-check"></i> Publicar Propiedad';
      }
    }

    initDepartamentos();
    loadProperties();
    setTimeout(handleHash, 500);
  </script>
</body>
</html>
