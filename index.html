<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Cartera Inmobiliaria</title>
  <meta name="description" content="Encuentra las mejores propiedades en venta y alquiler en Uruguay">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Mi Cartera Inmobiliaria" id="ogTitle">
  <meta property="og:description" content="Encuentra las mejores propiedades en venta y alquiler en Uruguay" id="ogDescription">
  <meta property="og:image" content="https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=1200" id="ogImage">
  <meta property="og:url" content="" id="ogUrl">
  <meta name="twitter:card" content="summary_large_image">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#e94560">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root{--primary:#1a1a2e;--primary-light:#16213e;--secondary:#0f3460;--accent:#e94560;--accent-hover:#d63d56;--gold:#c9a227;--white:#fff;--off-white:#f8f9fa;--gray-100:#f1f3f5;--gray-200:#e9ecef;--gray-300:#dee2e6;--gray-400:#ced4da;--gray-500:#adb5bd;--gray-600:#868e96;--gray-700:#495057;--success:#2ecc71;--danger:#e74c3c;--reserved:#9b59b6;--sold:#e74c3c;--shadow-sm:0 2px 8px rgba(0,0,0,.08);--shadow-md:0 4px 16px rgba(0,0,0,.12);--shadow-lg:0 8px 32px rgba(0,0,0,.16);--radius-sm:8px;--radius-md:12px;--radius-lg:16px;--radius-xl:24px;--radius-full:50px}
    *{margin:0;padding:0;box-sizing:border-box}html,body{overflow-x:hidden;width:100%}body{font-family:'DM Sans',sans-serif;background:var(--off-white);color:var(--gray-700);line-height:1.6}h1,h2,h3{font-family:'Playfair Display',serif;color:var(--primary)}a{text-decoration:none;color:inherit}button{cursor:pointer;font-family:inherit;border:none}.container{max-width:1200px;margin:0 auto;padding:0 20px}.hidden{display:none!important}
    .header{background:var(--white);box-shadow:var(--shadow-sm);position:sticky;top:0;z-index:100}.header-content{display:flex;justify-content:space-between;align-items:center;padding:16px 0;flex-wrap:wrap;gap:16px}.logo{display:flex;align-items:center;gap:12px;font-family:'Playfair Display',serif;font-size:22px;font-weight:700;color:var(--primary);cursor:pointer}.logo i{color:var(--accent);font-size:28px}.nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.nav a,.nav button{padding:10px 20px;border-radius:var(--radius-md);font-weight:500;transition:all .3s;background:none;font-size:14px}.nav a:hover{background:var(--gray-100)}.btn-primary{background:var(--accent)!important;color:var(--white)!important}.btn-primary:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}.btn-secondary{background:transparent!important;color:var(--accent)!important;border:2px solid var(--accent)!important}.btn-secondary:hover{background:var(--accent)!important;color:var(--white)!important}
    .user-info{display:flex;align-items:center;gap:12px;padding:8px 16px;background:var(--gray-100);border-radius:var(--radius-full);cursor:pointer;transition:all .3s;position:relative}.user-info:hover{background:var(--gray-200)}.user-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--gold));display:flex;align-items:center;justify-content:center;overflow:hidden;color:var(--white);font-weight:600}.user-avatar img{width:100%;height:100%;object-fit:cover}.admin-badge{background:var(--gold);color:var(--white);padding:4px 10px;border-radius:var(--radius-full);font-size:11px;font-weight:600}.logout-btn{background:var(--gray-200)!important;color:var(--gray-700)!important}
    .user-dropdown{position:absolute;top:calc(100% + 8px);right:0;width:220px;background:var(--white);border-radius:var(--radius-lg);box-shadow:var(--shadow-lg);overflow:hidden;display:none;z-index:1000}.user-dropdown.active{display:block;animation:slideDown .2s ease}.user-dropdown-item{display:flex;align-items:center;gap:12px;padding:14px 16px;color:var(--gray-700);transition:all .2s;cursor:pointer;border-bottom:1px solid var(--gray-100)}.user-dropdown-item:last-child{border-bottom:none}.user-dropdown-item:hover{background:var(--gray-50);color:var(--accent)}.user-dropdown-item i{width:20px;text-align:center;color:var(--gray-500)}.user-dropdown-item:hover i{color:var(--accent)}
    .notification-bell,.calendar-btn{position:relative;width:44px;height:44px;border-radius:50%;background:var(--gray-100);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s}.notification-bell:hover,.calendar-btn:hover{background:var(--gray-200);transform:scale(1.05)}.notification-bell i,.calendar-btn i{font-size:20px;color:var(--gray-600)}.notification-bell.has-unread i{color:var(--accent)}.calendar-btn.has-events i{color:var(--gold)}.notification-badge{position:absolute;top:-4px;right:-4px;min-width:22px;height:22px;background:var(--accent);color:var(--white);font-size:11px;font-weight:700;border-radius:50%;display:flex;align-items:center;justify-content:center;padding:0 6px;border:2px solid var(--white);animation:pulse 2s infinite}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
    .notification-dropdown{position:absolute;top:calc(100% + 8px);right:0;width:380px;max-height:500px;background:var(--white);border-radius:var(--radius-lg);box-shadow:0 10px 40px rgba(0,0,0,.15);overflow:hidden;display:none;z-index:1001}.notification-dropdown.active{display:block;animation:slideDown .2s ease}.notification-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.3);z-index:9998}.notification-overlay.active{display:block}@keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}.notification-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--gray-100);background:var(--gray-50)}.notification-header h3{font-size:16px;font-family:'DM Sans',sans-serif;font-weight:600;display:flex;align-items:center;gap:8px}.notification-header h3 i{color:var(--accent)}.notification-actions{display:flex;gap:8px}.notification-actions button{background:none;color:var(--accent);font-size:12px;font-weight:500;padding:4px 8px;border-radius:var(--radius-sm);transition:all .2s}.notification-actions button:hover{background:rgba(233,69,96,.1)}.notification-actions .btn-clear{color:var(--danger)}.notification-actions .btn-clear:hover{background:rgba(231,76,60,.1)}.notification-list{max-height:400px;overflow-y:auto}.notification-item{display:flex;gap:12px;padding:16px 20px;border-bottom:1px solid var(--gray-100);cursor:pointer;transition:background .2s;position:relative}.notification-item:hover{background:var(--gray-50)}.notification-item.unread{background:rgba(233,69,96,.08)}.notification-item.unread::after{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background:var(--accent)}.notification-avatar{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--gold));display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;font-weight:600;color:var(--white);font-size:18px}.notification-avatar img{width:100%;height:100%;object-fit:cover}.notification-body{flex:1;min-width:0}.notification-body p{font-size:14px;color:var(--gray-700);margin-bottom:6px;line-height:1.4}.notification-body p strong{color:var(--primary)}.notification-message{font-size:13px;color:var(--gray-500);background:var(--gray-100);padding:8px 12px;border-radius:var(--radius-sm);margin-bottom:8px;border-left:3px solid var(--accent)}.notification-meta{display:flex;align-items:center;gap:12px;font-size:12px;color:var(--gray-400)}.notification-phone{display:inline-flex;align-items:center;gap:4px;color:#25D366;font-weight:500}.notification-empty{text-align:center;padding:60px 20px;color:var(--gray-400)}.notification-empty i{font-size:48px;margin-bottom:16px;opacity:.5}
    .btn-new-property{display:inline-flex;align-items:center;gap:12px;padding:14px 28px;background:linear-gradient(135deg,var(--accent) 0%,#ff6b8a 50%,var(--gold) 100%);background-size:200% 200%;color:var(--white);font-size:15px;font-weight:600;border-radius:var(--radius-full);box-shadow:0 4px 15px rgba(233,69,96,.4);transition:all .4s cubic-bezier(.175,.885,.32,1.275);position:relative;overflow:hidden}.btn-new-property:hover{transform:translateY(-3px) scale(1.02);box-shadow:0 8px 25px rgba(233,69,96,.5)}.btn-new-property i{font-size:18px;transition:transform .3s}.btn-new-property:hover i{transform:rotate(90deg)}
    .hero{background:linear-gradient(135deg,var(--primary),var(--secondary));padding:80px 0;text-align:center;color:var(--white)}.hero h1{font-size:48px;margin-bottom:16px;color:var(--white)}.hero h1 span{color:var(--gold)}.hero p{font-size:18px;opacity:.9;max-width:600px;margin:0 auto 32px}.hero-stats{display:flex;justify-content:center;gap:48px;margin-top:40px;flex-wrap:wrap}.hero-stat{text-align:center}.hero-stat-number{font-size:36px;font-weight:700;font-family:'Playfair Display',serif}.hero-stat-label{font-size:14px;opacity:.8}.hero-buttons{display:flex;gap:16px;justify-content:center;margin-bottom:40px;flex-wrap:wrap}.hero-btn{padding:16px 32px;border-radius:var(--radius-lg);font-size:18px;font-weight:600;display:flex;align-items:center;gap:10px;transition:all .3s}.hero-btn-primary{background:var(--gold);color:var(--primary)}.hero-btn-primary:hover{background:#d4ad2b;transform:translateY(-3px)}.hero-btn-secondary{background:rgba(255,255,255,.15);color:var(--white);border:2px solid var(--white)}.hero-btn-secondary:hover{background:var(--white);color:var(--primary)}
    .filters{background:var(--white);padding:24px;border-radius:var(--radius-xl);box-shadow:var(--shadow-md);margin:-40px auto 40px;max-width:1000px;position:relative;z-index:10}.filters-row{display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:16px;align-items:end}.filter-group label{display:block;font-size:12px;font-weight:600;color:var(--gray-600);margin-bottom:6px;text-transform:uppercase}.filter-group input,.filter-group select{width:100%;padding:12px 16px;border:2px solid var(--gray-200);border-radius:var(--radius-md);font-size:14px;transition:all .3s}.filter-group input:focus,.filter-group select:focus{border-color:var(--accent);outline:none}.filter-btn{padding:12px 28px;background:var(--accent);color:var(--white);border-radius:var(--radius-md);font-weight:600;transition:all .3s}.filter-btn:hover{background:var(--accent-hover)}
    .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:32px;flex-wrap:wrap;gap:16px}.section-title{font-size:32px;margin-bottom:0}.section-subtitle{color:var(--gray-500);margin-top:4px}.properties-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:28px;margin-bottom:60px}
    .property-card{background:var(--white);border-radius:var(--radius-xl);overflow:hidden;box-shadow:var(--shadow-sm);transition:all .3s;cursor:pointer;position:relative}.property-card:hover{transform:translateY(-8px);box-shadow:var(--shadow-lg)}.property-card.status-reserved{border:3px solid var(--reserved)}.property-card.status-sold{border:3px solid var(--sold)}.property-card.status-rented{border:3px solid #3498db}.property-card.status-archived{border:3px solid #7f8c8d;opacity:.7}.card-image{position:relative;height:220px;overflow:hidden}.card-image img{width:100%;height:100%;object-fit:cover;transition:transform .5s}.property-card:hover .card-image img{transform:scale(1.05)}
    .property-status-overlay{position:absolute;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;z-index:5;pointer-events:none}.property-status-overlay.reserved{background:rgba(155,89,182,.3)}.property-status-overlay.sold{background:rgba(231,76,60,.4)}.property-status-overlay.rented{background:rgba(52,152,219,.3)}.property-status-overlay.archived{background:rgba(127,140,141,.4)}.status-ribbon{padding:12px 40px;font-size:18px;font-weight:700;text-transform:uppercase;letter-spacing:2px;transform:rotate(-15deg)}.status-ribbon.reserved{background:var(--reserved);color:white;box-shadow:0 4px 15px rgba(155,89,182,.5)}.status-ribbon.sold{background:var(--sold);color:white;box-shadow:0 4px 15px rgba(231,76,60,.5)}.status-ribbon.rented{background:#3498db;color:white;box-shadow:0 4px 15px rgba(52,152,219,.5)}.status-ribbon.archived{background:#7f8c8d;color:white;box-shadow:0 4px 15px rgba(127,140,141,.5)}
    .card-badges{position:absolute;top:16px;left:16px;display:flex;gap:8px;flex-wrap:wrap;z-index:6}.badge{padding:6px 14px;border-radius:var(--radius-full);font-size:11px;font-weight:700;text-transform:uppercase}.badge-sale{background:linear-gradient(135deg,var(--accent),#ff6b6b);color:var(--white)}.badge-rent{background:linear-gradient(135deg,#3498db,#2ecc71);color:var(--white)}.badge-ph{background:var(--gold);color:var(--white)}.badge-currency{background:var(--primary);color:var(--white)}.badge-garage{background:#6c5ce7;color:var(--white)}.badge-reserved{background:var(--reserved);color:var(--white)}.badge-sold{background:var(--sold);color:var(--white)}.badge-rented{background:#3498db;color:var(--white)}.badge-archived{background:#7f8c8d;color:var(--white)}.badge-reduced{background:var(--success);color:#fff;font-weight:700;text-shadow:0 1px 2px rgba(0,0,0,.2)}.badge-featured{background:linear-gradient(135deg,#f1c40f,#f39c12);color:#fff;font-weight:700;animation:pulseFeature 2s ease-in-out infinite}.property-card.featured{border:3px solid #f1c40f;box-shadow:0 8px 32px rgba(241,196,15,.3)}.property-card.featured::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#f1c40f,#f39c12,#f1c40f);z-index:10}@keyframes pulseFeature{0%,100%{box-shadow:0 0 0 0 rgba(241,196,15,.5)}50%{box-shadow:0 0 12px 4px rgba(241,196,15,.3)}}@keyframes flashBadge{0%,100%{box-shadow:0 0 0 0 rgba(46,204,113,.6)}50%{box-shadow:0 0 8px 2px rgba(46,204,113,.4)}}
    .card-actions{position:absolute;top:12px;right:12px;display:flex;gap:6px;opacity:0;transition:opacity .3s;z-index:10;background:rgba(255,255,255,.95);padding:6px;border-radius:var(--radius-full);box-shadow:var(--shadow-sm)}.property-card:hover .card-actions{opacity:1}.card-action-btn{width:32px;height:32px;border-radius:50%;background:var(--white);color:var(--gray-600);display:flex;align-items:center;justify-content:center;font-size:13px;transition:all .3s;box-shadow:none;border:1px solid var(--gray-200)}.card-action-btn:hover{transform:scale(1.1)}.card-action-btn.edit:hover{background:#3498db;color:white;border-color:#3498db}.card-action-btn.delete:hover{background:var(--danger);color:white;border-color:var(--danger)}.card-action-btn.calendar:hover{background:var(--gold);color:white;border-color:var(--gold)}.btn-feature{width:32px;height:32px;border-radius:50%;background:var(--white);color:var(--gray-400);display:flex;align-items:center;justify-content:center;font-size:13px;transition:all .3s;border:1px solid var(--gray-200);cursor:pointer}.btn-feature:hover{background:#f1c40f;color:white;transform:scale(1.1);border-color:#f1c40f}.btn-feature.active{background:linear-gradient(135deg,#f1c40f,#f39c12);color:white;border-color:#f1c40f}
    .card-owner{position:absolute;bottom:12px;left:12px;display:flex;align-items:center;gap:8px;padding:6px 12px;background:rgba(0,0,0,.6);backdrop-filter:blur(10px);border-radius:var(--radius-full);color:var(--white);font-size:12px;cursor:pointer;transition:all .3s;z-index:6}.card-owner:hover{background:rgba(0,0,0,.8)}.card-owner img{width:24px;height:24px;border-radius:50%;object-fit:cover}.card-owner-initial{width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--gold));display:flex;align-items:center;justify-content:center;font-weight:600;font-size:11px}
    .card-content{padding:20px}.card-price{font-family:'Playfair Display',serif;font-size:26px;font-weight:700;color:var(--accent);margin-bottom:8px}.card-price span{font-size:14px;color:var(--gray-500);font-weight:400}.card-price .price-drop-badge{font-size:11px;color:#fff!important;font-weight:700}.card-price-old{font-size:16px;color:var(--gray-400);text-decoration:line-through;margin-right:10px;font-weight:400}.card-price-reduced{display:flex;align-items:center;gap:8px;flex-wrap:wrap}.price-drop-badge{background:var(--success);color:#fff;padding:4px 10px;border-radius:var(--radius-full);font-size:12px;font-weight:700;text-shadow:0 1px 2px rgba(0,0,0,.3)}
    .card-title{font-size:18px;font-weight:600;color:var(--primary);margin-bottom:8px}.card-location{display:flex;align-items:center;gap:6px;color:var(--gray-500);font-size:14px;margin-bottom:16px}.card-location i{color:var(--accent)}.card-features{display:flex;gap:16px;padding-top:16px;border-top:1px solid var(--gray-100);flex-wrap:wrap}.card-feature{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--gray-600)}.card-feature i{color:var(--gray-400)}.card-footer{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:var(--gray-50);border-top:1px solid var(--gray-100)}.card-views{font-size:13px;color:var(--gray-500)}.btn-share{display:flex;align-items:center;justify-content:center;width:38px;height:38px;background:var(--gray-200);color:var(--gray-600);border-radius:var(--radius-md);font-size:14px;transition:all .3s}.btn-share:hover{background:var(--primary);color:var(--white);transform:scale(1.05)}.btn-whatsapp{display:flex;align-items:center;gap:8px;padding:10px 18px;background:#25D366;color:var(--white);border-radius:var(--radius-md);font-size:13px;font-weight:600;transition:all .3s}.btn-whatsapp:hover{background:#128C7E;transform:scale(1.05)}.btn-instagram{display:flex;align-items:center;gap:8px;padding:10px 14px;background:linear-gradient(45deg,#f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%);color:var(--white);border-radius:var(--radius-md);font-size:13px;font-weight:600;transition:all .3s}.btn-instagram:hover{transform:scale(1.05);filter:brightness(1.1)}.share-modal .modal-content{max-width:400px}.share-options{display:flex;flex-direction:column;gap:12px}.share-option{display:flex;align-items:center;gap:12px;padding:16px;background:var(--gray-50);border-radius:var(--radius-md);cursor:pointer;transition:all .2s}.share-option:hover{background:var(--gray-100);transform:translateX(4px)}.share-option i{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;color:white}.share-option.whatsapp i{background:#25D366}.share-option.facebook i{background:#1877F2}.share-option.twitter i{background:#1DA1F2}.share-option.copy i{background:var(--primary)}.share-option span{font-weight:500;color:var(--gray-700)}.share-url{display:flex;gap:8px;margin-top:16px;padding:12px;background:var(--gray-100);border-radius:var(--radius-md)}.share-url input{flex:1;background:none;border:none;font-size:13px;color:var(--gray-600)}.share-url button{padding:8px 16px;background:var(--accent);color:white;border-radius:var(--radius-sm);font-size:12px;font-weight:600}
    .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);z-index:1000;align-items:center;justify-content:center;padding:20px;overflow-y:auto}.modal.active{display:flex}.modal-content{background:var(--white);border-radius:var(--radius-xl);max-width:500px;width:100%;max-height:90vh;overflow-y:auto;animation:slideIn .3s ease;margin:auto}@keyframes slideIn{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}.modal-header{display:flex;justify-content:space-between;align-items:center;padding:24px;border-bottom:1px solid var(--gray-100)}.modal-header h2{font-size:24px}.modal-close{width:40px;height:40px;border-radius:50%;background:var(--gray-100);display:flex;align-items:center;justify-content:center;font-size:18px;color:var(--gray-600);transition:all .3s}.modal-close:hover{background:var(--gray-200)}.modal-body{padding:24px}
    .form-group{margin-bottom:20px}.form-group label{display:block;font-weight:600;margin-bottom:8px;color:var(--gray-700)}.form-group input,.form-group select,.form-group textarea{width:100%;padding:14px 16px;border:2px solid var(--gray-200);border-radius:var(--radius-md);font-size:15px;transition:all .3s;font-family:inherit}.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--accent);outline:none}.form-group small{display:block;margin-top:6px;color:var(--gray-500);font-size:12px}.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}.form-row-3{display:grid;grid-template-columns:2fr 1fr;gap:16px}.form-row-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:16px;align-items:start}.form-row-4 .form-group label{min-height:38px;display:flex;align-items:flex-end;line-height:1.3}.form-error{background:rgba(231,76,60,.1);color:var(--danger);padding:12px 16px;border-radius:var(--radius-md);margin-bottom:20px;font-size:14px}.form-success{background:rgba(46,204,113,.1);color:var(--success);padding:12px 16px;border-radius:var(--radius-md);margin-bottom:20px;font-size:14px}.btn-submit{width:100%;padding:14px;background:linear-gradient(135deg,var(--accent),var(--gold));color:var(--white);border-radius:var(--radius-md);font-size:16px;font-weight:600;transition:all .3s;display:flex;align-items:center;justify-content:center;gap:8px}.btn-submit:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}.btn-submit:disabled{opacity:.6;cursor:not-allowed;transform:none}.modal-footer{padding:16px 24px;border-top:1px solid var(--gray-100);text-align:center;color:var(--gray-500);font-size:14px}.modal-footer a{color:var(--accent);font-weight:600;cursor:pointer}
    .checkbox-group{display:flex;align-items:center;gap:10px;margin-bottom:20px}.checkbox-group input[type="checkbox"]{width:20px;height:20px;accent-color:var(--accent);cursor:pointer}.checkbox-group label{font-weight:500;color:var(--gray-600);cursor:pointer;margin-bottom:0}
    .image-upload-area{border:2px dashed var(--gray-300);border-radius:var(--radius-lg);padding:30px;text-align:center;cursor:pointer;transition:all .3s;background:var(--gray-50)}.image-upload-area:hover{border-color:var(--accent);background:rgba(233,69,96,.05)}.image-upload-area.dragover{border-color:var(--accent);background:rgba(233,69,96,.1)}.image-upload-area i{font-size:48px;color:var(--gray-400);margin-bottom:16px}.image-upload-area p{color:var(--gray-600);margin-bottom:8px}.image-upload-area small{color:var(--gray-400)}.image-preview-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:12px;margin-top:16px}.image-preview-item{position:relative;aspect-ratio:1;border-radius:var(--radius-md);overflow:hidden;box-shadow:var(--shadow-sm);cursor:grab;transition:all .2s;border:2px solid transparent}.image-preview-item:hover{border-color:var(--accent)}.image-preview-item img{width:100%;height:100%;object-fit:cover;pointer-events:none}.image-preview-item .remove-image{position:absolute;top:4px;right:4px;width:24px;height:24px;background:var(--danger);color:var(--white);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer;opacity:0;transition:all .3s}.image-preview-item:hover .remove-image{opacity:1}.image-preview-item.main::after{content:'Principal';position:absolute;bottom:0;left:0;right:0;background:var(--gold);color:var(--white);font-size:9px;padding:3px;text-align:center;font-weight:600}.image-preview-item .drag-handle{position:absolute;top:4px;left:4px;width:24px;height:24px;background:rgba(0,0,0,.5);color:var(--white);border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:10px;opacity:0;transition:all .3s}.image-preview-item:hover .drag-handle{opacity:1}
    .upload-progress{margin-top:16px}.upload-progress-bar{height:8px;background:var(--gray-200);border-radius:4px;overflow:hidden}.upload-progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--gold));transition:width .3s}.upload-progress-text{font-size:12px;color:var(--gray-500);margin-top:6px;text-align:center}
    .status-selector{display:flex;gap:8px;flex-wrap:wrap}.status-option{padding:10px 16px;border:2px solid var(--gray-200);border-radius:var(--radius-md);cursor:pointer;transition:all .3s;display:flex;align-items:center;gap:8px}.status-option:hover{border-color:var(--gray-400)}.status-option.active{border-color:var(--accent);background:rgba(233,69,96,.1)}.status-option.available.active{border-color:var(--success);background:rgba(46,204,113,.1)}.status-option.reserved.active{border-color:var(--reserved);background:rgba(155,89,182,.1)}.status-option.sold.active{border-color:var(--sold);background:rgba(231,76,60,.1)}.status-option.rented.active{border-color:#3498db;background:rgba(52,152,219,.1)}.status-option.archived.active{border-color:#7f8c8d;background:rgba(127,140,141,.1)}.status-option i{font-size:16px}.status-option.available i{color:var(--success)}.status-option.reserved i{color:var(--reserved)}.status-option.sold i{color:var(--sold)}.status-option.rented i{color:#3498db}.status-option.archived i{color:#7f8c8d}
    .calendar-modal .modal-content{max-width:900px}.calendar-container{display:grid;grid-template-columns:1fr 300px;gap:24px}.calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.calendar-nav{display:flex;gap:8px}.calendar-nav button{width:36px;height:36px;border-radius:50%;background:var(--gray-100);display:flex;align-items:center;justify-content:center;transition:all .3s}.calendar-nav button:hover{background:var(--accent);color:white}.calendar-month{font-size:20px;font-weight:600}.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}.calendar-day-header{text-align:center;font-size:12px;font-weight:600;color:var(--gray-500);padding:8px}.calendar-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:8px 4px;border-radius:var(--radius-sm);cursor:pointer;transition:all .2s;font-size:14px;position:relative}.calendar-day:hover{background:var(--gray-100)}.calendar-day.other-month{color:var(--gray-400)}.calendar-day.today{background:var(--accent);color:white;font-weight:600}.calendar-day.selected{background:var(--gold);color:white}.calendar-day.has-events::after{content:'';width:6px;height:6px;background:var(--accent);border-radius:50%;position:absolute;bottom:4px}.calendar-day.today.has-events::after{background:white}
    .calendar-sidebar{border-left:1px solid var(--gray-200);padding-left:24px}.calendar-sidebar h3{font-size:16px;margin-bottom:16px;display:flex;align-items:center;gap:8px}.calendar-sidebar h3 i{color:var(--accent)}.visit-item{background:var(--gray-50);padding:12px;border-radius:var(--radius-md);margin-bottom:12px;border-left:3px solid var(--accent)}.visit-item.upcoming{border-left-color:var(--gold)}.visit-item.event-type-meeting{border-left-color:#9b59b6}.visit-item.event-type-delivery{border-left-color:#3498db}.visit-item.event-type-review{border-left-color:#e67e22}.visit-item.event-type-other{border-left-color:#95a5a6}.visit-item h4{font-size:14px;font-weight:600;margin-bottom:4px;color:var(--primary)}.visit-item .event-type-badge{display:inline-block;font-size:10px;padding:2px 8px;border-radius:var(--radius-full);margin-bottom:6px;font-weight:600}.visit-item .event-type-badge.visit{background:rgba(233,69,96,.1);color:var(--accent)}.visit-item .event-type-badge.meeting{background:rgba(155,89,182,.1);color:#9b59b6}.visit-item .event-type-badge.delivery{background:rgba(52,152,219,.1);color:#3498db}.visit-item .event-type-badge.review{background:rgba(230,126,34,.1);color:#e67e22}.visit-item .event-type-badge.other{background:rgba(149,165,166,.1);color:#95a5a6}.visit-item p{font-size:12px;color:var(--gray-500);margin-bottom:4px}.visit-item .visit-time{display:flex;align-items:center;gap:6px;font-weight:500;color:var(--gray-700)}.visit-item .visit-actions{display:flex;gap:8px;margin-top:8px}.visit-item .visit-actions button{padding:6px 12px;font-size:12px;border-radius:var(--radius-sm)}.btn-add-visit{width:100%;padding:12px;background:var(--accent);color:white;border-radius:var(--radius-md);font-weight:600;margin-top:16px;display:flex;align-items:center;justify-content:center;gap:8px}.btn-add-visit:hover{background:var(--accent-hover)}.no-visits{text-align:center;padding:30px 10px;color:var(--gray-400)}.no-visits i{font-size:32px;margin-bottom:8px}
    .event-type-selector{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}.event-type-option{padding:10px 14px;border:2px solid var(--gray-200);border-radius:var(--radius-md);cursor:pointer;transition:all .3s;display:flex;align-items:center;gap:6px;font-size:13px}.event-type-option:hover{border-color:var(--gray-400)}.event-type-option.active{border-color:var(--accent);background:rgba(233,69,96,.1)}.event-type-option i{font-size:14px}
    .profile-header{background:linear-gradient(135deg,var(--primary),var(--secondary));padding:60px 0;color:var(--white);margin-bottom:40px}.profile-header-content{display:flex;align-items:center;gap:32px}.profile-avatar-container{position:relative}.profile-avatar{width:120px;height:120px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--gold));display:flex;align-items:center;justify-content:center;font-size:48px;font-weight:700;color:var(--white);border:4px solid rgba(255,255,255,.3);overflow:hidden;flex-shrink:0}.profile-avatar img{width:100%;height:100%;object-fit:cover}.profile-avatar-edit{position:absolute;bottom:0;right:0;width:40px;height:40px;border-radius:50%;background:var(--accent);color:var(--white);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;border:3px solid var(--white)}.profile-avatar-edit:hover{transform:scale(1.1)}.profile-info h1{color:var(--white);margin-bottom:8px}.profile-info p{opacity:.8;margin-bottom:16px}.profile-bio{opacity:.9;font-size:14px;max-width:400px;margin-bottom:12px}.profile-stats{display:flex;gap:32px}.profile-stat{text-align:center}.profile-stat-number{font-size:28px;font-weight:700;font-family:'Playfair Display',serif}.profile-stat-label{font-size:13px;opacity:.7}.profile-share{display:flex;gap:12px;margin-top:16px;flex-wrap:wrap}.btn-share{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;background:rgba(255,255,255,.2);color:var(--white);border-radius:var(--radius-full);font-size:14px;font-weight:500;transition:all .3s}.btn-share:hover{background:rgba(255,255,255,.3);transform:translateY(-2px)}.btn-share-whatsapp{background:#25D366}.btn-share-whatsapp:hover{background:#128C7E}.btn-share-edit{background:var(--gold)}.btn-share-edit:hover{background:#d4ad2b}.profile-social-links{display:flex;gap:12px;margin-top:16px;flex-wrap:wrap}.profile-social-link{width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;color:var(--white);font-size:18px;transition:all .3s}.profile-social-link:hover{background:rgba(255,255,255,.4);transform:scale(1.1)}.profile-social-link.whatsapp{background:#25D366}.profile-social-link.instagram{background:linear-gradient(45deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888)}.profile-social-link.facebook{background:#1877F2}.profile-social-link.linkedin{background:#0A66C2}.profile-social-link.twitter{background:#1DA1F2}.profile-social-link.tiktok{background:#000}.profile-social-link.youtube{background:#FF0000}
    .detail-modal .modal-content{max-width:800px}.detail-gallery{position:relative;height:400px;background:var(--gray-100)}.detail-gallery img{width:100%;height:100%;object-fit:cover}.detail-nav{position:absolute;top:50%;transform:translateY(-50%);width:50px;height:50px;background:rgba(255,255,255,.9);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;color:var(--primary);transition:all .3s;z-index:10}.detail-nav:hover{background:var(--white);transform:translateY(-50%) scale(1.1)}.detail-nav.prev{left:16px}.detail-nav.next{right:16px}.detail-status-overlay{position:absolute;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;z-index:5;pointer-events:none}.detail-status-overlay.reserved{background:rgba(155,89,182,.3)}.detail-status-overlay.sold{background:rgba(231,76,60,.4)}.detail-status-overlay.rented{background:rgba(52,152,219,.3)}.detail-status-overlay.archived{background:rgba(127,140,141,.4)}.detail-thumbnails{display:flex;gap:8px;padding:12px;overflow-x:auto;background:var(--gray-100)}.detail-thumb{width:60px;height:60px;border-radius:var(--radius-sm);overflow:hidden;cursor:pointer;opacity:.6;transition:all .3s;flex-shrink:0;border:2px solid transparent}.detail-thumb.active,.detail-thumb:hover{opacity:1;border-color:var(--accent)}.detail-thumb img{width:100%;height:100%;object-fit:cover}
    .detail-content{padding:32px}.detail-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:24px;flex-wrap:wrap;gap:16px}.detail-price{font-family:'Playfair Display',serif;font-size:36px;font-weight:700;color:var(--accent)}.detail-price-old{font-size:20px;color:var(--gray-400);text-decoration:line-through;margin-right:12px}.detail-price-container{display:flex;flex-direction:row;align-items:center;gap:12px;flex-wrap:wrap}.detail-price-drop{background:var(--success);color:#fff;padding:6px 14px;border-radius:var(--radius-full);font-size:13px;font-weight:700}.detail-owner{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--gray-50);border-radius:var(--radius-lg);cursor:pointer;transition:all .3s;margin-bottom:24px}.detail-owner:hover{background:var(--gray-100)}.detail-owner-avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--gold));display:flex;align-items:center;justify-content:center;color:var(--white);font-weight:600;overflow:hidden}.detail-owner-avatar img{width:100%;height:100%;object-fit:cover}.detail-owner-info{display:flex;align-items:center;gap:8px}.detail-owner-info strong{color:var(--primary)}.detail-owner-info small{color:var(--gray-500);margin-left:4px}.detail-features{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}.detail-feature{padding:16px;background:var(--gray-50);border-radius:var(--radius-md);text-align:center}.detail-feature i{font-size:24px;color:var(--accent);margin-bottom:8px;display:block}.detail-feature strong{display:block;font-size:18px;color:var(--primary)}.detail-feature span{font-size:12px;color:var(--gray-500)}.detail-description{margin-bottom:24px;color:var(--gray-600);line-height:1.8}.detail-actions{display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap}.detail-whatsapp{flex:1;min-width:200px;padding:16px;background:#25D366;color:var(--white);border-radius:var(--radius-md);font-size:16px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:10px;transition:all .3s}.detail-whatsapp:hover{background:#128C7E}.detail-instagram{padding:16px 24px;background:linear-gradient(45deg,#f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%);color:var(--white);border-radius:var(--radius-md);font-size:16px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:10px;transition:all .3s}.detail-instagram:hover{filter:brightness(1.1)}.detail-edit-btn{padding:16px 24px;background:#3498db;color:var(--white);border-radius:var(--radius-md);font-size:16px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:10px;transition:all .3s}.detail-edit-btn:hover{background:#2980b9}.detail-share{padding:16px 24px;background:var(--gray-200);color:var(--gray-700);border-radius:var(--radius-md);font-size:16px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:10px;transition:all .3s}.detail-share:hover{background:var(--primary);color:var(--white)}
    .comments-section{border-top:1px solid var(--gray-200);padding-top:24px;margin-top:24px}.comments-section h3{margin-bottom:20px;display:flex;align-items:center;gap:8px}.comment-form{display:flex;flex-direction:column;gap:12px;margin-bottom:24px}.comment-form-row{display:flex;gap:12px}.comment-form input{flex:1;padding:12px 16px;border:2px solid var(--gray-200);border-radius:var(--radius-full);font-size:14px}.comment-form input:focus{border-color:var(--accent);outline:none}.comment-form button{padding:12px 24px;background:var(--accent);color:var(--white);border-radius:var(--radius-full);font-weight:600;transition:all .3s;white-space:nowrap}.comment-form button:hover{background:var(--accent-hover)}.comment-form small{color:var(--gray-500);font-size:12px;display:flex;align-items:center;gap:6px}.comment-form small i{color:var(--gold)}.comment-item{display:flex;gap:12px;padding:16px 0;border-bottom:1px solid var(--gray-100)}.comment-avatar{width:40px;height:40px;border-radius:50%;background:var(--gray-200);display:flex;align-items:center;justify-content:center;color:var(--gray-500);font-weight:600;overflow:hidden;flex-shrink:0}.comment-avatar img{width:100%;height:100%;object-fit:cover}.comment-content{flex:1}.comment-header{display:flex;align-items:center;gap:8px;margin-bottom:4px;flex-wrap:wrap}.comment-author{font-weight:600;color:var(--primary)}.comment-guest-badge{font-size:10px;padding:2px 8px;background:var(--gray-200);border-radius:var(--radius-full);color:var(--gray-600)}.comment-time{font-size:12px;color:var(--gray-400)}.comment-text{color:var(--gray-600)}.comment-contact{display:flex;align-items:center;gap:6px;margin-top:8px;padding:8px 12px;background:rgba(37,211,102,.1);border-radius:var(--radius-md);font-size:13px}.comment-contact i{color:#25D366}.comment-contact a{color:#25D366;font-weight:600}.no-comments{text-align:center;padding:30px;color:var(--gray-400)}
    .admin-panel{padding:40px 0}.admin-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:32px;flex-wrap:wrap;gap:16px}.admin-tabs{display:flex;gap:8px;margin-bottom:24px;background:var(--white);padding:8px;border-radius:var(--radius-lg);flex-wrap:wrap}.admin-tab{padding:12px 24px;border-radius:var(--radius-md);font-weight:500;background:none;color:var(--gray-600);transition:all .3s}.admin-tab.active{background:var(--primary);color:var(--white)}.admin-tab:hover:not(.active){background:var(--gray-100)}.admin-content{background:var(--white);border-radius:var(--radius-xl);padding:24px;box-shadow:var(--shadow-md)}.user-card{display:flex;align-items:center;gap:20px;padding:20px;background:var(--gray-50);border-radius:var(--radius-lg);margin-bottom:16px;flex-wrap:wrap}.user-card-avatar{width:60px;height:60px;border-radius:50%;background:var(--gray-200);display:flex;align-items:center;justify-content:center;overflow:hidden;font-size:24px;color:var(--gray-400);flex-shrink:0}.user-card-avatar img{width:100%;height:100%;object-fit:cover}.user-card-info{flex:1;min-width:200px}.user-card-info h4{margin-bottom:4px}.user-card-info p{color:var(--gray-600);font-size:14px}.user-card-info small{color:var(--gray-400);font-size:12px}.user-card-actions{display:flex;gap:8px;flex-wrap:wrap}.btn-approve{padding:10px 18px;background:rgba(46,204,113,.1);color:var(--success);border-radius:var(--radius-md);font-weight:500;transition:all .3s}.btn-approve:hover{background:var(--success);color:var(--white)}.btn-reject{padding:10px 18px;background:rgba(231,76,60,.1);color:var(--danger);border-radius:var(--radius-md);font-weight:500;transition:all .3s}.btn-reject:hover{background:var(--danger);color:var(--white)}.btn-edit{padding:10px 18px;background:rgba(52,152,219,.1);color:#3498db;border-radius:var(--radius-md);font-weight:500;transition:all .3s}.btn-edit:hover{background:#3498db;color:var(--white)}.btn-feature-admin{padding:10px 18px;background:rgba(241,196,15,.1);color:#f1c40f;border-radius:var(--radius-md);font-weight:500;transition:all .3s;border:none;cursor:pointer}.btn-feature-admin:hover,.btn-feature-admin.active{background:linear-gradient(135deg,#f1c40f,#f39c12);color:var(--white)}.user-card.featured-admin{border:2px solid #f1c40f;background:linear-gradient(to right,rgba(241,196,15,.05),var(--gray-50))}.empty-state{text-align:center;padding:60px 20px;color:var(--gray-400)}.empty-state i{font-size:48px;margin-bottom:16px}.empty-state h3{color:var(--gray-600);margin-bottom:8px}
    .footer{background:var(--primary);color:var(--white);padding:40px 0 20px;margin-top:60px}.footer-content{display:flex;justify-content:space-between;align-items:center;padding-bottom:20px;border-bottom:1px solid rgba(255,255,255,.1)}.footer-logo{font-family:'Playfair Display',serif;font-size:20px}.footer-links{display:flex;gap:24px}.footer-links a{color:rgba(255,255,255,.7);transition:color .3s;font-size:20px}.footer-links a:hover{color:var(--gold)}.footer-bottom{text-align:center;padding-top:20px;color:rgba(255,255,255,.5);font-size:14px}
    .loading{display:flex;justify-content:center;padding:60px}.spinner{width:40px;height:40px;border:3px solid var(--gray-200);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}
    .toast-container{position:fixed;bottom:20px;right:20px;z-index:10000;display:flex;flex-direction:column;gap:10px}.toast{background:var(--white);padding:16px 20px;border-radius:var(--radius-lg);box-shadow:var(--shadow-lg);display:flex;align-items:center;gap:12px;animation:toastIn .3s ease;max-width:350px}@keyframes toastIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}.toast.hiding{animation:toastOut .3s ease forwards}@keyframes toastOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}.toast-icon{width:40px;height:40px;border-radius:50%;background:rgba(233,69,96,.1);display:flex;align-items:center;justify-content:center;color:var(--accent);flex-shrink:0}.toast-content{flex:1}.toast-content strong{display:block;color:var(--primary);margin-bottom:2px}.toast-content p{font-size:13px;color:var(--gray-600);margin:0}
    @media(max-width:968px){.detail-features{grid-template-columns:repeat(2,1fr)}.profile-header-content{flex-direction:column;text-align:center}.profile-stats{justify-content:center}.profile-share{justify-content:center}.profile-social-links{justify-content:center}.notification-dropdown{width:340px;right:0}.calendar-container{grid-template-columns:1fr}.calendar-sidebar{border-left:none;border-top:1px solid var(--gray-200);padding-left:0;padding-top:24px}.properties-grid{grid-template-columns:repeat(2,1fr)}.card-actions{opacity:1}}
    @media(max-width:768px){.nav{width:100%;justify-content:center;gap:8px;flex-wrap:wrap}.nav a{padding:8px 12px;font-size:13px}.hero h1{font-size:26px;line-height:1.2}.hero p{font-size:15px;padding:0 10px}.hero-btn{padding:12px 20px;font-size:15px;width:100%;justify-content:center}.filters-row{grid-template-columns:1fr;gap:12px}.properties-grid{grid-template-columns:1fr;gap:16px}.property-card{max-width:100%}.card-image{height:220px}.card-badges{gap:6px;flex-wrap:wrap}.badge{padding:4px 10px;font-size:10px}.card-content{padding:16px}.card-price{font-size:22px}.card-title{font-size:15px}.card-features{gap:8px;flex-wrap:wrap}.card-feature{font-size:12px}.card-actions{opacity:1;top:8px;right:8px;padding:4px;gap:4px}.card-action-btn,.btn-feature{width:28px;height:28px;font-size:11px}.form-row,.form-row-3,.form-row-4{grid-template-columns:1fr}.section-header{flex-direction:column;align-items:stretch;gap:12px}.section-header h2{font-size:20px;text-align:center}.btn-new-property{width:100%;justify-content:center}.footer-content{flex-direction:column;gap:20px;text-align:center}.user-info{gap:8px}.user-info span:not(.admin-badge){display:none}.user-dropdown{right:0;left:auto;transform:none;width:200px;max-width:calc(100vw - 20px)}.header-left{gap:12px}.logo{font-size:20px}.detail-modal .modal-content{width:100%;max-width:100%;margin:0;border-radius:0;max-height:100vh}.detail-gallery{height:250px}.detail-header{flex-direction:column;gap:12px}.detail-price{font-size:28px}.detail-price-container{width:100%}.detail-actions{flex-direction:column}.detail-features{grid-template-columns:repeat(2,1fr);gap:12px}.detail-feature{padding:12px}.profile-avatar{width:90px;height:90px;font-size:32px}.profile-name{font-size:24px}.profile-stats{gap:20px}.comment-form-row{flex-direction:column}.notification-dropdown{position:fixed!important;top:70px!important;left:10px!important;right:10px!important;width:auto!important;max-width:none!important;transform:none!important;max-height:calc(100vh - 90px);z-index:9999}.notification-list{max-height:calc(100vh - 160px)}.event-type-selector{flex-direction:column;gap:8px}.event-type-option{justify-content:center;padding:10px}.calendar-grid{gap:4px}.calendar-day{padding:8px 4px;font-size:13px}.modal-content{width:95%;margin:10px auto;max-height:90vh}.modal-body{padding:16px;max-height:calc(90vh - 120px)}.admin-tabs{flex-wrap:wrap;gap:8px}.admin-tab{padding:10px 16px;font-size:13px;flex:1 1 auto;text-align:center}}
    @media(max-width:480px){.hero h1{font-size:22px}.hero p{font-size:14px}.card-image{height:200px}.card-price{font-size:20px}.card-title{font-size:14px}.card-footer{flex-direction:column;gap:10px;align-items:stretch}.btn-whatsapp{width:100%;justify-content:center}.detail-price{font-size:24px}.detail-features{grid-template-columns:1fr 1fr}.profile-stats{flex-direction:column;gap:16px}.calendar-day-header{font-size:11px}.visit-item{padding:12px}.admin-table{font-size:12px}.admin-table td,.admin-table th{padding:8px 6px}.user-dropdown{width:180px;right:0}}
  </style>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>
  <header class="header"><div class="container"><div class="header-content">
    <div class="logo" onclick="showHome()"><i class="fas fa-building"></i>Mi Cartera Inmobiliaria</div>
    <nav class="nav" id="nav-guest"><a href="#" onclick="showHome()">Inicio</a><a href="#propiedades">Propiedades</a><button class="btn-secondary" onclick="openModal('registerModal')">Registrarse</button><button class="btn-primary" onclick="openModal('loginModal')">Iniciar Sesión</button></nav>
    <nav class="nav hidden" id="nav-user"><a href="#" onclick="showHome()">Inicio</a><a href="#propiedades">Propiedades</a>
      <div class="calendar-btn" id="calendarBtn" onclick="openCalendarModal()" title="Mi Agenda"><i class="fas fa-calendar-alt"></i></div>
      <div class="notification-bell" id="notificationBell" onclick="toggleNotifications(event)"><i class="fas fa-bell"></i><span class="notification-badge hidden" id="notificationBadge">0</span></div>
      <div class="notification-overlay" id="notificationOverlay" onclick="closeNotifications()"></div>
      <div class="notification-dropdown" id="notificationDropdown"><div class="notification-header"><h3><i class="fas fa-comments"></i> Consultas</h3><div class="notification-actions"><button onclick="markAllAsRead(event)"><i class="fas fa-check-double"></i> Leídas</button><button class="btn-clear" onclick="clearAllNotifications(event)"><i class="fas fa-trash"></i> Limpiar</button></div></div><div class="notification-list" id="notificationList"><div class="notification-empty"><i class="fas fa-bell-slash"></i><p>No tienes consultas</p></div></div></div>
      <div class="user-info" onclick="toggleUserDropdown(event)">
        <div class="user-avatar" id="userAvatar"><i class="fas fa-user"></i></div>
        <span id="userName">Usuario</span>
        <span class="admin-badge hidden" id="adminBadge">Admin</span>
        <div class="user-dropdown" id="userDropdown">
          <div class="user-dropdown-item" onclick="showMyProfile()"><i class="fas fa-user"></i> Mi Perfil</div>
          <div class="user-dropdown-item" onclick="openEditProfileModal()"><i class="fas fa-edit"></i> Editar Perfil</div>
          <div class="user-dropdown-item" onclick="openCalendarModal()"><i class="fas fa-calendar-alt"></i> Mi Agenda</div>
          <div class="user-dropdown-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</div>
        </div>
      </div>
      <button class="btn-primary hidden" id="adminBtn" onclick="showAdmin()">Panel Admin</button>
    </nav>
  </div></div></header>

  <main id="mainContent">
    <section class="hero"><div class="container">
      <h1>Encuentra la propiedad<br><span>de tus sueños</span></h1>
      <p>Explora nuestra amplia selección de propiedades en venta y alquiler en Uruguay.</p>
      <div class="hero-buttons" id="heroButtons"><button class="hero-btn hero-btn-primary" onclick="openModal('registerModal')"><i class="fas fa-user-plus"></i> Crear Cuenta</button><button class="hero-btn hero-btn-secondary" onclick="openModal('loginModal')"><i class="fas fa-sign-in-alt"></i> Iniciar Sesión</button></div>
      <div class="hero-stats"><div class="hero-stat"><div class="hero-stat-number" id="statTotal">0</div><div class="hero-stat-label">Propiedades</div></div><div class="hero-stat"><div class="hero-stat-number" id="statSale">0</div><div class="hero-stat-label">En Venta</div></div><div class="hero-stat"><div class="hero-stat-number" id="statRent">0</div><div class="hero-stat-label">En Alquiler</div></div></div>
    </div></section>
    <section class="container"><div class="filters"><div class="filters-row">
      <div class="filter-group"><label>Buscar</label><input type="text" id="filterSearch" placeholder="Ubicación, nombre..."></div>
      <div class="filter-group"><label>Tipo</label><select id="filterType"><option value="">Todos</option><option value="sale">Venta</option><option value="rent">Alquiler</option></select></div>
      <div class="filter-group"><label>Habitaciones</label><select id="filterBedrooms"><option value="">Todas</option><option value="1">1+</option><option value="2">2+</option><option value="3">3+</option><option value="4">4+</option></select></div>
      <div class="filter-group"><label>Precio máx.</label><input type="number" id="filterPrice" placeholder="Precio"></div>
      <button class="filter-btn" onclick="filterProperties()"><i class="fas fa-search"></i> Buscar</button>
    </div></div></section>
    <section class="container" id="propiedades">
      <div class="section-header"><div><h2 class="section-title">Propiedades Disponibles</h2><p class="section-subtitle" id="propertiesCount">Cargando...</p></div><button class="btn-new-property hidden" id="btnNewProperty" onclick="openPropertyModal()"><i class="fas fa-plus"></i><span>Nueva Propiedad</span></button></div>
      <div id="propertiesLoading" class="loading"><div class="spinner"></div></div>
      <div class="properties-grid" id="propertiesGrid"></div>
    </section>
  </main>

  <main id="profilePage" class="hidden">
    <div class="profile-header"><div class="container"><div class="profile-header-content">
      <div class="profile-avatar-container"><div class="profile-avatar" id="profileAvatar">U</div><div class="profile-avatar-edit hidden" id="profileAvatarEdit" onclick="document.getElementById('profilePhotoInput').click()"><i class="fas fa-camera"></i></div><input type="file" id="profilePhotoInput" accept="image/*" style="display:none" onchange="handleProfilePhotoChange(event)"></div>
      <div class="profile-info"><h1 id="profileName">Usuario</h1><p id="profileEmail">email@ejemplo.com</p><p class="profile-bio" id="profileBio"></p><div class="profile-stats"><div class="profile-stat"><div class="profile-stat-number" id="profilePropertiesCount">0</div><div class="profile-stat-label">Propiedades</div></div><div class="profile-stat"><div class="profile-stat-number" id="profileViewsCount">0</div><div class="profile-stat-label">Vistas totales</div></div></div>
      <div class="profile-social-links" id="profileSocialLinks"></div>
      <div class="profile-share"><button class="btn-share" onclick="copyProfileLink()"><i class="fas fa-link"></i> Copiar enlace</button><button class="btn-share btn-share-whatsapp" onclick="shareProfileWhatsapp()"><i class="fab fa-whatsapp"></i> WhatsApp</button><button class="btn-share btn-share-edit hidden" id="btnEditProfile" onclick="openEditProfileModal()"><i class="fas fa-edit"></i> Editar Perfil</button></div></div>
    </div></div></div>
    <div class="container"><div class="section-header"><div><h2 class="section-title">Propiedades de <span id="profileNameTitle">Usuario</span></h2><p class="section-subtitle" id="profilePropertiesSubtitle">0 propiedades</p></div><button class="btn-new-property hidden" id="btnNewPropertyProfile" onclick="openPropertyModal()"><i class="fas fa-plus"></i><span>Nueva Propiedad</span></button></div><div class="properties-grid" id="profilePropertiesGrid"></div><div style="text-align:center;margin-top:20px"><button class="btn-secondary" onclick="showHome()" style="padding:12px 24px"><i class="fas fa-arrow-left"></i> Volver al inicio</button></div></div>
  </main>

  <main id="adminPanel" class="hidden"><section class="admin-panel container">
    <div class="admin-header"><div><h1>Panel de Administración</h1><p style="color:var(--gray-500)">Gestiona usuarios y propiedades</p></div><button class="btn-new-property" onclick="openPropertyModal()"><i class="fas fa-plus"></i><span>Nueva Propiedad</span></button></div>
    <div class="admin-tabs"><button class="admin-tab active" onclick="showAdminTab('pending')" id="tabPending"><i class="fas fa-clock"></i> Pendientes <span id="pendingCount"></span></button><button class="admin-tab" onclick="showAdminTab('users')" id="tabUsers"><i class="fas fa-users"></i> Usuarios</button><button class="admin-tab" onclick="showAdminTab('properties')" id="tabProperties"><i class="fas fa-building"></i> Propiedades</button></div>
    <div class="admin-content" id="adminContent"></div><button style="margin-top:24px" class="btn-secondary" onclick="showHome()"><i class="fas fa-arrow-left"></i> Volver</button>
  </section></main>

  <footer class="footer"><div class="container"><div class="footer-content"><div class="footer-logo"><i class="fas fa-building"></i> Mi Cartera Inmobiliaria</div><div class="footer-links"><a href="https://www.instagram.com/" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a><a href="https://wa.me/59899000000" target="_blank" title="WhatsApp"><i class="fab fa-whatsapp"></i></a></div></div><div class="footer-bottom">Página creada por Anibal Malave © 2026</div></div></footer>

  <!-- Modals -->
  <div class="modal" id="loginModal"><div class="modal-content"><div class="modal-header"><h2>Iniciar Sesión</h2><button class="modal-close" onclick="closeModal('loginModal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><div id="loginError" class="form-error hidden"></div><form onsubmit="handleLogin(event)"><div class="form-group"><label>Correo Electrónico</label><input type="email" id="loginEmail" required placeholder="tu@email.com"></div><div class="form-group"><label>Contraseña</label><input type="password" id="loginPassword" required placeholder="••••••••"></div><div class="checkbox-group"><input type="checkbox" id="rememberMe"><label for="rememberMe">Recordar mi usuario</label></div><button type="submit" class="btn-submit" id="loginBtn">Iniciar Sesión</button></form></div><div class="modal-footer">¿No tienes cuenta? <a onclick="switchModal('loginModal','registerModal')">Regístrate aquí</a></div></div></div>

  <div class="modal" id="registerModal"><div class="modal-content"><div class="modal-header"><h2>Crear Cuenta</h2><button class="modal-close" onclick="closeModal('registerModal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><div id="registerError" class="form-error hidden"></div><div id="registerSuccess" class="form-success hidden"></div><form onsubmit="handleRegister(event)" id="registerForm"><div class="form-group"><label>Nombre Completo *</label><input type="text" id="registerName" required placeholder="Tu nombre"></div><div class="form-group"><label>Correo Electrónico *</label><input type="email" id="registerEmail" required placeholder="tu@email.com"></div><div class="form-group"><label>WhatsApp *</label><input type="tel" id="registerWhatsapp" required placeholder="+598 99 123 456"></div><div class="form-group"><label>Instagram (opcional)</label><input type="url" id="registerInstagram" placeholder="https://instagram.com/tu_usuario"><small>Ingresa el link completo de tu perfil</small></div><div class="form-row"><div class="form-group"><label>Contraseña *</label><input type="password" id="registerPassword" required minlength="6" placeholder="Mínimo 6 caracteres"></div><div class="form-group"><label>Confirmar *</label><input type="password" id="registerConfirm" required placeholder="Repetir"></div></div><p style="font-size:13px;color:var(--gray-500);margin-bottom:20px;padding:12px;background:rgba(201,162,39,.1);border-radius:8px"><i class="fas fa-info-circle" style="color:var(--gold)"></i> Tu cuenta quedará <strong>pendiente</strong> hasta que el administrador la apruebe.</p><button type="submit" class="btn-submit" id="registerBtn">Crear Cuenta</button></form></div><div class="modal-footer">¿Ya tienes cuenta? <a onclick="switchModal('registerModal','loginModal')">Inicia sesión</a></div></div></div>

  <div class="modal detail-modal" id="detailModal"><div class="modal-content">
    <div class="detail-gallery"><img id="detailImage" src="" alt=""><button class="detail-nav prev" onclick="prevDetailImage()"><i class="fas fa-chevron-left"></i></button><button class="detail-nav next" onclick="nextDetailImage()"><i class="fas fa-chevron-right"></i></button><div class="card-badges" id="detailBadges" style="z-index:10"></div><div class="detail-status-overlay hidden" id="detailStatusOverlay"><div class="status-ribbon" id="detailStatusRibbon"></div></div></div>
    <div class="detail-thumbnails" id="detailThumbnails"></div>
    <div class="detail-content">
      <div class="detail-header"><div><h2 id="detailTitle"></h2><p style="color:var(--gray-500)"><i class="fas fa-map-marker-alt" style="color:var(--accent)"></i> <span id="detailLocation"></span></p></div><div class="detail-price-container"><span class="detail-price-old hidden" id="detailPriceOld"></span><span class="detail-price" id="detailPrice"></span><span class="detail-price-drop hidden" id="detailPriceDrop"></span></div></div>
      <div class="detail-owner" onclick="viewOwnerProfile()"><div class="detail-owner-avatar" id="detailOwnerAvatar">U</div><div class="detail-owner-info"><strong id="detailOwnerName">Usuario</strong><span style="color:var(--gray-300);margin:0 6px">|</span><small>Ver perfil</small></div></div>
      <div class="detail-features" id="detailFeatures"></div>
      <p class="detail-description" id="detailDescription"></p>
      <div class="detail-actions"><button class="detail-share" onclick="openShareModal(currentDetailProperty?.id)"><i class="fas fa-share-alt"></i> Compartir</button><button class="detail-whatsapp" id="detailWhatsapp"><i class="fab fa-whatsapp"></i> Contactar por WhatsApp</button><button class="detail-instagram hidden" id="detailInstagram"><i class="fab fa-instagram"></i> Instagram</button><button class="detail-edit-btn hidden" id="detailEditBtn" onclick="editCurrentProperty()"><i class="fas fa-edit"></i> Editar</button></div>
      <div class="comments-section"><h3><i class="fas fa-comments"></i> Consultas</h3><div class="comment-form" id="commentFormGuest"><div class="comment-form-row"><input type="text" id="guestName" placeholder="Tu nombre *"><input type="tel" id="guestPhone" placeholder="Tu WhatsApp *"></div><small><i class="fas fa-lock"></i> Tu número solo será visible para el dueño de la propiedad</small><div class="comment-form-row"><input type="text" id="commentInput" placeholder="Escribe tu consulta..."><button onclick="addComment()">Enviar</button></div></div><div class="comment-form hidden" id="commentFormUser"><div class="comment-form-row"><input type="text" id="commentInputUser" placeholder="Escribe tu consulta..."><button onclick="addComment()">Enviar</button></div></div><div id="commentsList"></div></div>
    </div>
    <button class="modal-close" style="position:absolute;top:16px;right:16px;background:rgba(0,0,0,.5);color:white;z-index:20" onclick="closeModal('detailModal')"><i class="fas fa-times"></i></button>
  </div></div>

  <div class="modal" id="propertyModal"><div class="modal-content" style="max-width:700px"><div class="modal-header"><h2 id="propertyModalTitle">Nueva Propiedad</h2><button class="modal-close" onclick="closeModal('propertyModal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><div id="propertyError" class="form-error hidden"></div>
    <form onsubmit="handleSaveProperty(event)" id="propertyForm">
      <input type="hidden" id="editingPropertyId" value=""><input type="hidden" id="previousPrice" value="">
      <div class="form-group"><label>Título *</label><input type="text" id="propTitle" required placeholder="Ej: Apartamento moderno"></div>
      <div class="form-row"><div class="form-group"><label>Departamento *</label><select id="propDepartamento" required onchange="updateCiudades()"><option value="">Seleccionar...</option></select></div><div class="form-group"><label>Ciudad/Barrio *</label><select id="propCiudad" required><option value="">Primero selecciona departamento</option></select></div></div>
      <div class="form-group"><label>Dirección (opcional)</label><input type="text" id="propDireccion" placeholder="Ej: Av. 18 de Julio 1234"></div>
      <div class="form-row-3"><div class="form-group"><label>Precio *</label><input type="number" id="propPrice" required placeholder="150000"></div><div class="form-group"><label>Moneda</label><select id="propCurrency"><option value="USD">USD</option><option value="UYU">UYU</option></select></div></div>
      <div class="form-row"><div class="form-group"><label>Tipo de Operación</label><select id="propType" onchange="togglePropertyType()"><option value="sale">Venta</option><option value="rent">Alquiler</option></select></div><div class="form-group" id="propertyTypeGroup"><label>Tipo de Propiedad</label><select id="propPropertyType"><option value="common">Padrón Común</option><option value="ph">PH</option></select></div></div>
      <div class="form-row-4"><div class="form-group"><label>Habitaciones</label><input type="number" id="propBedrooms" placeholder="3" min="0"></div><div class="form-group"><label>Baños</label><input type="number" id="propBathrooms" placeholder="2" min="0"></div><div class="form-group"><label>Área Total m² *</label><input type="number" id="propTotalArea" required placeholder="100"></div><div class="form-group"><label>Área Edificada m² *</label><input type="number" id="propBuiltArea" required placeholder="80"></div></div>
      <div class="form-row"><div class="form-group"><label>Gastos Comunes</label><input type="number" id="propExpenses" placeholder="150"></div><div class="form-group"><label>¿Tiene Garaje?</label><select id="propGarage"><option value="no">No</option><option value="yes">Sí</option></select></div></div>
      <div class="form-group"><label>Estado de la Propiedad</label><div class="status-selector" id="statusSelector"><div class="status-option available active" onclick="selectStatus('available')"><i class="fas fa-check-circle"></i> Disponible</div><div class="status-option reserved" onclick="selectStatus('reserved')"><i class="fas fa-clock"></i> Reservada</div><div class="status-option sold" onclick="selectStatus('sold')"><i class="fas fa-handshake"></i> Vendida</div><div class="status-option rented" onclick="selectStatus('rented')"><i class="fas fa-key"></i> Alquilada</div><div class="status-option archived" onclick="selectStatus('archived')"><i class="fas fa-archive"></i> Archivada</div></div><input type="hidden" id="propStatus" value="available"></div>
      <div class="form-group"><label>Fotos * <small style="color:var(--gray-500);font-weight:normal">(arrastra para reordenar, máx 5MB cada una)</small></label><div class="image-upload-area" id="imageUploadArea" onclick="document.getElementById('imageInput').click()"><i class="fas fa-cloud-upload-alt"></i><p>Haz clic o arrastra imágenes</p><small>JPG, PNG, WebP - Máximo 5MB por imagen</small></div><input type="file" id="imageInput" multiple accept="image/*" style="display:none" onchange="handleImageSelect(event)"><div class="image-preview-grid" id="imagePreviewGrid"></div><div class="upload-progress hidden" id="uploadProgress"><div class="upload-progress-bar"><div class="upload-progress-fill" id="uploadProgressFill"></div></div><div class="upload-progress-text" id="uploadProgressText">Subiendo imágenes...</div></div></div>
      <div class="form-group"><label>Descripción</label><textarea id="propDescription" rows="3" placeholder="Describe la propiedad..."></textarea></div>
      <div class="form-group"><label>WhatsApp de Contacto</label><input type="tel" id="propWhatsapp" placeholder="+598 99 123 456"></div>
      <button type="submit" class="btn-submit" id="propertyBtn"><i class="fas fa-check"></i> Publicar Propiedad</button>
    </form>
  </div></div></div>

  <div class="modal calendar-modal" id="calendarModal"><div class="modal-content"><div class="modal-header"><h2><i class="fas fa-calendar-alt" style="color:var(--gold)"></i> Mi Agenda</h2><button class="modal-close" onclick="closeModal('calendarModal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><div class="calendar-container"><div class="calendar-main"><div class="calendar-header"><div class="calendar-nav"><button onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button><button onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button></div><div class="calendar-month" id="calendarMonth">Enero 2026</div></div><div class="calendar-grid" id="calendarGrid"></div></div><div class="calendar-sidebar"><h3><i class="fas fa-list"></i> <span id="selectedDateTitle">Eventos del día</span></h3><div id="visitsList"><div class="no-visits"><i class="fas fa-calendar-check"></i><p>No hay eventos programados</p></div></div><button class="btn-add-visit" onclick="openVisitModal()"><i class="fas fa-plus"></i> Nuevo Evento</button></div></div></div></div></div>

  <div class="modal" id="visitModal"><div class="modal-content" style="max-width:500px"><div class="modal-header"><h2 id="visitModalTitle">Nuevo Evento</h2><button class="modal-close" onclick="closeModal('visitModal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><form onsubmit="handleSaveVisit(event)" id="visitForm"><input type="hidden" id="editingVisitId" value="">
    <div class="form-group"><label>Tipo de Evento *</label>
      <div class="event-type-selector" id="eventTypeSelector">
        <div class="event-type-option active" data-type="visit" onclick="selectEventType('visit')"><i class="fas fa-home"></i> Visita</div>
        <div class="event-type-option" data-type="meeting" onclick="selectEventType('meeting')"><i class="fas fa-users"></i> Reunión</div>
        <div class="event-type-option" data-type="delivery" onclick="selectEventType('delivery')"><i class="fas fa-truck"></i> Entrega</div>
        <div class="event-type-option" data-type="review" onclick="selectEventType('review')"><i class="fas fa-clipboard-check"></i> Revisión</div>
        <div class="event-type-option" data-type="other" onclick="selectEventType('other')"><i class="fas fa-ellipsis-h"></i> Otro</div>
      </div>
      <input type="hidden" id="eventType" value="visit">
    </div>
    <div class="form-group" id="visitPropertyGroup"><label>Propiedad (opcional)</label><select id="visitProperty"><option value="">-- Sin propiedad asociada --</option></select><small>Puedes dejar sin seleccionar si el evento no está relacionado con una propiedad</small></div>
    <div class="form-group"><label>Título / Descripción *</label><input type="text" id="visitTitle" required placeholder="Ej: Visita con Juan, Reunión con propietario..."></div>
    <div class="form-group"><label>Persona de Contacto</label><input type="text" id="visitClient" placeholder="Nombre del cliente/contacto"></div>
    <div class="form-group"><label>Teléfono de Contacto</label><input type="tel" id="visitPhone" placeholder="+598 99 123 456"></div>
    <div class="form-row"><div class="form-group"><label>Fecha *</label><input type="date" id="visitDate" required></div><div class="form-group"><label>Hora *</label><input type="time" id="visitTime" required></div></div>
    <div class="form-group"><label>Recordatorios</label><div class="checkbox-group"><input type="checkbox" id="reminder24h" checked><label for="reminder24h">24 horas antes</label></div><div class="checkbox-group"><input type="checkbox" id="reminder2h" checked><label for="reminder2h">2 horas antes</label></div></div>
    <div class="form-group"><label>Notas Adicionales</label><textarea id="visitNotes" rows="2" placeholder="Notas adicionales..."></textarea></div>
    <button type="submit" class="btn-submit"><i class="fas fa-calendar-check"></i> Guardar Evento</button>
  </form></div></div></div>

  <!-- Modal de Edición de Perfil -->
  <div class="modal" id="editProfileModal"><div class="modal-content" style="max-width:550px"><div class="modal-header"><h2><i class="fas fa-user-edit" style="color:var(--gold)"></i> Editar Perfil</h2><button class="modal-close" onclick="closeModal('editProfileModal')"><i class="fas fa-times"></i></button></div><div class="modal-body">
    <div id="editProfileError" class="form-error hidden"></div>
    <div id="editProfileSuccess" class="form-success hidden"></div>
    <form onsubmit="handleSaveProfile(event)" id="editProfileForm">
      <div class="form-group"><label>Nombre Completo *</label><input type="text" id="editName" required placeholder="Tu nombre"></div>
      <div class="form-group"><label>Bio / Descripción</label><textarea id="editBio" rows="2" placeholder="Cuéntanos sobre ti..."></textarea><small>Esta descripción aparecerá en tu perfil público</small></div>
      <div class="form-group"><label><i class="fab fa-whatsapp" style="color:#25D366"></i> WhatsApp *</label><input type="tel" id="editWhatsapp" required placeholder="+598 99 123 456"></div>
      <div class="form-group"><label><i class="fab fa-instagram" style="color:#E4405F"></i> Instagram</label><input type="url" id="editInstagram" placeholder="https://instagram.com/tu_usuario"></div>
      <div class="form-group"><label><i class="fab fa-facebook" style="color:#1877F2"></i> Facebook</label><input type="url" id="editFacebook" placeholder="https://facebook.com/tu_usuario"></div>
      <div class="form-group"><label><i class="fab fa-linkedin" style="color:#0A66C2"></i> LinkedIn</label><input type="url" id="editLinkedin" placeholder="https://linkedin.com/in/tu_usuario"></div>
      <div class="form-group"><label><i class="fab fa-twitter" style="color:#1DA1F2"></i> Twitter / X</label><input type="url" id="editTwitter" placeholder="https://twitter.com/tu_usuario"></div>
      <div class="form-group"><label><i class="fab fa-tiktok"></i> TikTok</label><input type="url" id="editTiktok" placeholder="https://tiktok.com/@tu_usuario"></div>
      <div class="form-group"><label><i class="fab fa-youtube" style="color:#FF0000"></i> YouTube</label><input type="url" id="editYoutube" placeholder="https://youtube.com/@tu_canal"></div>
      <div class="form-group"><label><i class="fas fa-globe" style="color:var(--accent)"></i> Sitio Web</label><input type="url" id="editWebsite" placeholder="https://tu-sitio-web.com"></div>
      <button type="submit" class="btn-submit" id="editProfileBtn"><i class="fas fa-save"></i> Guardar Cambios</button>
    </form>
  </div></div></div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
  <div class="modal share-modal" id="shareModal"><div class="modal-content"><div class="modal-header"><h2><i class="fas fa-share-alt" style="color:var(--accent)"></i> Compartir Propiedad</h2><button class="modal-close" onclick="closeModal('shareModal')"><i class="fas fa-times"></i></button></div><div class="modal-body">
    <div class="share-preview" id="sharePreview" style="margin-bottom:20px;padding:16px;background:var(--gray-50);border-radius:var(--radius-md)"><h4 id="shareTitle" style="margin-bottom:8px"></h4><p id="sharePrice" style="color:var(--accent);font-weight:600;margin-bottom:4px"></p><p id="shareLocation" style="font-size:13px;color:var(--gray-500)"></p></div>
    <div class="share-options">
      <div class="share-option whatsapp" onclick="shareToWhatsApp()"><i class="fab fa-whatsapp"></i><span>Compartir en WhatsApp</span></div>
      <div class="share-option facebook" onclick="shareToFacebook()"><i class="fab fa-facebook-f"></i><span>Compartir en Facebook</span></div>
      <div class="share-option twitter" onclick="shareToTwitter()"><i class="fab fa-twitter"></i><span>Compartir en Twitter</span></div>
      <div class="share-option copy" onclick="copyShareLink()"><i class="fas fa-link"></i><span>Copiar enlace</span></div>
    </div>
    <div class="share-url"><input type="text" id="shareUrlInput" readonly><button onclick="copyShareLink()">Copiar</button></div>
  </div></div></div>
  <script>
    const firebaseConfig = {apiKey:"AIzaSyDnCQLlJuBtZqXNwYILio9a8ltb972bXzQ",authDomain:"mi-cartera-inmobiliaria.firebaseapp.com",projectId:"mi-cartera-inmobiliaria",storageBucket:"mi-cartera-inmobiliaria.firebasestorage.app",messagingSenderId:"923595024127",appId:"1:923595024127:web:b7104adcba6387a5a84eca"};
    firebase.initializeApp(firebaseConfig);
    const auth=firebase.auth(),db=firebase.firestore(),storage=firebase.storage(),ADMIN_EMAIL="fabricio9061@gmail.com";
    
    // FCM - Push Notifications
    let messaging=null;
    try{messaging=firebase.messaging()}catch(e){console.log('FCM no soportado en este navegador')}
    
    // IMPORTANTE: Reemplazar con tu VAPID Key de Firebase Console
    const VAPID_KEY='BK8DjPgkooF91Ou9js1FOaX9VtJwVDqFaXpGePoYosqWcmpy5MBrtW0YauhWjWpYP1yUVvM9IzT4toFYLdEI8Ko';
    
    async function setupFCM(){
      if(!messaging||!currentUser)return;
      try{
        // 1. Verificar soporte de Service Worker
        if(!('serviceWorker' in navigator)){
          console.log('Service Workers no soportados');
          return;
        }
        
        // 2. Solicitar permiso de notificaciones
        const permission=await Notification.requestPermission();
        if(permission!=='granted'){
          console.log('Permiso de notificaciones denegado');
          showToast('Notificaciones','Habilita las notificaciones para recibir recordatorios','fa-bell');
          return;
        }
        
        // 3. Registrar Service Worker
        const reg=await navigator.serviceWorker.register('firebase-messaging-sw.js');
        console.log('Service Worker registrado:', reg.scope);
        
        // 4. Esperar a que el SW esté activo
        await navigator.serviceWorker.ready;
        
        // 5. Obtener token FCM
        const token=await messaging.getToken({
          vapidKey:VAPID_KEY,
          serviceWorkerRegistration:reg
        });
        
        if(token){
          console.log('FCM Token obtenido:', token.substring(0,20)+'...');
          
          // 6. Guardar token en Firestore
          const userRef=db.collection('users').doc(currentUser.uid);
          const doc=await userRef.get();
          const currentToken=doc.data()?.fcmToken;
          
          if(currentToken!==token){
            await userRef.update({
              fcmToken:token,
              fcmTokenUpdatedAt:new Date().toISOString(),
              notificationsEnabled:true,
              deviceInfo:{
                userAgent:navigator.userAgent,
                platform:navigator.platform,
                language:navigator.language
              }
            });
            console.log('FCM Token guardado en Firestore');
            showToast('Notificaciones activadas','Recibirás alertas de tus eventos','fa-bell');
          }
        }else{
          console.log('No se pudo obtener token FCM');
        }
      }catch(err){
        console.error('Error configurando FCM:',err);
        // No mostrar error al usuario, las notificaciones locales seguirán funcionando
      }
    }
    
    // Escuchar notificaciones en primer plano
    if(messaging){
      messaging.onMessage(payload=>{
        console.log('Notificación recibida en primer plano:',payload);
        const n=payload.notification||{};
        const d=payload.data||{};
        showToast(n.title||d.title||'Recordatorio',n.body||d.body||'Tienes un evento próximo','fa-bell');
        // También mostrar notificación nativa si está en primer plano
        if(Notification.permission==='granted'){
          new Notification(n.title||'Recordatorio',{
            body:n.body||'Tienes un evento próximo',
            icon:'https://cdn-icons-png.flaticon.com/512/1946/1946488.png',
            badge:'https://cdn-icons-png.flaticon.com/128/1946/1946488.png',
            vibrate:[200,100,200]
          });
        }
      });
    }
    
    // Escuchar mensajes del Service Worker (cuando hace clic en notificación)
    if('serviceWorker' in navigator){
      navigator.serviceWorker.addEventListener('message',event=>{
        console.log('Mensaje del SW:',event.data);
        if(event.data?.action==='openCalendar'){
          openCalendarModal();
        }
      });
    }
    
    // Función para enviar notificación de prueba (para debug)
    async function testNotification(){
      if(Notification.permission==='granted'){
        new Notification('🔔 Notificación de prueba',{
          body:'¡Las notificaciones están funcionando correctamente!',
          icon:'https://cdn-icons-png.flaticon.com/512/1946/1946488.png',
          vibrate:[200,100,200,100,200]
        });
        showToast('Test exitoso','Las notificaciones locales funcionan','fa-check');
      }else{
        const perm=await Notification.requestPermission();
        if(perm==='granted')testNotification();
        else showToast('Permiso denegado','Habilita las notificaciones en tu navegador','fa-exclamation-triangle');
      }
    }
    
    const uruguayData={"Montevideo":["Aguada","Aires Puros","Atahualpa","Bañados de Carrasco","Barrio Sur","Bella Italia","Bella Vista","Belvedere","Brazo Oriental","Buceo","Capurro","Carrasco","Carrasco Norte","Casabó","Casavalle","Centro","Cerrito de la Victoria","Cerro","Ciudad Vieja","Colón","Conciliación","Cordón","Flor de Maroñas","Goes","Ituzaingó","Jacinto Vera","Jardines del Hipódromo","La Blanqueada","La Comercial","La Figurita","La Paloma","La Teja","Larrañaga","Las Acacias","Las Canteras","Lezica","Malvín","Malvín Norte","Manga","Maroñas","Melilla","Mercado Modelo","Nuevo París","Palermo","Parque Batlle","Parque Rodó","Paso de la Arena","Paso de las Duranas","Paso Molino","Peñarol","Piedras Blancas","Pocitos","Pocitos Nuevo","Prado","Punta Carretas","Punta Gorda","Punta Rieles","Reducto","Sayago","Toledo Chico","Tres Cruces","Tres Ombúes","Unión","Villa Dolores","Villa Española","Villa García","Villa Muñoz","Vista Linda"].sort(),"Canelones":["Ciudad de la Costa","Las Piedras","Pando","Canelones","Santa Lucía","Progreso","Atlántida","Salinas","Parque del Plata","Solymar","Shangrilá","El Pinar","Lagomar","La Floresta"],"Maldonado":["Maldonado","Punta del Este","San Carlos","Piriápolis","Pan de Azúcar","La Barra","José Ignacio","Manantiales","Punta Ballena"],"Colonia":["Colonia del Sacramento","Carmelo","Juan Lacaze","Nueva Helvecia","Rosario","Nueva Palmira"],"Salto":["Salto","Daymán","Termas del Daymán","Termas del Arapey"],"Paysandú":["Paysandú","Guichón","Termas de Guaviyú"],"Río Negro":["Fray Bentos","Young"],"Soriano":["Mercedes","Dolores"],"San José":["San José de Mayo","Ciudad del Plata","Libertad"],"Florida":["Florida","Sarandí Grande"],"Flores":["Trinidad"],"Durazno":["Durazno","Sarandí del Yí"],"Tacuarembó":["Tacuarembó","Paso de los Toros"],"Rivera":["Rivera","Tranqueras"],"Artigas":["Artigas","Bella Unión"],"Cerro Largo":["Melo","Río Branco"],"Lavalleja":["Minas"],"Rocha":["Rocha","Chuy","Castillos","La Paloma","La Pedrera","Cabo Polonio","Punta del Diablo"],"Treinta y Tres":["Treinta y Tres","Vergara"]};
    
    let currentUser=null,userProfile=null,properties=[],allUsers={},currentDetailProperty=null,currentDetailImageIndex=0,currentProfileUserId=null,selectedImages=[],draggedImageIndex=null,notifications=[],notificationCheckInterval=null,visits=[],currentCalendarDate=null,selectedCalendarDate=null,visitReminderInterval=null,selectedEventType='visit';
    
    const eventTypeLabels = {visit:'Visita',meeting:'Reunión',delivery:'Entrega',review:'Revisión',other:'Otro'};
    
    // Zona horaria Uruguay - enfoque robusto con Intl API
    function getUruguayNow(){const s=new Date().toLocaleString('en-US',{timeZone:'America/Montevideo'});return new Date(s)}
    function getUruguayToday(){const d=getUruguayNow();d.setHours(0,0,0,0);return d}
    function formatDateToISO(d){const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,'0');const day=String(d.getDate()).padStart(2,'0');return`${y}-${m}-${day}`}
    function parseEventDateTime(dateStr,timeStr){const p=dateStr.split('-'),t=timeStr.split(':');return new Date(parseInt(p[0]),parseInt(p[1])-1,parseInt(p[2]),parseInt(t[0]),parseInt(t[1]),0)}
    function hoursUntilEvent(dateStr,timeStr){const now=getUruguayNow(),evt=parseEventDateTime(dateStr,timeStr);return(evt.getTime()-now.getTime())/(1e3*60*60)}
    
    function initDepartamentos(){const s=document.getElementById('propDepartamento');s.innerHTML='<option value="">Seleccionar...</option>';Object.keys(uruguayData).sort().forEach(d=>{s.innerHTML+=`<option value="${d}">${d}</option>`})}
    function updateCiudades(){const d=document.getElementById('propDepartamento').value,c=document.getElementById('propCiudad');c.innerHTML='<option value="">Seleccionar...</option>';if(d&&uruguayData[d])uruguayData[d].forEach(ciudad=>{c.innerHTML+=`<option value="${ciudad}">${ciudad}</option>`})}
    function loadRememberedUser(){const r=localStorage.getItem('rememberedEmail');if(r){document.getElementById('loginEmail').value=r;document.getElementById('rememberMe').checked=true}}
    async function loadUsers(){const s=await db.collection('users').get();s.docs.forEach(d=>{allUsers[d.id]=d.data()})}loadUsers();
    function showToast(t,m,i='fa-bell'){const c=document.getElementById('toastContainer'),toast=document.createElement('div');toast.className='toast';toast.innerHTML=`<div class="toast-icon"><i class="fas ${i}"></i></div><div class="toast-content"><strong>${t}</strong><p>${m}</p></div>`;c.appendChild(toast);setTimeout(()=>{toast.classList.add('hiding');setTimeout(()=>toast.remove(),300)},5000)}
    function requestNotificationPermission(){if('Notification'in window&&Notification.permission==='default')Notification.requestPermission()}
    function sendBrowserNotification(t,b,tag='notification'){
      if('Notification'in window&&Notification.permission==='granted'){
        const notif=new Notification(t,{
          body:b,
          icon:'https://cdn-icons-png.flaticon.com/512/1946/1946488.png',
          badge:'https://cdn-icons-png.flaticon.com/128/1946/1946488.png',
          tag:tag,
          renotify:true,
          vibrate:[200,100,200]
        });
        notif.onclick=()=>window.focus();
      }
    }
    
    async function uploadImageToStorage(f,p,i){const n=`${Date.now()}_${i}_${f.name.replace(/[^a-zA-Z0-9.]/g,'_')}`,r=storage.ref(`properties/${p}/${n}`),b=await compressImageToBlob(f,1200,.8),u=await r.put(b);return await u.ref.getDownloadURL()}
    async function uploadProfilePhoto(f,u){const n=`profile_${Date.now()}.jpg`,r=storage.ref(`users/${u}/${n}`),b=await compressImageToBlob(f,400,.8),up=await r.put(b);return await up.ref.getDownloadURL()}
    function compressImageToBlob(f,m=1200,q=.8){return new Promise(r=>{const rd=new FileReader();rd.onload=e=>{const i=new Image();i.onload=()=>{const c=document.createElement('canvas');let w=i.width,h=i.height;if(w>m){h=(h*m)/w;w=m}c.width=w;c.height=h;c.getContext('2d').drawImage(i,0,0,w,h);c.toBlob(r,'image/jpeg',q)};i.src=e.target.result};rd.readAsDataURL(f)})}
    function compressImageForPreview(f,m=200){return new Promise(r=>{const rd=new FileReader();rd.onload=e=>{const i=new Image();i.onload=()=>{const c=document.createElement('canvas');let w=i.width,h=i.height;if(w>m){h=(h*m)/w;w=m}c.width=w;c.height=h;c.getContext('2d').drawImage(i,0,0,w,h);r(c.toDataURL('image/jpeg',.6))};i.src=e.target.result};rd.readAsDataURL(f)})}
    
    function selectStatus(s){document.querySelectorAll('.status-option').forEach(o=>o.classList.remove('active'));document.querySelector(`.status-option.${s}`).classList.add('active');document.getElementById('propStatus').value=s}
    
    // User Dropdown
    function toggleUserDropdown(e){e.stopPropagation();const d=document.getElementById('userDropdown');d.classList.toggle('active')}
    document.addEventListener('click',e=>{const d=document.getElementById('userDropdown'),ui=document.querySelector('.user-info');if(d&&ui&&!ui.contains(e.target))d.classList.remove('active')});
    
    // Event Type Selection
    function selectEventType(type){selectedEventType=type;document.querySelectorAll('.event-type-option').forEach(o=>o.classList.remove('active'));document.querySelector(`.event-type-option[data-type="${type}"]`).classList.add('active');document.getElementById('eventType').value=type}
    
    // Calendar Functions
    function openCalendarModal(){currentCalendarDate=getUruguayToday();selectedCalendarDate=getUruguayToday();loadVisits();renderCalendar();openModal('calendarModal')}
    async function loadVisits(){if(!currentUser)return;try{const s=await db.collection('visits').where('userId','==',currentUser.uid).get();visits=s.docs.map(d=>({id:d.id,...d.data()}));renderCalendar();renderVisitsList();checkVisitReminders()}catch(e){console.error('Error loading visits:',e)}}
    function renderCalendar(){const g=document.getElementById('calendarGrid'),l=document.getElementById('calendarMonth'),y=currentCalendarDate.getFullYear(),m=currentCalendarDate.getMonth(),mn=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];l.textContent=`${mn[m]} ${y}`;const f=new Date(y,m,1),sd=new Date(f);sd.setDate(sd.getDate()-f.getDay());const t=getUruguayToday(),todayISO=formatDateToISO(t),selISO=formatDateToISO(selectedCalendarDate);let h=['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'].map(d=>`<div class="calendar-day-header">${d}</div>`).join('');const cd=new Date(sd);for(let i=0;i<42;i++){const ds=formatDateToISO(cd),om=cd.getMonth()!==m,it=ds===todayISO,is=ds===selISO,he=visits.some(v=>v.date===ds);let c='calendar-day';if(om)c+=' other-month';if(it)c+=' today';if(is)c+=' selected';if(he)c+=' has-events';h+=`<div class="${c}" onclick="selectDate('${ds}')">${cd.getDate()}</div>`;cd.setDate(cd.getDate()+1)}g.innerHTML=h}
    function changeMonth(d){currentCalendarDate.setMonth(currentCalendarDate.getMonth()+d);renderCalendar()}
    function selectDate(ds){const parts=ds.split('-');selectedCalendarDate=new Date(parts[0],parts[1]-1,parts[2],12,0,0);renderCalendar();renderVisitsList();const o={weekday:'long',day:'numeric',month:'long'};document.getElementById('selectedDateTitle').textContent=selectedCalendarDate.toLocaleDateString('es-UY',o)}
    
    function renderVisitsList(){const c=document.getElementById('visitsList'),ds=formatDateToISO(selectedCalendarDate),dv=visits.filter(v=>v.date===ds).sort((a,b)=>a.time.localeCompare(b.time));if(dv.length===0){c.innerHTML='<div class="no-visits"><i class="fas fa-calendar-check"></i><p>No hay eventos programados</p></div>';return}c.innerHTML=dv.map(v=>{const p=v.propertyId?properties.find(pr=>pr.id===v.propertyId):null;const h=hoursUntilEvent(v.date,v.time),iu=h>0;const evType=v.eventType||'visit';const evLabel=eventTypeLabels[evType]||'Evento';const title=v.title||(p?p.title:'Evento');const reminderInfo=v.reminder24h||v.reminder2h?`<p style="font-size:11px;color:var(--gold);margin-top:4px"><i class="fas fa-bell"></i> Recordatorio${v.reminded24h?' · 24h ✓':''}${v.reminded2h?' · 2h ✓':''}</p>`:'';return`<div class="visit-item ${iu?'upcoming':''} event-type-${evType}"><span class="event-type-badge ${evType}">${evLabel}</span><h4>${title}</h4>${p?`<p><i class="fas fa-home"></i> ${p.title}</p>`:''}${v.clientName?`<p><i class="fas fa-user"></i> ${v.clientName}</p>`:''}${v.clientPhone?`<p><i class="fas fa-phone"></i> ${v.clientPhone}</p>`:''}<div class="visit-time"><i class="fas fa-clock"></i> ${v.time}</div>${reminderInfo}${v.notes?`<p style="font-style:italic;margin-top:8px">"${v.notes}"</p>`:''}<div class="visit-actions"><button class="btn-edit" onclick="editVisit('${v.id}')"><i class="fas fa-edit"></i></button><button class="btn-reject" onclick="deleteVisit('${v.id}')"><i class="fas fa-trash"></i></button>${v.clientPhone?`<button class="btn-approve" onclick="window.open('https://wa.me/${v.clientPhone.replace(/\\D/g,'')}','_blank')"><i class="fab fa-whatsapp"></i></button>`:''}</div></div>`}).join('')}
    
    function openVisitModal(pi=null){document.getElementById('visitForm').reset();document.getElementById('editingVisitId').value='';document.getElementById('visitModalTitle').textContent='Nuevo Evento';selectEventType('visit');const s=document.getElementById('visitProperty');const up=properties.filter(p=>p.ownerId===currentUser?.uid);s.innerHTML='<option value="">-- Sin propiedad asociada --</option>'+up.map(p=>`<option value="${p.id}"${p.id===pi?' selected':''}>${p.title}</option>`).join('');const today=selectedCalendarDate||getUruguayToday();document.getElementById('visitDate').value=formatDateToISO(today);document.getElementById('visitTitle').value='';document.getElementById('visitClient').value='';document.getElementById('visitPhone').value='';document.getElementById('reminder24h').checked=true;document.getElementById('reminder2h').checked=true;openModal('visitModal')}
    
    async function handleSaveVisit(e){e.preventDefault();if(!currentUser){alert('Debes iniciar sesión');return}const ei=document.getElementById('editingVisitId').value;const pi=document.getElementById('visitProperty').value||null;const title=document.getElementById('visitTitle').value.trim();const vdate=document.getElementById('visitDate').value;const vtime=document.getElementById('visitTime').value;if(!title){alert('Ingresa un título o descripción para el evento');return}if(!vdate||!vtime){alert('Ingresa fecha y hora');return}const vd={userId:currentUser.uid,propertyId:pi,eventType:document.getElementById('eventType').value||'visit',title:title,clientName:document.getElementById('visitClient').value||'',clientPhone:document.getElementById('visitPhone').value||'',date:vdate,time:vtime,reminder24h:document.getElementById('reminder24h').checked,reminder2h:document.getElementById('reminder2h').checked,notes:document.getElementById('visitNotes').value||'',updatedAt:new Date().toISOString()};try{if(ei){await db.collection('visits').doc(ei).update(vd);showToast('Evento actualizado','Los cambios han sido guardados','fa-calendar-check')}else{vd.createdAt=new Date().toISOString();vd.reminded24h=false;vd.reminded2h=false;await db.collection('visits').add(vd);showToast('Evento agendado','Se te recordará antes del evento','fa-calendar-check')}closeModal('visitModal');loadVisits()}catch(err){console.error('Error saving visit:',err);alert('Error al guardar: '+err.message)}}
    
    async function editVisit(vi){const v=visits.find(vt=>vt.id===vi);if(!v)return;document.getElementById('editingVisitId').value=vi;document.getElementById('visitModalTitle').textContent='Editar Evento';selectEventType(v.eventType||'visit');document.getElementById('visitProperty').value=v.propertyId||'';document.getElementById('visitTitle').value=v.title||'';document.getElementById('visitClient').value=v.clientName||'';document.getElementById('visitPhone').value=v.clientPhone||'';document.getElementById('visitDate').value=v.date;document.getElementById('visitTime').value=v.time;document.getElementById('reminder24h').checked=v.reminder24h;document.getElementById('reminder2h').checked=v.reminder2h;document.getElementById('visitNotes').value=v.notes||'';openModal('visitModal')}
    async function deleteVisit(vi){if(!confirm('¿Eliminar este evento?'))return;try{await db.collection('visits').doc(vi).delete();showToast('Evento eliminado','','fa-trash');loadVisits()}catch(e){console.error('Error deleting visit:',e)}}
    
    function checkVisitReminders(){
      const now=getUruguayNow();
      visits.forEach(async v=>{
        const h=hoursUntilEvent(v.date,v.time);
        if(h<0||h>25)return; // Ignorar eventos pasados o muy lejanos
        
        const evLabel=eventTypeLabels[v.eventType||'visit']||'Evento';
        const title=v.title||evLabel;
        const detail=v.clientName?` - ${v.clientName}`:'';
        
        try{
          // RECORDATORIO 24H
          if(v.reminder24h&&!v.reminded24h&&h<=24&&h>2){
            const notifTitle='📅 Recordatorio - Mañana';
            const notifBody=`${title}${detail} · ${v.date} a las ${v.time}`;
            
            // Toast en la app
            showToast(notifTitle,notifBody,'fa-calendar-alt');
            
            // Notificación del sistema (funciona aunque la pestaña esté en segundo plano)
            if(Notification.permission==='granted'){
              const notif=new Notification(notifTitle,{
                body:notifBody,
                icon:'https://cdn-icons-png.flaticon.com/512/1946/1946488.png',
                badge:'https://cdn-icons-png.flaticon.com/128/1946/1946488.png',
                tag:'reminder-24h-'+v.id,
                renotify:true,
                requireInteraction:true,
                vibrate:[200,100,200]
              });
              notif.onclick=()=>{window.focus();openCalendarModal()};
            }
            
            await db.collection('visits').doc(v.id).update({reminded24h:true});
            v.reminded24h=true;
            console.log('Recordatorio 24h enviado:',title);
          }
          
          // RECORDATORIO 2H
          if(v.reminder2h&&!v.reminded2h&&h<=2&&h>0){
            const mins=Math.round(h*60);
            const notifTitle=`⏰ ¡Evento en ${mins} minutos!`;
            const notifBody=`${title}${detail} a las ${v.time}`;
            
            // Toast en la app
            showToast(notifTitle,notifBody,'fa-clock');
            
            // Notificación del sistema
            if(Notification.permission==='granted'){
              const notif=new Notification(notifTitle,{
                body:notifBody,
                icon:'https://cdn-icons-png.flaticon.com/512/1946/1946488.png',
                badge:'https://cdn-icons-png.flaticon.com/128/1946/1946488.png',
                tag:'reminder-2h-'+v.id,
                renotify:true,
                requireInteraction:true,
                vibrate:[200,100,200,100,200],
                actions:[{action:'open',title:'Ver agenda'}]
              });
              notif.onclick=()=>{window.focus();openCalendarModal()};
            }
            
            await db.collection('visits').doc(v.id).update({reminded2h:true});
            v.reminded2h=true;
            console.log('Recordatorio 2h enviado:',title);
          }
        }catch(err){
          console.error('Error en recordatorio para',v.id,':',err);
        }
      });
    }
    function startVisitReminderCheck(){if(visitReminderInterval)clearInterval(visitReminderInterval);checkVisitReminders();visitReminderInterval=setInterval(checkVisitReminders,60000)}
    
    // Notifications
    async function loadNotifications(){if(!currentUser)return;try{const s=await db.collection('notifications').where('ownerId','==',currentUser.uid).get();const nn=s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>new Date(b.createdAt||0)-new Date(a.createdAt||0)).slice(0,50);const oi=new Set(notifications.map(n=>n.id)),bn=nn.filter(n=>!oi.has(n.id)&&!n.read);if(bn.length>0&&notifications.length>0)bn.forEach(n=>{showToast('Nueva consulta',`${n.userName} consultó sobre "${n.propertyTitle}"`,'fa-comment');sendBrowserNotification('Nueva consulta',`${n.userName} consultó sobre "${n.propertyTitle}"`)});notifications=nn;renderNotifications()}catch(e){console.error('Error loading notifications:',e)}}
    function startNotificationPolling(){if(!currentUser)return;loadNotifications();if(notificationCheckInterval)clearInterval(notificationCheckInterval);notificationCheckInterval=setInterval(loadNotifications,10000)}
    function stopNotificationPolling(){if(notificationCheckInterval){clearInterval(notificationCheckInterval);notificationCheckInterval=null}}
    function renderNotifications(){const b=document.getElementById('notificationBadge'),be=document.getElementById('notificationBell'),l=document.getElementById('notificationList'),uc=notifications.filter(n=>!n.read).length;if(uc>0){b.textContent=uc>99?'99+':uc;b.classList.remove('hidden');be.classList.add('has-unread')}else{b.classList.add('hidden');be.classList.remove('has-unread')}if(notifications.length===0){l.innerHTML='<div class="notification-empty"><i class="fas fa-bell-slash"></i><p>No tienes consultas</p></div>';return}l.innerHTML=notifications.map(n=>{const i=(n.userName||'A').charAt(0).toUpperCase(),ts=n.createdAt?formatTimeAgo(n.createdAt):'';return`<div class="notification-item ${n.read?'':'unread'}" onclick="handleNotificationClick('${n.id}','${n.propertyId}')"><div class="notification-avatar">${n.userPhoto?`<img src="${n.userPhoto}" alt="">`:i}</div><div class="notification-body"><p><strong>${n.userName}</strong> consultó sobre <strong>${n.propertyTitle}</strong></p><div class="notification-message">"${(n.text||'').substring(0,100)}${(n.text||'').length>100?'...':''}"</div><div class="notification-meta"><span><i class="far fa-clock"></i> ${ts}</span>${n.userPhone?`<a href="https://wa.me/${n.userPhone.replace(/\D/g,'')}" target="_blank" class="notification-phone" onclick="event.stopPropagation()"><i class="fab fa-whatsapp"></i> ${n.userPhone}</a>`:''}</div></div></div>`}).join('')}
    function formatTimeAgo(t){const d=new Date(t),s=Math.floor((new Date()-d)/1000);if(s<60)return'Ahora';const m=Math.floor(s/60);if(m<60)return`Hace ${m} min`;const h=Math.floor(m/60);if(h<24)return`Hace ${h}h`;const dy=Math.floor(h/24);if(dy<7)return`Hace ${dy} días`;return d.toLocaleDateString('es')}
    function toggleNotifications(e){e.stopPropagation();const d=document.getElementById('notificationDropdown');const o=document.getElementById('notificationOverlay');const isOpen=d.classList.toggle('active');o.classList.toggle('active',isOpen);if(isOpen)loadNotifications()}
    function closeNotifications(){document.getElementById('notificationDropdown').classList.remove('active');document.getElementById('notificationOverlay').classList.remove('active')}
    document.addEventListener('click',e=>{const d=document.getElementById('notificationDropdown'),b=document.getElementById('notificationBell');if(d&&b&&!d.contains(e.target)&&!b.contains(e.target))d.classList.remove('active')});
    async function handleNotificationClick(ni,pi){closeNotifications();try{await db.collection('notifications').doc(ni).update({read:true});const n=notifications.find(nt=>nt.id===ni);if(n)n.read=true;renderNotifications()}catch(e){console.error('Error marking notification as read:',e)}openDetail(pi,true)}
    async function markAllAsRead(e){e.stopPropagation();const u=notifications.filter(n=>!n.read);if(u.length===0)return;try{const p=u.map(n=>db.collection('notifications').doc(n.id).update({read:true}));await Promise.all(p);notifications.forEach(n=>n.read=true);renderNotifications();showToast('Listo','Todas las consultas marcadas como leídas','fa-check')}catch(e){console.error('Error marking all as read:',e)}}
    
    // Auth
    auth.onAuthStateChanged(async u=>{if(u){const d=await db.collection('users').doc(u.uid).get();if(d.exists){userProfile=d.data();if(userProfile.status==='approved'||userProfile.email.toLowerCase()===ADMIN_EMAIL){currentUser=u;allUsers[u.uid]=userProfile;updateUI();requestNotificationPermission();setupFCM();startNotificationPolling();loadVisits();startVisitReminderCheck()}else{auth.signOut();alert('Tu cuenta está pendiente de aprobación')}}}else{currentUser=null;userProfile=null;notifications=[];visits=[];stopNotificationPolling();if(visitReminderInterval)clearInterval(visitReminderInterval);updateUI()}});
    function updateUI(){const ng=document.getElementById('nav-guest'),nu=document.getElementById('nav-user'),un=document.getElementById('userName'),ab=document.getElementById('adminBadge'),abt=document.getElementById('adminBtn'),ua=document.getElementById('userAvatar'),hb=document.getElementById('heroButtons'),bnp=document.getElementById('btnNewProperty');if(currentUser&&userProfile){ng.classList.add('hidden');nu.classList.remove('hidden');hb.classList.add('hidden');bnp.classList.remove('hidden');un.textContent=userProfile.name||'Usuario';const i=(userProfile.name||'U').charAt(0).toUpperCase();ua.innerHTML=userProfile.profilePhoto?`<img src="${userProfile.profilePhoto}" alt="">`:i;if(userProfile.email.toLowerCase()===ADMIN_EMAIL){ab.classList.remove('hidden');abt.classList.remove('hidden')}else{ab.classList.add('hidden');abt.classList.add('hidden')}}else{ng.classList.remove('hidden');nu.classList.add('hidden');hb.classList.remove('hidden');bnp.classList.add('hidden')}}
    function openModal(i){document.getElementById(i).classList.add('active');if(i==='loginModal')loadRememberedUser()}
    function closeModal(i){document.getElementById(i).classList.remove('active')}
    function switchModal(f,t){closeModal(f);setTimeout(()=>openModal(t),200)}
    function openPropertyModal(pi=null){resetPropertyForm();if(pi){const p=properties.find(pr=>pr.id===pi);if(p)loadPropertyForEdit(p)}else{if(userProfile&&userProfile.whatsapp)document.getElementById('propWhatsapp').value=userProfile.whatsapp}openModal('propertyModal')}
    function loadPropertyForEdit(p){document.getElementById('propertyModalTitle').textContent='Editar Propiedad';document.getElementById('propertyBtn').innerHTML='<i class="fas fa-save"></i> Guardar Cambios';document.getElementById('editingPropertyId').value=p.id;document.getElementById('previousPrice').value=p.price||'';document.getElementById('propTitle').value=p.title||'';document.getElementById('propDepartamento').value=p.departamento||'';updateCiudades();setTimeout(()=>{document.getElementById('propCiudad').value=p.ciudad||''},100);document.getElementById('propDireccion').value=p.direccion||'';document.getElementById('propPrice').value=p.price||'';document.getElementById('propCurrency').value=p.currency||'USD';document.getElementById('propType').value=p.type||'sale';togglePropertyType();document.getElementById('propPropertyType').value=p.propertyType||'common';document.getElementById('propBedrooms').value=p.bedrooms||'';document.getElementById('propBathrooms').value=p.bathrooms||'';document.getElementById('propTotalArea').value=p.totalArea||'';document.getElementById('propBuiltArea').value=p.builtArea||'';document.getElementById('propExpenses').value=p.commonExpenses||'';document.getElementById('propGarage').value=p.garage||'no';document.getElementById('propDescription').value=p.description||'';document.getElementById('propWhatsapp').value=p.ownerWhatsapp||'';selectStatus(p.status||'available');if(p.images&&p.images.length>0){selectedImages=p.images.map(url=>({preview:url,url:url,existing:true}));renderImagePreviews()}}
    function editCurrentProperty(){if(currentDetailProperty){closeModal('detailModal');openPropertyModal(currentDetailProperty.id)}}
    function togglePropertyType(){document.getElementById('propertyTypeGroup').style.display=document.getElementById('propType').value==='rent'?'none':'block'}
    async function handleLogin(e){e.preventDefault();const b=document.getElementById('loginBtn'),er=document.getElementById('loginError'),em=document.getElementById('loginEmail').value,r=document.getElementById('rememberMe').checked;b.disabled=true;b.textContent='Iniciando...';er.classList.add('hidden');try{await auth.signInWithEmailAndPassword(em,document.getElementById('loginPassword').value);if(r)localStorage.setItem('rememberedEmail',em);else localStorage.removeItem('rememberedEmail');closeModal('loginModal');document.getElementById('loginEmail').value='';document.getElementById('loginPassword').value=''}catch(err){er.textContent='Correo o contraseña incorrectos';er.classList.remove('hidden')}finally{b.disabled=false;b.textContent='Iniciar Sesión'}}
    async function handleRegister(e){e.preventDefault();const b=document.getElementById('registerBtn'),er=document.getElementById('registerError'),su=document.getElementById('registerSuccess'),nm=document.getElementById('registerName').value,em=document.getElementById('registerEmail').value,wh=document.getElementById('registerWhatsapp').value,ig=document.getElementById('registerInstagram').value.trim(),pw=document.getElementById('registerPassword').value,cf=document.getElementById('registerConfirm').value;if(pw!==cf){er.textContent='Las contraseñas no coinciden';er.classList.remove('hidden');return}b.disabled=true;b.textContent='Creando...';er.classList.add('hidden');su.classList.add('hidden');try{const uc=await auth.createUserWithEmailAndPassword(em,pw);const ia=em.toLowerCase()===ADMIN_EMAIL;const ud={uid:uc.user.uid,email:em,name:nm,whatsapp:wh,status:ia?'approved':'pending',createdAt:new Date().toISOString()};if(ig&&ig.includes('instagram.com'))ud.instagram=ig;await db.collection('users').doc(uc.user.uid).set(ud);await auth.signOut();document.getElementById('registerForm').reset();su.textContent=ia?'¡Cuenta admin creada!':'¡Cuenta creada! Espera aprobación.';su.classList.remove('hidden')}catch(err){er.textContent=err.code==='auth/email-already-in-use'?'Este correo ya está registrado':err.message;er.classList.remove('hidden')}finally{b.disabled=false;b.textContent='Crear Cuenta'}}
    function logout(){auth.signOut();showHome();document.getElementById('userDropdown').classList.remove('active')}
    async function handleProfilePhotoChange(e){const f=e.target.files[0];if(!f||!currentUser)return;try{showToast('Subiendo foto...','Por favor espera','fa-spinner');const pu=await uploadProfilePhoto(f,currentUser.uid);await db.collection('users').doc(currentUser.uid).update({profilePhoto:pu});userProfile.profilePhoto=pu;allUsers[currentUser.uid].profilePhoto=pu;updateUI();document.getElementById('profileAvatar').innerHTML=`<img src="${pu}" alt="">`;showToast('Perfil actualizado','Tu foto ha sido actualizada','fa-check')}catch(err){console.error('Error uploading profile photo:',err);alert('Error al actualizar foto: '+err.message)}}
    
    // Properties
    function loadProperties(){db.collection('properties').orderBy('createdAt','desc').onSnapshot(s=>{properties=s.docs.map(d=>({id:d.id,...d.data()}));renderProperties(properties);updateStats()})}
    function getUserInfo(ui){return allUsers[ui]||{name:'Usuario',profilePhoto:null}}
    function formatPrice(p,c){return`${c==='UYU'?'$U':'US$'} ${(p||0).toLocaleString()}`}
    function getLocationString(p){return p.ciudad&&p.departamento?`${p.ciudad}, ${p.departamento}`:p.location||'Uruguay'}
    function canEditProperty(p){return currentUser&&(currentUser.uid===p.ownerId||userProfile?.email?.toLowerCase()===ADMIN_EMAIL)}
    function renderProperties(ps,tg='propertiesGrid'){const g=document.getElementById(tg),ld=document.getElementById('propertiesLoading'),ct=document.getElementById('propertiesCount');if(ld)ld.classList.add('hidden');if(ct)ct.textContent=`${ps.length} propiedades encontradas`;if(ps.length===0){g.innerHTML='<p style="text-align:center;color:var(--gray-500);grid-column:1/-1;padding:60px">No hay propiedades disponibles</p>';return}
    // Ordenar: 1) Destacadas disponibles, 2) Disponibles, 3) Reservadas/Vendidas/Alquiladas, 4) Archivadas
    const statusPriority={available:1,reserved:2,sold:3,rented:4,archived:5};
    const sorted=[...ps].sort((a,b)=>{
      const stA=a.status||'available',stB=b.status||'available';
      const prioA=statusPriority[stA]||1,prioB=statusPriority[stB]||1;
      const aFeat=a.featured&&stA==='available'?0:1;
      const bFeat=b.featured&&stB==='available'?0:1;
      if(aFeat!==bFeat)return aFeat-bFeat;
      if(prioA!==prioB)return prioA-prioB;
      return new Date(b.createdAt||0)-new Date(a.createdAt||0);
    });
    g.innerHTML=sorted.map(p=>{const o=getUserInfo(p.ownerId),oi=(o.name||'U').charAt(0).toUpperCase(),c=p.currency||'USD',l=getLocationString(p),ce=canEditProperty(p),hi=o.instagram&&o.instagram.includes('instagram.com'),st=p.status||'available',hop=p.previousPrice&&p.previousPrice>p.price,pdp=hop?Math.round((1-p.price/p.previousPrice)*100):0,isFeatured=p.featured&&st==='available';const stLabels={reserved:'RESERVADA',sold:'VENDIDA',rented:'ALQUILADA',archived:'ARCHIVADA'};const stLabel=stLabels[st]||'';return`<div class="property-card ${st!=='available'?`status-${st}`:''} ${isFeatured?'featured':''}" onclick="openDetail('${p.id}')"><div class="card-image"><img src="${p.images?.[0]||'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800'}" alt="${p.title}" loading="lazy">${st!=='available'?`<div class="property-status-overlay ${st}"><div class="status-ribbon ${st}">${stLabel}</div></div>`:''}<div class="card-badges">${isFeatured?'<span class="badge badge-featured"><i class="fas fa-star"></i> DESTACADA</span>':''}<span class="badge ${p.type==='sale'?'badge-sale':'badge-rent'}">${p.type==='sale'?'VENTA':'ALQUILER'}</span>${p.type==='sale'&&p.propertyType==='ph'?'<span class="badge badge-ph">PH</span>':''}${c==='UYU'?'<span class="badge badge-currency">UYU</span>':''}${p.garage==='yes'?'<span class="badge badge-garage"><i class="fas fa-car"></i></span>':''}${hop?`<span class="badge badge-reduced">-${pdp}%</span>`:''}</div>${ce?`<div class="card-actions"><button class="card-action-btn calendar" onclick="event.stopPropagation();openVisitModal('${p.id}')" title="Agendar visita"><i class="fas fa-calendar-plus"></i></button><button class="card-action-btn edit" onclick="event.stopPropagation();openPropertyModal('${p.id}')" title="Editar"><i class="fas fa-edit"></i></button><button class="btn-feature ${p.featured?'active':''}" onclick="event.stopPropagation();toggleFeatured('${p.id}')" title="${p.featured?'Quitar destacado':'Destacar'}"><i class="fas fa-star"></i></button><button class="card-action-btn delete" onclick="event.stopPropagation();deleteProperty('${p.id}')" title="Eliminar"><i class="fas fa-trash"></i></button></div>`:''}<div class="card-owner" onclick="event.stopPropagation();showProfile('${p.ownerId}')">${o.profilePhoto?`<img src="${o.profilePhoto}" alt="">`:`<div class="card-owner-initial">${oi}</div>`}<span>${o.name||'Usuario'}</span></div></div><div class="card-content"><div class="card-price ${hop?'card-price-reduced':''}">${hop?`<span class="card-price-old">${formatPrice(p.previousPrice,c)}</span>`:''}${formatPrice(p.price,c)}${p.type==='rent'?'<span>/mes</span>':''}${hop?`<span class="price-drop-badge" style="color:#FFFFFF!important">-${pdp}%</span>`:''}</div><h3 class="card-title">${p.title}</h3><div class="card-location"><i class="fas fa-map-marker-alt"></i>${l}</div><div class="card-features">${p.bedrooms?`<div class="card-feature"><i class="fas fa-bed"></i>${p.bedrooms}</div>`:''}${p.bathrooms?`<div class="card-feature"><i class="fas fa-bath"></i>${p.bathrooms}</div>`:''}${p.totalArea?`<div class="card-feature"><i class="fas fa-expand"></i>${p.totalArea}m²</div>`:''}${p.builtArea?`<div class="card-feature"><i class="fas fa-home"></i>${p.builtArea}m² edif.</div>`:''}${p.garage==='yes'?`<div class="card-feature"><i class="fas fa-car"></i>Garaje</div>`:''}</div></div><div class="card-footer"><span class="card-views"><i class="fas fa-eye"></i> ${p.views||0}</span><div style="display:flex;gap:8px"><button class="btn-share" onclick="event.stopPropagation();openShareModal('${p.id}')" title="Compartir"><i class="fas fa-share-alt"></i></button>${hi?`<button class="btn-instagram" onclick="event.stopPropagation();window.open('${o.instagram}','_blank')"><i class="fab fa-instagram"></i></button>`:''}<button class="btn-whatsapp" onclick="event.stopPropagation();contactWhatsapp('${p.id}')"><i class="fab fa-whatsapp"></i> Contactar</button></div></div></div>`}).join('')}
    function updateStats(){const av=properties.filter(p=>!p.status||p.status==='available'||p.status==='reserved');document.getElementById('statTotal').textContent=av.length;document.getElementById('statSale').textContent=av.filter(p=>p.type==='sale').length;document.getElementById('statRent').textContent=av.filter(p=>p.type==='rent').length}
    function filterProperties(){const s=document.getElementById('filterSearch').value.toLowerCase(),t=document.getElementById('filterType').value,b=parseInt(document.getElementById('filterBedrooms').value)||0,mp=parseInt(document.getElementById('filterPrice').value)||Infinity;const f=properties.filter(p=>{const l=getLocationString(p).toLowerCase();if(s&&!p.title.toLowerCase().includes(s)&&!l.includes(s))return false;if(t&&p.type!==t)return false;if(b&&(p.bedrooms||0)<b)return false;if(p.price>mp)return false;return true});renderProperties(f)}
    
    // Profile Functions
    function renderSocialLinks(ud){let html='';if(ud.whatsapp){html+=`<a href="https://wa.me/${ud.whatsapp.replace(/\D/g,'')}" target="_blank" class="profile-social-link whatsapp" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>`}if(ud.instagram&&ud.instagram.includes('instagram.com')){html+=`<a href="${ud.instagram}" target="_blank" class="profile-social-link instagram" title="Instagram"><i class="fab fa-instagram"></i></a>`}if(ud.facebook&&ud.facebook.includes('facebook.com')){html+=`<a href="${ud.facebook}" target="_blank" class="profile-social-link facebook" title="Facebook"><i class="fab fa-facebook-f"></i></a>`}if(ud.linkedin&&ud.linkedin.includes('linkedin.com')){html+=`<a href="${ud.linkedin}" target="_blank" class="profile-social-link linkedin" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>`}if(ud.twitter&&(ud.twitter.includes('twitter.com')||ud.twitter.includes('x.com'))){html+=`<a href="${ud.twitter}" target="_blank" class="profile-social-link twitter" title="Twitter/X"><i class="fab fa-twitter"></i></a>`}if(ud.tiktok&&ud.tiktok.includes('tiktok.com')){html+=`<a href="${ud.tiktok}" target="_blank" class="profile-social-link tiktok" title="TikTok"><i class="fab fa-tiktok"></i></a>`}if(ud.youtube&&ud.youtube.includes('youtube.com')){html+=`<a href="${ud.youtube}" target="_blank" class="profile-social-link youtube" title="YouTube"><i class="fab fa-youtube"></i></a>`}if(ud.website){html+=`<a href="${ud.website}" target="_blank" class="profile-social-link" title="Sitio Web"><i class="fas fa-globe"></i></a>`}return html}
    
    async function showProfile(ui){currentProfileUserId=ui;window.location.hash=`perfil/${ui}`;let ud=allUsers[ui];if(!ud){const d=await db.collection('users').doc(ui).get();ud=d.exists?d.data():{name:'Usuario',email:''};allUsers[ui]=ud}document.getElementById('profileName').textContent=ud.name||'Usuario';document.getElementById('profileNameTitle').textContent=ud.name||'Usuario';document.getElementById('profileEmail').textContent=ud.email||'';document.getElementById('profileBio').textContent=ud.bio||'';document.getElementById('profileBio').style.display=ud.bio?'block':'none';const i=(ud.name||'U').charAt(0).toUpperCase();document.getElementById('profileAvatar').innerHTML=ud.profilePhoto?`<img src="${ud.profilePhoto}" alt="">`:i;const ip=currentUser&&currentUser.uid===ui;document.getElementById('profileAvatarEdit').classList.toggle('hidden',!ip);document.getElementById('btnEditProfile').classList.toggle('hidden',!ip);document.getElementById('profileSocialLinks').innerHTML=renderSocialLinks(ud);const up=properties.filter(p=>p.ownerId===ui),tv=up.reduce((s,p)=>s+(p.views||0),0);document.getElementById('profilePropertiesCount').textContent=up.length;document.getElementById('profileViewsCount').textContent=tv;document.getElementById('profilePropertiesSubtitle').textContent=`${up.length} propiedades`;document.getElementById('btnNewPropertyProfile').classList.toggle('hidden',!ip);renderProperties(up,'profilePropertiesGrid');document.getElementById('mainContent').classList.add('hidden');document.getElementById('adminPanel').classList.add('hidden');document.getElementById('profilePage').classList.remove('hidden')}
    function showMyProfile(){if(currentUser){showProfile(currentUser.uid);document.getElementById('userDropdown').classList.remove('active')}}
    function getProfileLink(){return`${window.location.origin}${window.location.pathname}#perfil/${currentProfileUserId}`}
    function copyProfileLink(){navigator.clipboard.writeText(getProfileLink()).then(()=>{showToast('Enlace copiado','El enlace ha sido copiado','fa-link')})}
    function shareProfileWhatsapp(){const u=allUsers[currentProfileUserId]||{name:'este usuario'};window.open(`https://wa.me/?text=${encodeURIComponent(`Mira las propiedades de ${u.name}: ${getProfileLink()}`)}`, '_blank')}
    function handleHash(){const h=window.location.hash;if(h.startsWith('#perfil/')){showProfile(h.replace('#perfil/',''))}else if(h.startsWith('#propiedad/')){const pid=h.replace('#propiedad/','');if(properties.length>0){openDetail(pid)}else{const checkProps=setInterval(()=>{if(properties.length>0){clearInterval(checkProps);openDetail(pid)}},200);setTimeout(()=>clearInterval(checkProps),5000)}}}
    window.addEventListener('hashchange',handleHash);
    
    // Edit Profile
    function openEditProfileModal(){if(!currentUser||!userProfile)return;document.getElementById('editProfileError').classList.add('hidden');document.getElementById('editProfileSuccess').classList.add('hidden');document.getElementById('editName').value=userProfile.name||'';document.getElementById('editBio').value=userProfile.bio||'';document.getElementById('editWhatsapp').value=userProfile.whatsapp||'';document.getElementById('editInstagram').value=userProfile.instagram||'';document.getElementById('editFacebook').value=userProfile.facebook||'';document.getElementById('editLinkedin').value=userProfile.linkedin||'';document.getElementById('editTwitter').value=userProfile.twitter||'';document.getElementById('editTiktok').value=userProfile.tiktok||'';document.getElementById('editYoutube').value=userProfile.youtube||'';document.getElementById('editWebsite').value=userProfile.website||'';document.getElementById('userDropdown').classList.remove('active');openModal('editProfileModal')}
    
    async function handleSaveProfile(e){e.preventDefault();if(!currentUser)return;const b=document.getElementById('editProfileBtn'),er=document.getElementById('editProfileError'),su=document.getElementById('editProfileSuccess');b.disabled=true;b.innerHTML='<i class="fas fa-spinner fa-spin"></i> Guardando...';er.classList.add('hidden');su.classList.add('hidden');try{const updateData={name:document.getElementById('editName').value.trim(),bio:document.getElementById('editBio').value.trim(),whatsapp:document.getElementById('editWhatsapp').value.trim(),instagram:document.getElementById('editInstagram').value.trim(),facebook:document.getElementById('editFacebook').value.trim(),linkedin:document.getElementById('editLinkedin').value.trim(),twitter:document.getElementById('editTwitter').value.trim(),tiktok:document.getElementById('editTiktok').value.trim(),youtube:document.getElementById('editYoutube').value.trim(),website:document.getElementById('editWebsite').value.trim(),updatedAt:new Date().toISOString()};await db.collection('users').doc(currentUser.uid).update(updateData);Object.assign(userProfile,updateData);allUsers[currentUser.uid]=userProfile;updateUI();if(currentProfileUserId===currentUser.uid){showProfile(currentUser.uid)}su.textContent='¡Perfil actualizado correctamente!';su.classList.remove('hidden');showToast('Perfil actualizado','Tus datos han sido guardados','fa-check');setTimeout(()=>closeModal('editProfileModal'),1500)}catch(err){console.error('Error updating profile:',err);er.textContent='Error al guardar: '+err.message;er.classList.remove('hidden')}finally{b.disabled=false;b.innerHTML='<i class="fas fa-save"></i> Guardar Cambios'}}
    
    // Detail View
    async function openDetail(id,sc=false){const p=properties.find(pr=>pr.id===id);if(!p)return;currentDetailProperty=p;currentDetailImageIndex=0;const io=currentUser&&currentUser.uid===p.ownerId;if(!sc&&!io)db.collection('properties').doc(id).update({views:firebase.firestore.FieldValue.increment(1)}).catch(e=>console.log('Error counting view:',e));const im=p.images?.length?p.images:['https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800'];document.getElementById('detailImage').src=im[0];document.getElementById('detailTitle').textContent=p.title;document.getElementById('detailLocation').textContent=getLocationString(p)+(p.direccion?` - ${p.direccion}`:'');const c=p.currency||'USD',hop=p.previousPrice&&p.previousPrice>p.price,pdp=hop?Math.round((1-p.price/p.previousPrice)*100):0;document.getElementById('detailPrice').textContent=`${formatPrice(p.price,c)}${p.type==='rent'?'/mes':''}`;const ope=document.getElementById('detailPriceOld'),pde=document.getElementById('detailPriceDrop');if(hop){ope.textContent=formatPrice(p.previousPrice,c);ope.classList.remove('hidden');pde.textContent=`¡${pdp}% de descuento!`;pde.classList.remove('hidden')}else{ope.classList.add('hidden');pde.classList.add('hidden')}document.getElementById('detailDescription').textContent=p.description||'Sin descripción.';const so=document.getElementById('detailStatusOverlay'),sr=document.getElementById('detailStatusRibbon'),st=p.status||'available';const stLabels={reserved:'RESERVADA',sold:'VENDIDA',rented:'ALQUILADA',archived:'ARCHIVADA'};if(st!=='available'&&stLabels[st]){so.className=`detail-status-overlay ${st}`;sr.className=`status-ribbon ${st}`;sr.textContent=stLabels[st];so.classList.remove('hidden')}else{so.classList.add('hidden')}const tc=document.getElementById('detailThumbnails');if(im.length>1){tc.innerHTML=im.map((img,i)=>`<div class="detail-thumb ${i===0?'active':''}" onclick="setDetailImage(${i})"><img src="${img}" alt=""></div>`).join('');tc.style.display='flex'}else tc.style.display='none';const o=getUserInfo(p.ownerId),oi=(o.name||'U').charAt(0).toUpperCase();document.getElementById('detailOwnerName').textContent=o.name||'Usuario';document.getElementById('detailOwnerAvatar').innerHTML=o.profilePhoto?`<img src="${o.profilePhoto}" alt="">`:oi;document.getElementById('detailBadges').innerHTML=`${p.featured&&st==='available'?'<span class="badge badge-featured"><i class="fas fa-star"></i> DESTACADA</span>':''}<span class="badge ${p.type==='sale'?'badge-sale':'badge-rent'}">${p.type==='sale'?'VENTA':'ALQUILER'}</span>${p.type==='sale'&&p.propertyType==='ph'?'<span class="badge badge-ph">PH</span>':''}${c==='UYU'?'<span class="badge badge-currency">UYU</span>':''}${p.garage==='yes'?'<span class="badge badge-garage"><i class="fas fa-car"></i></span>':''}${hop?`<span class="badge badge-reduced">-${pdp}%</span>`:''}${st==='reserved'?'<span class="badge badge-reserved">RESERVADA</span>':''}${st==='sold'?'<span class="badge badge-sold">VENDIDA</span>':''}${st==='rented'?'<span class="badge badge-rented">ALQUILADA</span>':''}${st==='archived'?'<span class="badge badge-archived">ARCHIVADA</span>':''}`;document.getElementById('detailFeatures').innerHTML=`${p.bedrooms?`<div class="detail-feature"><i class="fas fa-bed"></i><strong>${p.bedrooms}</strong><span>Dormitorios</span></div>`:''}${p.bathrooms?`<div class="detail-feature"><i class="fas fa-bath"></i><strong>${p.bathrooms}</strong><span>Baños</span></div>`:''}${p.totalArea?`<div class="detail-feature"><i class="fas fa-expand"></i><strong>${p.totalArea}</strong><span>m² Total</span></div>`:''}${p.builtArea?`<div class="detail-feature"><i class="fas fa-home"></i><strong>${p.builtArea}</strong><span>m² Edificado</span></div>`:''}${p.garage==='yes'?`<div class="detail-feature"><i class="fas fa-car"></i><strong>Sí</strong><span>Garaje</span></div>`:''}${p.commonExpenses?`<div class="detail-feature"><i class="fas fa-dollar-sign"></i><strong>${p.commonExpenses}</strong><span>Gastos</span></div>`:''}`;document.getElementById('detailWhatsapp').onclick=()=>contactWhatsapp(id);const ib=document.getElementById('detailInstagram');if(o.instagram&&o.instagram.includes('instagram.com')){ib.classList.remove('hidden');ib.onclick=()=>window.open(o.instagram,'_blank')}else{ib.classList.add('hidden')}document.getElementById('detailEditBtn').classList.toggle('hidden',!canEditProperty(p));document.getElementById('commentFormGuest').classList.toggle('hidden',!!currentUser);document.getElementById('commentFormUser').classList.toggle('hidden',!currentUser);loadComments(id);openModal('detailModal')}
    function setDetailImage(i){if(!currentDetailProperty?.images?.length)return;currentDetailImageIndex=i;document.getElementById('detailImage').src=currentDetailProperty.images[i];document.querySelectorAll('.detail-thumb').forEach((t,idx)=>t.classList.toggle('active',idx===i))}
    function prevDetailImage(){if(!currentDetailProperty?.images?.length)return;currentDetailImageIndex=(currentDetailImageIndex-1+currentDetailProperty.images.length)%currentDetailProperty.images.length;setDetailImage(currentDetailImageIndex)}
    function nextDetailImage(){if(!currentDetailProperty?.images?.length)return;currentDetailImageIndex=(currentDetailImageIndex+1)%currentDetailProperty.images.length;setDetailImage(currentDetailImageIndex)}
    function viewOwnerProfile(){if(currentDetailProperty){closeModal('detailModal');showProfile(currentDetailProperty.ownerId)}}
    
    // Comments
    async function loadComments(pi){const c=document.getElementById('commentsList');c.innerHTML='<div class="loading"><div class="spinner"></div></div>';const io=currentUser&&currentDetailProperty&&currentUser.uid===currentDetailProperty.ownerId;try{const s=await db.collection('properties').doc(pi).collection('comments').orderBy('createdAt','desc').get();const cm=s.docs.map(d=>d.data());if(cm.length===0){c.innerHTML='<div class="no-comments"><i class="fas fa-comment-slash"></i><p>Sé el primero en consultar</p></div>';return}c.innerHTML=cm.map(co=>{const i=(co.userName||'A').charAt(0).toUpperCase(),t=co.createdAt?new Date(co.createdAt).toLocaleDateString('es'):'',sp=io&&co.userPhone;return`<div class="comment-item"><div class="comment-avatar">${co.userPhoto?`<img src="${co.userPhoto}" alt="">`:i}</div><div class="comment-content"><div class="comment-header"><span class="comment-author">${co.userName||'Anónimo'}</span>${co.isGuest?'<span class="comment-guest-badge">Invitado</span>':''}<span class="comment-time">${t}</span></div><p class="comment-text">${co.text}</p>${sp?`<div class="comment-contact"><i class="fab fa-whatsapp"></i> Contacto: <a href="https://wa.me/${co.userPhone.replace(/\D/g,'')}" target="_blank">${co.userPhone}</a></div>`:''}</div></div>`}).join('')}catch(e){console.error('Error loading comments:',e);c.innerHTML='<p style="color:var(--danger)">Error al cargar consultas</p>'}}
    async function addComment(){let tx,un,up,uph,ig;if(currentUser&&userProfile){tx=document.getElementById('commentInputUser').value.trim();un=userProfile.name;up=userProfile.whatsapp||'';uph=userProfile.profilePhoto||null;ig=false}else{tx=document.getElementById('commentInput').value.trim();un=document.getElementById('guestName').value.trim();up=document.getElementById('guestPhone').value.trim();uph=null;ig=true;if(!un){alert('Por favor ingresa tu nombre');return}if(!up){alert('Por favor ingresa tu WhatsApp');return}}if(!tx||!currentDetailProperty){alert('Por favor escribe tu consulta');return}try{const cd={userId:currentUser?.uid||null,userName:un,userPhone:up,userPhoto:uph,text:tx,isGuest:ig,createdAt:new Date().toISOString()};await db.collection('properties').doc(currentDetailProperty.id).collection('comments').add(cd);const io=currentUser&&currentUser.uid===currentDetailProperty.ownerId;if(!io){const nd={ownerId:currentDetailProperty.ownerId,propertyId:currentDetailProperty.id,propertyTitle:currentDetailProperty.title,userName:un,userPhone:up,userPhoto:uph,text:tx,read:false,createdAt:new Date().toISOString()};await db.collection('notifications').add(nd)}if(currentUser){document.getElementById('commentInputUser').value=''}else{document.getElementById('commentInput').value=''}loadComments(currentDetailProperty.id);showToast('Consulta enviada','Tu mensaje ha sido enviado al propietario','fa-check')}catch(e){console.error('Error adding comment:',e);alert('Error al enviar consulta: '+e.message)}}
    function contactWhatsapp(id){const p=properties.find(pr=>pr.id===id);if(!p)return;const o=getUserInfo(p.ownerId),ph=(p.ownerWhatsapp||o.whatsapp||'59899000000').replace(/\D/g,''),m=`Hola, me interesa: ${p.title} - ${formatPrice(p.price,p.currency||'USD')} en ${getLocationString(p)}`;window.open(`https://wa.me/${ph}?text=${encodeURIComponent(m)}`,'_blank')}
    function showHome(){document.getElementById('mainContent').classList.remove('hidden');document.getElementById('adminPanel').classList.add('hidden');document.getElementById('profilePage').classList.add('hidden');currentProfileUserId=null;window.location.hash=''}
    
    // Admin
    function showAdmin(){if(!currentUser||userProfile?.email?.toLowerCase()!==ADMIN_EMAIL)return;document.getElementById('mainContent').classList.add('hidden');document.getElementById('profilePage').classList.add('hidden');document.getElementById('adminPanel').classList.remove('hidden');showAdminTab('pending')}
    async function showAdminTab(tb){document.querySelectorAll('.admin-tab').forEach(t=>t.classList.remove('active'));document.getElementById(`tab${tb.charAt(0).toUpperCase()+tb.slice(1)}`).classList.add('active');const c=document.getElementById('adminContent');c.innerHTML='<div class="loading"><div class="spinner"></div></div>';if(tb==='pending'){const s=await db.collection('users').where('status','==','pending').get();const us=s.docs.map(d=>({id:d.id,...d.data()}));document.getElementById('pendingCount').textContent=us.length>0?`(${us.length})`:'';c.innerHTML=us.length===0?`<div class="empty-state"><i class="fas fa-check-circle" style="color:var(--success)"></i><h3>Sin pendientes</h3></div>`:us.map(u=>`<div class="user-card"><div class="user-card-avatar"><i class="fas fa-user"></i></div><div class="user-card-info"><h4>${u.name}</h4><p>${u.email}</p><small>WhatsApp: ${u.whatsapp||'-'}</small></div><div class="user-card-actions"><button class="btn-approve" onclick="approveUser('${u.id}')"><i class="fas fa-check"></i></button><button class="btn-reject" onclick="rejectUser('${u.id}')"><i class="fas fa-times"></i></button></div></div>`).join('')}else if(tb==='users'){const s=await db.collection('users').get();const us=s.docs.map(d=>({id:d.id,...d.data()}));c.innerHTML=us.map(u=>`<div class="user-card"><div class="user-card-avatar">${u.profilePhoto?`<img src="${u.profilePhoto}" alt="">`:'<i class="fas fa-user"></i>'}</div><div class="user-card-info"><h4>${u.name} ${u.email.toLowerCase()===ADMIN_EMAIL?'<span class="admin-badge">Admin</span>':''}</h4><p>${u.email}</p><small style="color:${u.status==='approved'?'var(--success)':'var(--gold)'}">${u.status}</small></div><div class="user-card-actions"><button class="btn-edit" onclick="showProfile('${u.id}')"><i class="fas fa-eye"></i></button>${u.email.toLowerCase()!==ADMIN_EMAIL?`<button class="btn-reject" onclick="deleteUser('${u.id}')"><i class="fas fa-trash"></i></button>`:''}</div></div>`).join('')}else if(tb==='properties'){c.innerHTML=properties.length===0?'<div class="empty-state"><i class="fas fa-building"></i><h3>Sin propiedades</h3></div>':properties.map(p=>{const o=getUserInfo(p.ownerId),st=p.status||'available',stLabels={available:'✓ Disponible',reserved:'⏳ Reservada',sold:'✗ Vendida',rented:'🔑 Alquilada',archived:'📦 Archivada'},stt=stLabels[st]||'✓ Disponible',isFeat=p.featured;return`<div class="user-card ${isFeat?'featured-admin':''}"><div class="user-card-avatar" style="border-radius:8px"><img src="${p.images?.[0]||'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=100'}" style="width:100%;height:100%;object-fit:cover;border-radius:8px"></div><div class="user-card-info"><h4>${isFeat?'<i class="fas fa-star" style="color:#f1c40f"></i> ':''} ${p.title}</h4><p>${formatPrice(p.price,p.currency||'USD')} - ${getLocationString(p)}</p><small>${o.name} | <i class="fas fa-eye"></i> ${p.views||0} | ${stt}</small></div><div class="user-card-actions"><button class="btn-feature-admin ${isFeat?'active':''}" onclick="toggleFeatured('${p.id}')" title="${isFeat?'Quitar destacado':'Destacar'}"><i class="fas fa-star"></i></button><button class="btn-edit" onclick="openPropertyModal('${p.id}')"><i class="fas fa-edit"></i></button><button class="btn-reject" onclick="deleteProperty('${p.id}')"><i class="fas fa-trash"></i></button></div></div>`}).join('')}}
    async function approveUser(id){await db.collection('users').doc(id).update({status:'approved'});allUsers[id]={...allUsers[id],status:'approved'};showAdminTab('pending');showToast('Usuario aprobado','El usuario ya puede acceder','fa-user-check')}
    async function rejectUser(id){await db.collection('users').doc(id).update({status:'rejected'});showAdminTab('pending')}
    async function deleteUser(id){if(!confirm('¿Eliminar?'))return;await db.collection('users').doc(id).delete();delete allUsers[id];showAdminTab('users')}
    async function deleteProperty(id){if(!confirm('¿Eliminar esta propiedad?'))return;await db.collection('properties').doc(id).delete()}
    async function toggleFeatured(id){try{const p=properties.find(pr=>pr.id===id);if(!p)return;const newVal=!p.featured;await db.collection('properties').doc(id).update({featured:newVal});showToast(newVal?'Propiedad destacada':'Destacado removido',newVal?'La propiedad aparecerá primero':'La propiedad volvió al orden normal','fa-star')}catch(err){console.error('Error toggling featured:',err);alert('Error al cambiar destacado')}}
    // Funciones de compartir
    let currentShareProperty=null;
    function openShareModal(id){const p=properties.find(pr=>pr.id===id);if(!p)return;currentShareProperty=p;const url=`${window.location.origin}${window.location.pathname}#propiedad/${id}`;document.getElementById('shareTitle').textContent=p.title;document.getElementById('sharePrice').textContent=formatPrice(p.price,p.currency||'USD')+(p.type==='rent'?'/mes':'');document.getElementById('shareLocation').textContent=getLocationString(p);document.getElementById('shareUrlInput').value=url;openModal('shareModal')}
    function getShareText(){if(!currentShareProperty)return'';const p=currentShareProperty;return`${p.type==='sale'?'🏠 EN VENTA':'🔑 EN ALQUILER'}: ${p.title}\n💰 ${formatPrice(p.price,p.currency||'USD')}${p.type==='rent'?'/mes':''}\n📍 ${getLocationString(p)}\n${p.bedrooms?`🛏 ${p.bedrooms} dormitorios `:''} ${p.bathrooms?`🚿 ${p.bathrooms} baños`:''}\n`}
    function shareToWhatsApp(){const url=document.getElementById('shareUrlInput').value;const text=encodeURIComponent(getShareText()+'\n'+url);window.open(`https://wa.me/?text=${text}`,'_blank')}
    function shareToFacebook(){const url=encodeURIComponent(document.getElementById('shareUrlInput').value);window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`,'_blank')}
    function shareToTwitter(){const url=document.getElementById('shareUrlInput').value;const text=encodeURIComponent(getShareText());window.open(`https://twitter.com/intent/tweet?text=${text}&url=${encodeURIComponent(url)}`,'_blank')}
    function copyShareLink(){const input=document.getElementById('shareUrlInput');input.select();input.setSelectionRange(0,99999);navigator.clipboard.writeText(input.value).then(()=>{showToast('Enlace copiado','El link está listo para compartir','fa-link')}).catch(()=>{document.execCommand('copy');showToast('Enlace copiado','El link está listo para compartir','fa-link')})}
    // Limpiar notificaciones
    async function clearAllNotifications(e){e.stopPropagation();if(!currentUser)return;if(!confirm('¿Eliminar todas las consultas?'))return;try{const snap=await db.collection('notifications').where('ownerId','==',currentUser.uid).get();if(snap.empty){showToast('Sin consultas','No hay consultas para eliminar','fa-info-circle');return}const batch=db.batch();snap.docs.forEach(doc=>batch.delete(doc.ref));await batch.commit();notifications=[];renderNotifications();showToast('Bandeja limpia','Todas las consultas fueron eliminadas','fa-trash')}catch(err){console.error('Error clearing notifications:',err);showToast('Error','No se pudieron eliminar: '+err.message,'fa-exclamation-circle')}}
    
    // Image Handling
    const uploadArea=document.getElementById('imageUploadArea');uploadArea.addEventListener('dragover',e=>{e.preventDefault();uploadArea.classList.add('dragover')});uploadArea.addEventListener('dragleave',()=>{uploadArea.classList.remove('dragover')});uploadArea.addEventListener('drop',e=>{e.preventDefault();uploadArea.classList.remove('dragover');addImagesToPreview(Array.from(e.dataTransfer.files).filter(f=>f.type.startsWith('image/')))});
    function handleImageSelect(e){addImagesToPreview(Array.from(e.target.files));e.target.value=''}
    async function addImagesToPreview(fs){for(const f of fs){if(f.size>5*1024*1024){alert(`La imagen ${f.name} excede 5MB`);continue}const pr=await compressImageForPreview(f);selectedImages.push({preview:pr,file:f,existing:false});renderImagePreviews()}}
    function renderImagePreviews(){document.getElementById('imagePreviewGrid').innerHTML=selectedImages.map((im,i)=>`<div class="image-preview-item ${i===0?'main':''}" draggable="true" ondragstart="handleDragStart(event,${i})" ondragover="handleDragOver(event)" ondragenter="handleDragEnter(event)" ondragleave="handleDragLeave(event)" ondrop="handleDropImage(event,${i})" ondragend="handleDragEnd(event)"><img src="${im.preview}" alt=""><div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><div class="remove-image" onclick="event.stopPropagation();removeImage(${i})"><i class="fas fa-times"></i></div></div>`).join('')}
    function handleDragStart(e,i){draggedImageIndex=i;e.target.classList.add('dragging')}
    function handleDragOver(e){e.preventDefault()}
    function handleDragEnter(e){e.preventDefault();if(e.target.closest('.image-preview-item'))e.target.closest('.image-preview-item').classList.add('drag-over')}
    function handleDragLeave(e){if(e.target.closest('.image-preview-item'))e.target.closest('.image-preview-item').classList.remove('drag-over')}
    function handleDropImage(e,ti){e.preventDefault();const it=e.target.closest('.image-preview-item');if(it)it.classList.remove('drag-over');if(draggedImageIndex!==null&&draggedImageIndex!==ti){const di=selectedImages[draggedImageIndex];selectedImages.splice(draggedImageIndex,1);selectedImages.splice(ti,0,di);renderImagePreviews()}}
    function handleDragEnd(e){e.target.classList.remove('dragging');draggedImageIndex=null;document.querySelectorAll('.image-preview-item').forEach(it=>it.classList.remove('drag-over'))}
    function removeImage(i){selectedImages.splice(i,1);renderImagePreviews()}
    function resetPropertyForm(){document.getElementById('propertyForm').reset();document.getElementById('editingPropertyId').value='';document.getElementById('previousPrice').value='';document.getElementById('propertyModalTitle').textContent='Nueva Propiedad';document.getElementById('propertyBtn').innerHTML='<i class="fas fa-check"></i> Publicar Propiedad';selectedImages=[];renderImagePreviews();togglePropertyType();selectStatus('available');document.getElementById('propCiudad').innerHTML='<option value="">Primero selecciona departamento</option>';document.getElementById('uploadProgress').classList.add('hidden')}
    function updateUploadProgress(c,t){const p=document.getElementById('uploadProgress'),f=document.getElementById('uploadProgressFill'),tx=document.getElementById('uploadProgressText');p.classList.remove('hidden');const pc=Math.round((c/t)*100);f.style.width=`${pc}%`;tx.textContent=`Subiendo imagen ${c} de ${t}...`}
    
    async function handleSaveProperty(e){e.preventDefault();if(!currentUser){alert('Debes iniciar sesión');return}if(selectedImages.length===0){alert('Sube al menos una imagen');return}const b=document.getElementById('propertyBtn'),er=document.getElementById('propertyError'),ei=document.getElementById('editingPropertyId').value,pp=document.getElementById('previousPrice').value;b.disabled=true;b.innerHTML='<i class="fas fa-spinner fa-spin"></i> Guardando...';er.classList.add('hidden');try{const pi=ei||db.collection('properties').doc().id,iu=[];const itu=selectedImages.filter(im=>!im.existing);let uc=0;const tt=itu.length;for(let i=0;i<selectedImages.length;i++){const im=selectedImages[i];if(im.existing){iu.push(im.url)}else{uc++;updateUploadProgress(uc,tt);const url=await uploadImageToStorage(im.file,pi,i);iu.push(url)}}const ty=document.getElementById('propType').value,dp=document.getElementById('propDepartamento').value,cd=document.getElementById('propCiudad').value,np=parseInt(document.getElementById('propPrice').value);const pd={title:document.getElementById('propTitle').value,departamento:dp,ciudad:cd,direccion:document.getElementById('propDireccion').value,location:`${cd}, ${dp}`,price:np,currency:document.getElementById('propCurrency').value,type:ty,propertyType:ty==='sale'?document.getElementById('propPropertyType').value:'common',bedrooms:parseInt(document.getElementById('propBedrooms').value)||0,bathrooms:parseInt(document.getElementById('propBathrooms').value)||0,totalArea:parseInt(document.getElementById('propTotalArea').value)||0,builtArea:parseInt(document.getElementById('propBuiltArea').value)||0,commonExpenses:parseInt(document.getElementById('propExpenses').value)||0,garage:document.getElementById('propGarage').value,status:document.getElementById('propStatus').value,images:iu,description:document.getElementById('propDescription').value,ownerWhatsapp:document.getElementById('propWhatsapp').value||userProfile.whatsapp,updatedAt:new Date().toISOString()};if(ei&&pp&&parseInt(pp)!==np){pd.previousPrice=parseInt(pp);pd.priceChangedAt=new Date().toISOString()}if(ei){await db.collection('properties').doc(ei).update(pd);showToast('Propiedad actualizada','Los cambios han sido guardados','fa-check')}else{pd.ownerId=currentUser.uid;pd.ownerName=userProfile.name;pd.views=0;pd.createdAt=new Date().toISOString();await db.collection('properties').doc(pi).set(pd);showToast('Propiedad publicada','Tu propiedad ya está visible','fa-home')}closeModal('propertyModal');resetPropertyForm()}catch(err){console.error('Error saving property:',err);er.textContent='Error: '+err.message;er.classList.remove('hidden')}finally{b.disabled=false;b.innerHTML=ei?'<i class="fas fa-save"></i> Guardar Cambios':'<i class="fas fa-check"></i> Publicar Propiedad'}}
    
    // Initialize
    initDepartamentos();
    loadProperties();
    handleHash();
  </script>
</body>
</html>
